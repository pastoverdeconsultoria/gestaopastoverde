<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,user-scalable=yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Pasto Verde Pro - Gest√£o de Pastagem</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <style>
    body { margin: 0; padding: 0; font-family: system-ui, -apple-system, sans-serif; }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
const { useState, useEffect, useMemo, useRef } = React;

const I = ({ size = 20, children }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">{children}</svg>;
const Upload = p => <I {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12" /></I>;
const Plus = p => <I {...p}><line x1="12" y1="5" x2="12" y2="19" /><line x1="5" y1="12" x2="19" y2="12" /></I>;
const Trash2 = p => <I {...p}><polyline points="3 6 5 6 21 6" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" /></I>;
const X = p => <I {...p}><line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" /></I>;
const MapPin = p => <I {...p}><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" /><circle cx="12" cy="10" r="3" /></I>;
const ZoomIn = p => <I {...p}><circle cx="11" cy="11" r="8" /><line x1="21" y1="21" x2="16.65" y2="16.65" /><line x1="11" y1="8" x2="11" y2="14" /><line x1="8" y1="11" x2="14" y2="11" /></I>;
const ZoomOut = p => <I {...p}><circle cx="11" cy="11" r="8" /><line x1="21" y1="21" x2="16.65" y2="16.65" /><line x1="8" y1="11" x2="14" y2="11" /></I>;
const RotateCcw = p => <I {...p}><polyline points="1 4 1 10 7 10" /><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10" /></I>;
const Download = p => <I {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3" /></I>;
const Edit2 = p => <I {...p}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z" /></I>;
const Navigation = p => <I {...p}><polygon points="3 11 22 2 13 21 11 13 3 11" /></I>;
const Compass = p => <I {...p}><circle cx="12" cy="12" r="10" /><polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76" /></I>;
const Maximize = p => <I {...p}><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3" /></I>;
const BarChart = p => <I {...p}><line x1="12" y1="20" x2="12" y2="10" /><line x1="18" y1="20" x2="18" y2="4" /><line x1="6" y1="20" x2="6" y2="16" /></I>;
const ArrowRightLeft = p => <I {...p}><path d="M8 3L4 7l4 4" /><path d="M4 7h16" /><path d="m16 21 4-4-4-4" /><path d="M20 17H4" /></I>;
const DollarSign = p => <I {...p}><line x1="12" y1="1" x2="12" y2="23" /><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" /></I>;
const ChevronDown = p => <I {...p}><polyline points="6 9 12 15 18 9" /></I>;
const ChevronUp = p => <I {...p}><polyline points="18 15 12 9 6 15" /></I>;

// --- FUN√á√ïES E C√ÅLCULOS ORIGINAIS ---
const gid = () => `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
const calcArea = c => {
  if (!c || c.length < 3) return 0;
  let a = 0;
  const n = c.length, lm = c.reduce((s, v) => s + v[1], 0) / n, fl = Math.cos(lm * Math.PI / 180);
  for (let i = 0; i < n; i++) {
    const j = (i + 1) % n, xi = c[i][0] * fl * 111320, yi = c[i][1] * 110540, xj = c[j][0] * fl * 111320, yj = c[j][1] * 110540;
    a += xi * yj - xj * yi;
  }
  return (Math.abs(a) / 2 / 10000).toFixed(2);
};
const calcUA = (p, q) => !p || !q ? 0 : ((p * q) / 450).toFixed(2);
const isReserva = nome => {
  const n = nome.toLowerCase();
  return n.includes('reserva') || n.includes('preserva') || n.includes('app') || n.includes('rl ') || n.includes('mata') || n.includes('floresta');
};

function App() {
  const [data, setData] = useState({ faz: [], fa: null, mod: [], piq: [], lot: [], his: [], mb: null });
  const [ui, setUi] = useState({ tab: 'dashboard', modal: null, sel: null, st: '', zm: 1, pn: { x: 0, y: 0 }, fd: {}, exp: {} });
  const [gps, setGps] = useState({ pos: null, status: 'buscando' });
  const [touch, setTouch] = useState({ active: false, start: null, last: null, dist: 0 });

  useEffect(() => {
    const s = localStorage.getItem('pastureSystem');
    if (s) { try { setData(JSON.parse(s)); } catch (e) { } }
  }, []);

  useEffect(() => {
    localStorage.setItem('pastureSystem', JSON.stringify(data));
  }, [data]);

  useEffect(() => {
    if (!navigator.geolocation) return;
    const id = navigator.geolocation.watchPosition(
      p => setGps({ pos: { lat: p.coords.latitude, lng: p.coords.longitude, acc: p.coords.accuracy }, status: 'ativo' }),
      e => setGps(g => ({ ...g, status: 'erro' })),
      { enableHighAccuracy: true }
    );
    return () => navigator.geolocation.clearWatch(id);
  }, []);

  // --- HANDLERS E LOGICA DE MAPA (RESTAURADOS) ---
  const handleKML = e => {
    const f = e.target.files[0];
    if (!f || !data.fa) return;
    const r = new FileReader();
    r.onload = ev => {
      const p = new DOMParser(), x = p.parseFromString(ev.target.result, 'text/xml');
      const pl = Array.from(x.getElementsByTagName('Placemark'));
      let minLat = 180, maxLat = -180, minLng = 180, maxLng = -180;
      const np = pl.map(pm => {
        const coStr = pm.getElementsByTagName('coordinates')[0]?.textContent.trim();
        if(!coStr) return null;
        const coords = coStr.split(/\s+/).map(pr => {
          const [lng, lat] = pr.split(',').map(parseFloat);
          minLng = Math.min(minLng, lng); maxLng = Math.max(maxLng, lng);
          minLat = Math.min(minLat, lat); maxLat = Math.max(maxLat, lat);
          return [lng, lat];
        });
        return { id: gid(), fazendaId: data.fa, nome: pm.getElementsByTagName('name')[0]?.textContent || '√Årea', area: calcArea(coords), coordinates: coords, ehReserva: isReserva(pm.getElementsByTagName('name')[0]?.textContent || '') };
      }).filter(p => p);
      setData({ ...data, piq: [...data.piq, ...np], mb: { minLat, maxLat, minLng, maxLng, width: maxLng-minLng, height: maxLat-minLat } });
    };
    r.readAsText(f);
  };

  const proj = (lng, lat) => {
    if (!data.mb) return [0, 0];
    return [((lng - data.mb.minLng) / data.mb.width) * 900 + 50, ((data.mb.maxLat - lat) / data.mb.height) * 700 + 50];
  };

  const fazAt = data.faz.find(f => f.id === data.fa);

  return (
    <div className="min-h-screen bg-gray-50 flex flex-col">
      {/* HEADER ORIGINAL COM NOME NOVO */}
      <div className="bg-gradient-to-r from-green-600 to-blue-600 text-white p-4 shadow-lg">
        <div className="max-w-7xl mx-auto flex justify-between items-center">
          <h1 className="text-2xl font-bold">üìä Pasto Verde Pro</h1>
          {fazAt && <div className="text-sm bg-white/20 px-2 py-1 rounded">üìç {fazAt.nome}</div>}
        </div>
      </div>

      {/* ABAS ORIGINAIS (RESTABELECIDAS) */}
      <div className="bg-white border-b sticky top-0 z-10">
        <div className="max-w-7xl mx-auto flex gap-1 overflow-x-auto no-scrollbar">
          {['dashboard', 'mapa', 'piquetes', 'modulos', 'lotes', 'historico', 'config'].map(t => (
            <button key={t} onClick={() => setUi({ ...ui, tab: t })} className={`px-4 py-3 font-bold uppercase text-xs tracking-widest whitespace-nowrap ${ui.tab === t ? 'border-b-4 border-green-600 text-green-700' : 'text-gray-400'}`}>
              {t}
            </button>
          ))}
        </div>
      </div>

      <main className="flex-1 p-4 max-w-7xl mx-auto w-full">
        {!data.fa && ui.tab !== 'config' ? (
          <div className="text-center p-10 bg-white rounded-xl shadow">
            <h2 className="text-xl font-bold mb-4">Bem-vindo ao Pasto Verde Pro</h2>
            <p className="mb-6 text-gray-500">Para come√ßar, configure uma fazenda na aba Configura√ß√µes.</p>
          </div>
        ) : (
          <>
            {ui.tab === 'dashboard' && (
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div className="bg-white p-6 rounded-xl shadow border-l-4 border-green-500">
                  <h3 className="text-gray-400 text-xs font-bold uppercase">√Årea Total</h3>
                  <p className="text-2xl font-black">{data.piq.filter(p => p.fazendaId === data.fa).reduce((s,p) => s + parseFloat(p.area), 0).toFixed(2)} ha</p>
                </div>
              </div>
            )}

            {ui.tab === 'mapa' && (
              <div className="bg-white rounded-xl shadow p-2 relative">
                <div className="flex gap-2 mb-2">
                   <label className="bg-green-600 text-white px-3 py-1 rounded text-xs cursor-pointer">
                     üìÅ KML <input type="file" onChange={handleKML} className="hidden" />
                   </label>
                   <button onClick={() => setUi({...ui, zm: ui.zm + 0.2})} className="bg-gray-100 p-1 rounded"><ZoomIn/></button>
                   <button onClick={() => setUi({...ui, zm: Math.max(0.2, ui.zm - 0.2)})} className="bg-gray-100 p-1 rounded"><ZoomOut/></button>
                </div>
                <div className="overflow-hidden border rounded h-[500px] relative">
                  <svg viewBox="0 0 1000 800" className="w-full h-full bg-slate-50">
                    <g transform={`translate(${ui.pn.x},${ui.pn.y}) scale(${ui.zm})`}>
                      {data.piq.filter(p => p.fazendaId === data.fa).map(p => (
                        <path key={p.id} d={p.coordinates.map((c, i) => `${i===0?'M':'L'} ${proj(c[0], c[1]).join(' ')}`).join(' ') + ' Z'} 
                              fill={p.ehReserva ? '#dcfce7' : '#f1f5f9'} stroke="#475569" strokeWidth="1" />
                      ))}
                      {gps.pos && <circle cx={proj(gps.pos.lng, gps.pos.lat)[0]} cy={proj(gps.pos.lng, gps.pos.lat)[1]} r="10" fill="#3b82f6" stroke="white" strokeWidth="2" />}
                    </g>
                  </svg>
                </div>
              </div>
            )}

            {ui.tab === 'piquetes' && (
              <div className="bg-white rounded-xl shadow overflow-hidden">
                <table className="w-full text-left text-sm">
                  <thead className="bg-gray-50 uppercase text-[10px] font-bold">
                    <tr><th className="p-4">Nome</th><th className="p-4">√Årea</th><th className="p-4">Tipo</th></tr>
                  </thead>
                  <tbody className="divide-y">
                    {data.piq.filter(p => p.fazendaId === data.fa).map(p => (
                      <tr key={p.id}><td className="p-4 font-bold">{p.nome}</td><td className="p-4">{p.area} ha</td><td className="p-4">{p.ehReserva ? 'Reserva' : 'Pasto'}</td></tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )}

            {ui.tab === 'modulos' && (
              <div className="p-4 bg-white rounded-xl shadow">
                <h3 className="font-bold mb-4">Gest√£o de M√≥dulos</h3>
                <p className="text-gray-400 text-sm">Nenhum m√≥dulo cadastrado nesta fazenda.</p>
              </div>
            )}

            {ui.tab === 'lotes' && (
              <div className="p-4 bg-white rounded-xl shadow">
                <h3 className="font-bold mb-4">Lotes de Animais</h3>
                <p className="text-gray-400 text-sm">Nenhum lote ativo.</p>
              </div>
            )}

            {ui.tab === 'historico' && (
              <div className="p-4 bg-white rounded-xl shadow text-sm">
                <h3 className="font-bold mb-2 uppercase">Hist√≥rico de Movimenta√ß√µes</h3>
                <p className="text-gray-400 italic">Sem registros recentes.</p>
              </div>
            )}

            {ui.tab === 'config' && (
              <div className="space-y-6">
                <div className="bg-white p-6 rounded-xl shadow">
                  <h3 className="font-bold mb-4">Fazendas</h3>
                  <button onClick={() => {
                    const n = prompt("Nome da Fazenda:");
                    if(n) { const id = gid(); setData({...data, faz:[...data.faz, {id, nome:n}], fa:id}); }
                  }} className="bg-green-600 text-white px-4 py-2 rounded font-bold text-sm">+ Nova Fazenda</button>
                  <div className="mt-4 space-y-2">
                    {data.faz.map(f => (
                      <div key={f.id} onClick={() => setData({...data, fa:f.id})} className={`p-3 border rounded cursor-pointer ${data.fa === f.id ? 'border-green-600 bg-green-50 font-bold' : ''}`}>
                        {f.nome}
                      </div>
                    ))}
                  </div>
                </div>
                <div className="bg-red-50 p-6 rounded-xl border border-red-100">
                  <button onClick={() => { if(confirm("Apagar todos os dados?")) { localStorage.clear(); location.reload(); }}} className="text-red-600 font-bold text-sm uppercase">Resetar Sistema</button>
                </div>
              </div>
            )}
          </>
        )}
      </main>
    </div>
  );
}

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);
  </script>
</body>
</html>
