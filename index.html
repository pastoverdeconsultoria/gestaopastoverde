<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,user-scalable=yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>Manager Pro</title>
<script src="https://cdn.tailwindcss.com"></script>
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<style>
body{margin:0;padding:0;font-family:system-ui,-apple-system,sans-serif;touch-action:pan-y;overflow-x:hidden}
.gps-pulse{animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:0.5;transform:scale(1.1)}}
.map-container{touch-action:none;user-select:none;cursor:grab}
.map-container:active{cursor:grabbing}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const {useState,useEffect,useMemo,useCallback,useRef}=React;
const gid=()=>`${Date.now()}-${Math.random().toString(36).substr(2,9)}`;
const calcArea=c=>{if(!c||c.length<3)return 0;let a=0;const n=c.length,lm=c.reduce((s,v)=>s+v[1],0)/n,fl=Math.cos(lm*Math.PI/180);for(let i=0;i<n;i++){const j=(i+1)%n,xi=c[i][0]*fl*111320,yi=c[i][1]*110540,xj=c[j][0]*fl*111320,yj=c[j][1]*110540;a+=xi*yj-xj*yi}return(Math.abs(a)/2/10000).toFixed(2)};
const calcUA=(p,q)=>!p||!q?0:((p*q)/450).toFixed(2);
const isReserva=n=>{const nl=n.toLowerCase();return nl.includes('reserva')||nl.includes('preserva')||nl.includes('app')||nl.includes('rl ')||nl.includes('mata')||nl.includes('floresta')};
const loteCores=['#fbbf24','#3b82f6','#10b981','#f97316','#8b5cf6','#ec4899','#ef4444','#06b6d4','#84cc16','#a855f7'];
const moduloCores=['rgba(16,185,129,0.15)','rgba(139,92,246,0.15)','rgba(249,115,22,0.15)','rgba(59,130,246,0.15)','rgba(236,72,153,0.15)'];
const moduloCoresFortes=['rgba(16,185,129,0.5)','rgba(139,92,246,0.5)','rgba(249,115,22,0.5)','rgba(59,130,246,0.5)','rgba(236,72,153,0.5)'];
const getLoteCor=idx=>loteCores[idx%loteCores.length];
const getModuloCor=idx=>moduloCores[idx%moduloCores.length];
const getModuloCorForte=idx=>moduloCoresFortes[idx%moduloCoresFortes.length];
const pointInPolygon=(p,vs)=>{let inside=false;for(let i=0,j=vs.length-1;i<vs.length;j=i++){const xi=vs[i][0],yi=vs[i][1],xj=vs[j][0],yj=vs[j][1];if((yi>p[1])!=(yj>p[1])&&(p[0]<(xj-xi)*(p[1]-yi)/(yj-yi)+xi))inside=!inside}return inside};

function App(){
const[faz,setFaz]=useState([]);
const[fa,setFa]=useState(null);
const[mod,setMod]=useState([]);
const[piq,setPiq]=useState([]);
const[lot,setLot]=useState([]);
const[his,setHis]=useState([]);
const[tab,setTab]=useState('mapa');
const[modal,setModal]=useState(null);
const[sel,setSel]=useState(null);
const[mb,setMb]=useState(null);
const[st,setSt]=useState('');
const[sch,setSch]=useState('');
const[ed,setEd]=useState(null);
const[zm,setZm]=useState(1);
const[pn,setPn]=useState({x:0,y:0});
const[fd,setFd]=useState({});
const[fe,setFe]=useState([]);
const[gps,setGps]=useState(null);
const[gpsStatus,setGpsStatus]=useState('buscando');
const svgRef=useRef(null);
const[dragging,setDragging]=useState(false);
const[dragStart,setDragStart]=useState({x:0,y:0});
const dragPan=useRef({x:0,y:0});

useEffect(()=>{const s=localStorage.getItem('pastureSystem');if(s){try{const d=JSON.parse(s);setFaz(d.fazendas||[]);setMod(d.modulos||[]);setPiq(d.piquetes||[]);setLot(d.lotes||[]);setFa(d.fazendaAtual||null);setHis(d.historico||[]);if(d.mapBounds)setMb(d.mapBounds)}catch(e){}}},[]);
useEffect(()=>{localStorage.setItem('pastureSystem',JSON.stringify({version:'2.5',fazendas:faz,modulos:mod,piquetes:piq,lotes:lot,fazendaAtual:fa,historico:his,mapBounds:mb}))},[faz,mod,piq,lot,fa,his,mb]);

useEffect(()=>{if(!navigator.geolocation){setGpsStatus('indisponivel');return}const id=navigator.geolocation.watchPosition(pos=>{setGps({lat:pos.coords.latitude,lng:pos.coords.longitude,acc:pos.coords.accuracy});setGpsStatus('ativo')},err=>{setGpsStatus('erro')},{enableHighAccuracy:true,timeout:30000,maximumAge:0});return()=>{if(id)navigator.geolocation.clearWatch(id)}},[]);

const exp=()=>{const d={fazendas:faz,modulos:mod,piquetes:piq,lotes:lot,historico:his,version:'2.5',dataExportacao:new Date().toISOString()};const b=new Blob([JSON.stringify(d,null,2)],{type:'application/json'});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download=`backup-${Date.now()}.json`;a.click();URL.revokeObjectURL(u);setSt('âœ… Backup!');setTimeout(()=>setSt(''),3000)};

const imp=e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=ev=>{try{const d=JSON.parse(ev.target.result);if(confirm('Importar?')){setFaz(d.fazendas||[]);setMod(d.modulos||[]);setPiq(d.piquetes||[]);setLot(d.lotes||[]);setHis(d.historico||[]);setFa(null);setSt('âœ… Importado!')}}catch(er){setSt('âŒ Erro')}};r.readAsText(f);e.target.value=''};

const parseKML=t=>{const p=new DOMParser(),x=p.parseFromString(t,'text/xml');if(x.querySelector('parsererror'))throw new Error('KML invÃ¡lido');const pl=x.getElementsByTagName('Placemark');if(pl.length===0)throw new Error('Sem Ã¡reas');const np=[];let minLat=Infinity,maxLat=-Infinity,minLng=Infinity,maxLng=-Infinity,aT=0,aR=0;for(let i=0;i<pl.length;i++){const pm=pl[i],ne=pm.getElementsByTagName('name')[0],nm=ne?ne.textContent.trim():`Ãrea ${i+1}`,ce=pm.getElementsByTagName('coordinates')[0];let co=[],ar=0;const reserva=isReserva(nm);if(ce){const ct=ce.textContent.trim(),cp=ct.split(/\s+/);co=cp.map(pr=>{const[lng,lat]=pr.split(',').map(parseFloat);if(!isNaN(lng)&&!isNaN(lat)){minLng=Math.min(minLng,lng);maxLng=Math.max(maxLng,lng);minLat=Math.min(minLat,lat);maxLat=Math.max(maxLat,lat);return[lng,lat]}return null}).filter(c=>c);if(co.length>2){ar=parseFloat(calcArea(co));aT+=ar;if(reserva)aR+=ar}}np.push({id:gid(),fazendaId:fa,moduloId:null,nome:nm,area:ar,coordinates:co,loteAtualId:null,ehReserva:reserva,dataCriacao:new Date().toISOString()})}setMb({minLat,maxLat,minLng,maxLng,centerLat:(minLat+maxLat)/2,centerLng:(minLng+maxLng)/2,width:maxLng-minLng,height:maxLat-minLat});if(fa)setFaz(faz.map(f=>f.id===fa?{...f,areaTotal:aT.toFixed(2),areaPreservacao:aR.toFixed(2),areaUtil:(aT-aR).toFixed(2)}:f));return{piquetes:np,stats:{total:aT.toFixed(2),reserva:aR.toFixed(2)}}};

const hKML=e=>{const f=e.target.files[0];if(!f||!fa)return;const r=new FileReader();r.onload=ev=>{try{const res=parseKML(ev.target.result);if(piq.filter(p=>p.fazendaId===fa).length>0&&!confirm('Substituir Ã¡reas existentes?'))return;setPiq(piq.filter(p=>p.fazendaId!==fa).concat(res.piquetes));setSt(`âœ… ${res.piquetes.length} Ã¡reas!`);setTimeout(()=>setSt(''),3000)}catch(er){setSt(`âŒ ${er.message}`)}};r.readAsText(f);e.target.value=''};

const projC=(lng,lat,b,w,h)=>{if(!b)return[0,0];const p=50;return[((lng-b.minLng)/b.width)*(w-p*2)+p,((b.maxLat-lat)/b.height)*(h-p*2)+p]};
const getPath=(c,b,w,h)=>{if(!c||c.length===0)return'';return c.map((co,i)=>{const[x,y]=projC(co[0],co[1],b,w,h);return`${i===0?'M':'L'} ${x} ${y}`}).join(' ')+' Z'};
const getCent=c=>{if(!c||c.length===0)return[0,0];let sLng=0,sLat=0;c.forEach(co=>{sLng+=co[0];sLat+=co[1]});return[sLng/c.length,sLat/c.length]};

const handleMouseDown=e=>{if(e.button!==0)return;setDragging(true);setDragStart({x:e.clientX,y:e.clientY});dragPan.current={x:pn.x,y:pn.y}};
const handleMouseMove=e=>{if(!dragging)return;setPn({x:dragPan.current.x+(e.clientX-dragStart.x),y:dragPan.current.y+(e.clientY-dragStart.y)})};
const handleMouseUp=()=>setDragging(false);
const handleWheel=e=>{e.preventDefault();setZm(z=>Math.max(0.5,Math.min(5,z+(e.deltaY>0?-0.1:0.1))))};

useEffect(()=>{if(dragging){document.addEventListener('mousemove',handleMouseMove);document.addEventListener('mouseup',handleMouseUp);return()=>{document.removeEventListener('mousemove',handleMouseMove);document.removeEventListener('mouseup',handleMouseUp)}}},[dragging]);

const handleTouchStart=e=>{if(e.touches.length===1){setDragging(true);setDragStart({x:e.touches[0].clientX,y:e.touches[0].clientY});dragPan.current={x:pn.x,y:pn.y}}};
const handleTouchMove=e=>{if(e.touches.length===1&&dragging){e.preventDefault();setPn({x:dragPan.current.x+(e.touches[0].clientX-dragStart.x),y:dragPan.current.y+(e.touches[0].clientY-dragStart.y)})}};
const handleTouchEnd=()=>setDragging(false);

const getPiqGPS=useMemo(()=>{if(!gps)return null;return piq.find(x=>x.fazendaId===fa&&x.coordinates&&x.coordinates.length>0&&pointInPolygon([gps.lng,gps.lat],x.coordinates))||null},[gps,piq,fa]);

const fazAt=faz.find(f=>f.id===fa);
const piqF=piq.filter(p=>p.fazendaId===fa);
const modF=mod.filter(m=>m.fazendaId===fa);
const lotF=lot.filter(l=>l.fazendaId===fa);

return <div className="min-h-screen bg-gray-50">
<div className="bg-gradient-to-r from-green-600 to-blue-600 text-white p-4 shadow-lg">
<div className="max-w-7xl mx-auto">
<div className="flex items-center justify-between mb-2">
<h1 className="text-2xl font-bold">ğŸ“Š Manager Pro v2.5</h1>
<div className="flex gap-2">
<button onClick={exp} className="bg-white/20 hover:bg-white/30 px-3 py-2 rounded text-sm">ğŸ’¾ Backup</button>
<label className="bg-white/20 hover:bg-white/30 px-3 py-2 rounded text-sm cursor-pointer">ğŸ“¤ Restaurar<input type="file" accept=".json" onChange={imp} className="hidden"/></label>
</div>
</div>
{fazAt&&<div className="text-sm flex items-center gap-2">
<span>ğŸ“ {fazAt.nome}</span>
{gpsStatus==='ativo'&&getPiqGPS&&<span className="bg-green-100 text-green-800 px-2 py-1 rounded text-xs">âœ… GPS | ğŸ“ {getPiqGPS.nome}</span>}
{gpsStatus==='ativo'&&!getPiqGPS&&<span className="bg-green-100 text-green-800 px-2 py-1 rounded text-xs">âœ… GPS</span>}
</div>}
</div>
</div>

{st&&<div className="max-w-7xl mx-auto px-4 pt-2"><div className={`p-2 rounded text-sm ${st.includes('âœ…')?'bg-green-100 text-green-800':'bg-red-100 text-red-800'}`}>{st}</div></div>}

{fa&&<div className="bg-white border-b sticky top-0 z-10">
<div className="max-w-7xl mx-auto flex gap-1 overflow-x-auto">
{['mapa','areas','modulos','grupos','historico'].map(t=><button key={t} onClick={()=>setTab(t==='areas'?'piquetes':t==='grupos'?'lotes':t)} className={`px-4 py-2 font-semibold capitalize whitespace-nowrap ${(tab==='piquetes'&&t==='areas')||(tab==='lotes'&&t==='grupos')||tab===t?'border-b-2 border-green-600 text-green-600':'text-gray-600'}`}>{t}</button>)}
</div>
</div>}

<div className="max-w-7xl mx-auto p-4">
{!fa&&<div className="bg-white rounded-lg shadow p-6">
<div className="flex justify-between items-center mb-4">
<h2 className="text-xl font-bold">Locais</h2>
<button onClick={()=>setModal('fazenda')} className="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">+ Novo</button>
</div>
{faz.map(f=><div key={f.id} className="border-2 rounded-lg p-4 mb-3">
<h3 className="text-lg font-bold cursor-pointer hover:text-green-600" onClick={()=>{setFa(f.id);setTab('mapa')}}>{f.nome}</h3>
{f.areaTotal>0&&<div className="text-sm text-gray-600 mt-2">
<div>ğŸ“Š Total: {f.areaTotal}ha | ğŸŒ¾ Ãštil: {f.areaUtil}ha</div>
<div>ğŸŒ³ PreservaÃ§Ã£o: {f.areaPreservacao}ha</div>
</div>}
</div>)}
</div>}

{fa&&tab==='mapa'&&<div className="bg-white rounded-lg shadow p-4">
<div className="flex justify-between items-center mb-3">
<h2 className="text-xl font-bold">Mapa</h2>
<label className="bg-blue-600 text-white px-3 py-2 rounded hover:bg-blue-700 cursor-pointer text-sm">ğŸ“¥ Importar KML<input type="file" accept=".kml,.xml" onChange={hKML} className="hidden"/></label>
</div>
{piqF.length===0?<div className="text-center py-12 text-gray-500">Importe um arquivo KML</div>:
<><div className="flex gap-2 mb-2">
<button onClick={()=>setZm(Math.min(zm+0.2,5))} className="bg-gray-200 p-2 rounded">ğŸ”+</button>
<button onClick={()=>setZm(Math.max(zm-0.2,0.5))} className="bg-gray-200 p-2 rounded">ğŸ”-</button>
<button onClick={()=>{setZm(1);setPn({x:0,y:0})}} className="bg-gray-200 p-2 rounded">â†º</button>
</div>
<div className="border-2 rounded bg-gray-50 overflow-hidden select-none map-container" ref={svgRef} onMouseDown={handleMouseDown} onWheel={handleWheel} onTouchStart={handleTouchStart} onTouchMove={handleTouchMove} onTouchEnd={handleTouchEnd}>
<svg viewBox="0 0 1000 800" className="w-full h-auto" style={{minHeight:'400px'}}>
<g transform={`translate(${pn.x},${pn.y}) scale(${zm})`}>
{piqF.filter(p=>p.coordinates&&p.coordinates.length>0).map(p=>{const path=getPath(p.coordinates,mb,1000,800),[cx,cy]=projC(getCent(p.coordinates)[0],getCent(p.coordinates)[1],mb,1000,800);return <g key={p.id}>
<path d={path} fill={p.ehReserva?'rgba(22,101,52,0.7)':'#e2e8f0'} stroke={p.ehReserva?'#166534':'#94a3b8'} strokeWidth={p.ehReserva?3:2} opacity="0.95" className={p.ehReserva?"":"cursor-pointer hover:opacity-100"} onClick={()=>!p.ehReserva&&setSel(p)}/>
<text x={cx} y={cy-20} textAnchor="middle" fill="#1e293b" fontSize="20" fontWeight="bold" className="pointer-events-none">{p.ehReserva?'ğŸŒ³ ':''}{p.nome}</text>
<text x={cx} y={cy} textAnchor="middle" fill="#64748b" fontSize="16" className="pointer-events-none">{p.area}ha</text>
</g>})}
{gps&&mb&&<circle cx={projC(gps.lng,gps.lat,mb,1000,800)[0]} cy={projC(gps.lng,gps.lat,mb,1000,800)[1]} r="6" fill="#3b82f6"/>}
</g>
</svg>
</div></>}
</div>}
</div>

{modal==='fazenda'&&<div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
<div className="bg-white rounded-lg shadow-2xl max-w-md w-full p-4">
<h2 className="text-lg font-bold mb-4">Novo Local</h2>
<input type="text" placeholder="Nome *" value={fd.nome||''} onChange={e=>setFd({...fd,nome:e.target.value})} className="w-full px-3 py-2 border rounded mb-3"/>
<div className="flex gap-2">
<button onClick={()=>{if(!fd.nome)return;setFaz([...faz,{id:gid(),nome:fd.nome,areaTotal:0,areaPreservacao:0,areaUtil:0}]);setFa(faz.length>0?faz[faz.length-1].id:null);setModal(null);setFd({})}} className="flex-1 bg-green-600 text-white px-4 py-2 rounded">Criar</button>
<button onClick={()=>{setModal(null);setFd({})}} className="px-4 py-2 bg-gray-200 rounded">Cancelar</button>
</div>
</div>
</div>}
</div>}

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
