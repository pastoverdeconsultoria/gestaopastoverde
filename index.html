<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,user-scalable=yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <title>Pasto Verde Pro v3.0 - Gest√£o de Pastagem</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <style>
    body { margin: 0; padding: 0; font-family: system-ui, -apple-system, sans-serif; }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
const { useState, useEffect, useMemo, useRef } = React;

const I = ({ size = 20, children }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">{children}</svg>;
const Upload = p => <I {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12" /></I>;
const Plus = p => <I {...p}><line x1="12" y1="5" x2="12" y2="19" /><line x1="5" y1="12" x2="19" y2="12" /></I>;
const Trash2 = p => <I {...p}><polyline points="3 6 5 6 21 6" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" /></I>;
const X = p => <I {...p}><line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" /></I>;
const MapPin = p => <I {...p}><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" /><circle cx="12" cy="10" r="3" /></I>;
const ZoomIn = p => <I {...p}><circle cx="11" cy="11" r="8" /><line x1="21" y1="21" x2="16.65" y2="16.65" /><line x1="11" y1="8" x2="11" y2="14" /><line x1="8" y1="11" x2="14" y2="11" /></I>;
const ZoomOut = p => <I {...p}><circle cx="11" cy="11" r="8" /><line x1="21" y1="21" x2="16.65" y2="16.65" /><line x1="8" y1="11" x2="14" y2="11" /></I>;
const RotateCcw = p => <I {...p}><polyline points="1 4 1 10 7 10" /><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10" /></I>;
const Download = p => <I {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3" /></I>;
const Edit2 = p => <I {...p}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z" /></I>;
const Navigation = p => <I {...p}><polygon points="3 11 22 2 13 21 11 13 3 11" /></I>;
const Compass = p => <I {...p}><circle cx="12" cy="12" r="10" /><polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76" /></I>;
const Maximize = p => <I {...p}><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3" /></I>;
const BarChart = p => <I {...p}><line x1="12" y1="20" x2="12" y2="10" /><line x1="18" y1="20" x2="18" y2="4" /><line x1="6" y1="20" x2="6" y2="16" /></I>;
const ArrowRightLeft = p => <I {...p}><path d="M8 3L4 7l4 4" /><path d="M4 7h16" /><path d="m16 21 4-4-4-4" /><path d="M20 17H4" /></I>;
const DollarSign = p => <I {...p}><line x1="12" y1="1" x2="12" y2="23" /><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" /></I>;
const ChevronDown = p => <I {...p}><polyline points="6 9 12 15 18 9" /></I>;
const ChevronUp = p => <I {...p}><polyline points="18 15 12 9 6 15" /></I>;

const gid = () => `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
const calcArea = c => {
  if (!c || c.length < 3) return 0;
  let a = 0;
  const n = c.length, lm = c.reduce((s, v) => s + v[1], 0) / n, fl = Math.cos(lm * Math.PI / 180);
  for (let i = 0; i < n; i++) {
    const j = (i + 1) % n, xi = c[i][0] * fl * 111320, yi = c[i][1] * 110540, xj = c[j][0] * fl * 111320, yj = c[j][1] * 110540;
    a += xi * yj - xj * yi;
  }
  return (Math.abs(a) / 2 / 10000).toFixed(2);
};
const calcUA = (p, q) => !p || !q ? 0 : ((p * q) / 450).toFixed(2);
const isReserva = nome => {
  const n = nome.toLowerCase();
  return n.includes('reserva') || n.includes('preserva') || n.includes('app') || n.includes('rl ') || n.includes('mata') || n.includes('floresta');
};
const calcDias = (dataInicio) => {
  if (!dataInicio) return 0;
  const hoje = new Date();
  const inicio = new Date(dataInicio);
  return Math.floor((hoje - inicio) / (1000 * 60 * 60 * 24));
};
const formatData = (d) => {
  if (!d) return '';
  const dt = new Date(d);
  return dt.toLocaleDateString('pt-BR');
};

const loteCores = ['#fbbf24', '#3b82f6', '#10b981', '#f97316', '#8b5cf6', '#ec4899', '#ef4444', '#06b6d4', '#84cc16', '#a855f7'];
const moduloCores = ['#10b981', '#8b5cf6', '#f97316', '#3b82f6', '#ec4899', '#fbbf24', '#06b6d4', '#84cc16'];
const getLoteCor = idx => loteCores[idx % loteCores.length];
const getModuloCor = idx => moduloCores[idx % moduloCores.length];
const hexToRgba = (hex, alpha) => {
  const r = parseInt(hex.slice(1, 3), 16);
  const g = parseInt(hex.slice(3, 5), 16);
  const b = parseInt(hex.slice(5, 7), 16);
  return `rgba(${r},${g},${b},${alpha})`;
};
const pointInPolygon = (p, vs) => {
  let inside = false;
  for (let i = 0, j = vs.length - 1; i < vs.length; j = i++) {
    const xi = vs[i][0], yi = vs[i][1], xj = vs[j][0], yj = vs[j][1];
    if ((yi > p[1]) != (yj > p[1]) && (p[0] < (xj - xi) * (p[1] - yi) / (yj - yi) + xi)) inside = !inside;
  }
  return inside;
};

function App() {
  const [data, setData] = useState({ faz: [], fa: null, mod: [], piq: [], lot: [], his: [], mb: null });
  const [ui, setUi] = useState({ tab: 'mapa', modal: null, sel: null, st: '', zm: 1, pn: { x: 0, y: 0 }, fd: {}, exp: {} });
  const [gps, setGps] = useState({ pos: null, status: 'buscando' });
  const [touch, setTouch] = useState({ active: false, start: null, last: null, dist: 0 });
  const svgRef = useRef(null);

  useEffect(() => {
    const s = localStorage.getItem('pastureSystem');
    if (s) {
      try {
        const d = JSON.parse(s);
        setData({ faz: d.fazendas || [], fa: d.fazendaAtual || null, mod: d.modulos || [], piq: d.piquetes || [], lot: d.lotes || [], his: d.historico || [], mb: d.mapBounds || null });
      } catch (e) { }
    }
  }, []);

  useEffect(() => {
    localStorage.setItem('pastureSystem', JSON.stringify({
      version: '3.0.0',
      fazendas: data.faz,
      fazendaAtual: data.fa,
      modulos: data.mod,
      piquetes: data.piq,
      lotes: data.lot,
      historico: data.his,
      mapBounds: data.mb
    }));
  }, [data]);

  useEffect(() => {
    if (!navigator.geolocation) {
      setGps({ pos: null, status: 'indisponivel' });
      return;
    }
    const id = navigator.geolocation.watchPosition(
      p => setGps({ pos: { lat: p.coords.latitude, lng: p.coords.longitude, acc: p.coords.accuracy }, status: 'ativo' }),
      e => setGps(g => ({ ...g, status: 'erro' })),
      { enableHighAccuracy: true, timeout: 30000, maximumAge: 0 }
    );
    return () => navigator.geolocation.clearWatch(id);
  }, []);

  const getTouchDist = (t1, t2) => Math.hypot(t2.clientX - t1.clientX, t2.clientY - t1.clientY);

  const handleTouchStart = (e) => {
    if (e.touches.length === 1) {
      const t = e.touches[0];
      setTouch({ active: true, start: { x: t.clientX, y: t.clientY }, last: { x: ui.pn.x, y: ui.pn.y }, dist: 0 });
    } else if (e.touches.length === 2) {
      const d = getTouchDist(e.touches[0], e.touches[1]);
      setTouch({ active: true, start: null, last: { x: ui.pn.x, y: ui.pn.y }, dist: d });
    }
  };

  const handleTouchMove = (e) => {
    if (!touch.active) return;
    e.preventDefault();
    
    if (e.touches.length === 1 && touch.start) {
      const t = e.touches[0];
      const dx = t.clientX - touch.start.x;
      const dy = t.clientY - touch.start.y;
      setUi(u => ({ ...u, pn: { x: touch.last.x + dx, y: touch.last.y + dy } }));
    } else if (e.touches.length === 2 && touch.dist > 0) {
      const newDist = getTouchDist(e.touches[0], e.touches[1]);
      const scale = newDist / touch.dist;
      const newZoom = Math.max(0.3, Math.min(5, ui.zm * scale));
      setUi(u => ({ ...u, zm: newZoom }));
      setTouch(t => ({ ...t, dist: newDist }));
    }
  };

  const handleTouchEnd = () => {
    setTouch({ active: false, start: null, last: null, dist: 0 });
  };

  const getPiqGPS = useMemo(() => {
    if (!gps.pos) return null;
    return data.piq.find(x => x.fazendaId === data.fa && x.coordinates && x.coordinates.length > 0 && pointInPolygon([gps.pos.lng, gps.pos.lat], x.coordinates)) || null;
  }, [gps.pos, data.piq, data.fa]);

  const exp = () => {
    const d = { fazendas: data.faz, modulos: data.mod, piquetes: data.piq, lotes: data.lot, historico: data.his, version: '3.0.0' };
    const b = new Blob([JSON.stringify(d, null, 2)], { type: 'application/json' });
    const u = URL.createObjectURL(b);
    const a = document.createElement('a');
    a.href = u;
    a.download = `backup-${Date.now()}.json`;
    a.click();
    URL.revokeObjectURL(u);
    setUi({ ...ui, st: '‚úÖ Backup criado com sucesso.' });
    setTimeout(() => setUi(ui => ({ ...ui, st: '' })), 3000);
  };

  const imp = e => {
    const f = e.target.files[0];
    if (!f) return;
    const r = new FileReader();
    r.onload = ev => {
      try {
        const d = JSON.parse(ev.target.result);
        if (confirm('Importar backup? Substitui todos os dados.')) {
          setData({ faz: d.fazendas || [], fa: null, mod: d.modulos || [], piq: d.piquetes || [], lot: d.lotes || [], his: d.historico || [], mb: null });
          setUi({ ...ui, st: '‚úÖ Backup importado com sucesso.' });
        }
      } catch (er) {
        setUi({ ...ui, st: '‚ùå N√£o foi poss√≠vel importar o backup.' });
      }
    };
    r.readAsText(f);
    e.target.value = '';
  };

  const parseKML = t => {
    const p = new DOMParser(), x = p.parseFromString(t, 'text/xml');
    if (x.querySelector('parsererror')) throw new Error('KML inv√°lido');
    const pl = x.getElementsByTagName('Placemark');
    if (pl.length === 0) throw new Error('Sem √°reas no KML');
    const np = [];
    let minLat = Infinity, maxLat = -Infinity, minLng = Infinity, maxLng = -Infinity, aT = 0, aR = 0;
    for (let i = 0; i < pl.length; i++) {
      const pm = pl[i], ne = pm.getElementsByTagName('name')[0], nm = ne ? ne.textContent.trim() : `√Årea ${i + 1}`;
      const ce = pm.getElementsByTagName('coordinates')[0];
      let co = [], ar = 0;
      const reserva = isReserva(nm);
      if (ce) {
        const ct = ce.textContent.trim(), cp = ct.split(/\s+/);
        co = cp.map(pr => {
          const [lng, lat] = pr.split(',').map(parseFloat);
          if (!isNaN(lng) && !isNaN(lat)) {
            minLng = Math.min(minLng, lng);
            maxLng = Math.max(maxLng, lng);
            minLat = Math.min(minLat, lat);
            maxLat = Math.max(maxLat, lat);
            return [lng, lat];
          }
          return null;
        }).filter(c => c);
        if (co.length > 2) {
          ar = parseFloat(calcArea(co));
          aT += ar;
          if (reserva) aR += ar;
        }
      }
      np.push({
        id: gid(),
        fazendaId: data.fa,
        moduloId: null,
        nome: nm,
        area: ar,
        coordinates: co,
        loteAtualId: null,
        dataEntrada: null,
        dataSaida: null,
        ehReserva: reserva,
        dataCriacao: new Date().toISOString()
      });
    }
    const mb = { minLat, maxLat, minLng, maxLng, centerLat: (minLat + maxLat) / 2, centerLng: (minLng + maxLng) / 2, width: maxLng - minLng, height: maxLat - minLat };
    return { piquetes: np, stats: { total: aT.toFixed(2), reserva: aR.toFixed(2), util: (aT - aR).toFixed(2) }, mapBounds: mb };
  };

  const hKML = e => {
    const f = e.target.files[0];
    if (!f) return;
    if (!data.fa) {
      alert('‚ö†Ô∏è Crie uma fazenda primeiro!\n\nV√° em "Fazendas" e crie uma fazenda antes de importar o KML.');
      e.target.value = '';
      return;
    }
    const r = new FileReader();
    r.onload = ev => {
      try {
        const res = parseKML(ev.target.result);
        const piqExistentes = data.piq.filter(p => p.fazendaId === data.fa);
        if (piqExistentes.length > 0 && !confirm('Substituir √°reas existentes?')) return;
        
        setData({
          ...data,
          piq: data.piq.filter(p => p.fazendaId !== data.fa).concat(res.piquetes),
          mb: res.mapBounds,
          faz: data.faz.map(f => f.id === data.fa ? {
            ...f,
            areaTotal: res.stats.total,
            areaPreservacao: res.stats.reserva,
            areaUtil: res.stats.util
          } : f)
        });
        
        setUi({ ...ui, st: `‚úÖ ${res.piquetes.length} √°reas importadas!`, zm: 1, pn: { x: 0, y: 0 } });
        setTimeout(() => setUi(ui => ({ ...ui, st: '' })), 3000);
      } catch (er) {
        setUi({ ...ui, st: `‚ùå ${er.message}` });
        setTimeout(() => setUi(ui => ({ ...ui, st: '' })), 5000);
      }
    };
    r.readAsText(f);
    e.target.value = '';
  };

  const projC = (lng, lat, b, w, h) => {
    if (!b) return [0, 0];
    const p = 50;
    return [((lng - b.minLng) / b.width) * (w - p * 2) + p, ((b.maxLat - lat) / b.height) * (h - p * 2) + p];
  };

  const getPath = (c, b, w, h) => {
    if (!c || c.length === 0) return '';
    return c.map((co, i) => {
      const [x, y] = projC(co[0], co[1], b, w, h);
      return `${i === 0 ? 'M' : 'L'} ${x} ${y}`;
    }).join(' ') + ' Z';
  };

  const getCent = c => {
    if (!c || c.length === 0) return [0, 0];
    let sLng = 0, sLat = 0;
    c.forEach(co => { sLng += co[0]; sLat += co[1]; });
    return [sLng / c.length, sLat / c.length];
  };

  const irParaGPS = () => {
    if (!gps.pos || !data.mb) return;
    const [gx, gy] = projC(gps.pos.lng, gps.pos.lat, data.mb, 1000, 800);
    setUi({ ...ui, zm: 2, pn: { x: 500 - gx * 2, y: 400 - gy * 2 } });
  };

  const irParaMapa = () => {
    setUi({ ...ui, zm: 1, pn: { x: 0, y: 0 } });
  };

  const orientarNorte = () => {
    setUi({ ...ui, pn: { x: 0, y: 0 } });
  };

  const fazAt = data.faz.find(f => f.id === data.fa);
  const piqF = data.piq.filter(p => p.fazendaId === data.fa);
  const modF = data.mod.filter(m => m.fazendaId === data.fa);
  const lotF = data.lot.filter(l => l.fazendaId === data.fa && l.status !== 'vendido');

  const totalAnimais = lotF.reduce((s, l) => s + (l.quantidade || 0), 0);
  const totalUA = lotF.reduce((s, l) => s + parseFloat(l.totalUA || 0), 0).toFixed(2);
  const areaUtil = parseFloat(fazAt?.areaUtil || 0);
  const lotacaoGlobal = areaUtil > 0 ? (totalUA / areaUtil).toFixed(2) : '0.00';

  const piqOcupados = piqF.filter(p => p.loteAtualId).length;
  const piqVazios = piqF.filter(p => !p.loteAtualId && !p.ehReserva).length;
  const piqTotal = piqF.filter(p => !p.ehReserva).length;
  const percOcupacao = piqTotal > 0 ? ((piqOcupados / piqTotal) * 100).toFixed(0) : 0;

  const dataHoje = new Date().toLocaleDateString('pt-BR');

  const getModuloStats = (modId) => {
    const pqs = piqF.filter(p => p.moduloId === modId && !p.ehReserva);
    const areaTotal = pqs.reduce((s, p) => s + parseFloat(p.area || 0), 0);
    const lotesDoModulo = lotF.filter(l => l.piqueteAtual && pqs.find(p => p.id === l.piqueteAtual));
    const uaTotal = lotesDoModulo.reduce((s, l) => s + parseFloat(l.totalUA || 0), 0);
    const lotacao = areaTotal > 0 ? (uaTotal / areaTotal).toFixed(2) : '0.00';
    return { areaTotal: areaTotal.toFixed(2), lotacao };
  };

  return <div className="min-h-screen bg-gray-50">
    <div className="bg-gradient-to-r from-emerald-600 to-teal-600 text-white p-4 shadow-lg">
      <div className="max-w-7xl mx-auto">
        <h1 className="text-2xl font-bold mb-1">üìä Pasto Verde Pro v3.0</h1>
        <p className="text-sm opacity-90">Gest√£o de pastagem simples e pr√°tica para o dia a dia.</p>
        {fazAt && <div className="text-sm flex items-center gap-2 flex-wrap">
          <button onClick={() => setUi({ ...ui, modal: 'trocar-fazenda' })} className="bg-white/20 hover:bg-white/30 px-2 py-1 rounded flex items-center gap-1 font-semibold">
            üìç {fazAt.nome} ‚ñº
          </button>
          <span className="text-xs opacity-80">üìÖ {dataHoje}</span>
          {gps.status === 'ativo' && getPiqGPS && <span className="bg-green-100 text-green-800 px-2 py-1 rounded text-xs font-semibold">‚úÖ GPS | üìç {getPiqGPS.nome}</span>}
          {gps.status === 'ativo' && !getPiqGPS && <span className="bg-green-100 text-green-800 px-2 py-1 rounded text-xs">‚úÖ GPS Ativo</span>}
        </div>}
      </div>
    </div>

    {ui.st && <div className="max-w-7xl mx-auto px-4 pt-2">
      <div className={`p-2 rounded text-sm ${ui.st.includes('‚úÖ') ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>{ui.st}</div>
    </div>}

    {data.fa && <div className="bg-white border-b sticky top-0 z-10">
      <div className="max-w-7xl mx-auto flex gap-1 overflow-x-auto">
        {['dashboard', 'mapa', 'piquetes', 'modulos', 'lotes', 'historico', 'config'].map(t => <button key={t} onClick={() => setUi({ ...ui, tab: t })} className={`px-4 py-2 font-semibold capitalize whitespace-nowrap ${ui.tab === t ? 'border-b-2 border-green-600 text-green-600' : 'text-gray-600'}`}>
          {t === 'config' ? '‚öôÔ∏è' : t}
        </button>)}
      </div>
    </div>}

    <div className="max-w-7xl mx-auto p-4">
      {!data.fa ? <div className="bg-white rounded-lg shadow p-6">
        <div className="flex justify-between items-center mb-4">
          <h2 className="text-xl font-bold">Fazendas</h2>
          <button onClick={() => setUi({ ...ui, modal: 'fazenda', fd: {} })} className="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 flex items-center gap-1">
            <Plus size={18} />Novo
          </button>
        </div>
        {data.faz.length === 0 ? <div className="text-center py-8 text-gray-500">Nenhuma fazenda cadastrada</div> :
          data.faz.map(f => <div key={f.id} className="border-2 rounded-lg p-4 mb-3 hover:border-green-500 transition cursor-pointer" onClick={() => { setData({ ...data, fa: f.id }); setUi({ ...ui, tab: 'dashboard' }); }}>
            <h3 className="text-lg font-bold text-green-600 hover:text-green-700">{f.nome}</h3>
            {f.areaTotal > 0 && <div className="text-sm text-gray-600 mt-2">
              <div>üìä Total: {f.areaTotal}ha | üåæ √ötil: {f.areaUtil}ha</div>
              <div>üå≥ Preserva√ß√£o: {f.areaPreservacao}ha</div>
            </div>}
          </div>)}
      </div> :

        ui.tab === 'dashboard' ? <div className="space-y-4">
          <div className="bg-white rounded-lg shadow p-6">
            <h2 className="text-xl font-bold mb-4 flex items-center gap-2">
              <BarChart size={24} />Dashboard da Fazenda
            </h2>
            
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
              <div className="bg-blue-50 border-2 border-blue-200 rounded-lg p-4">
                <div className="text-xs text-blue-600 font-semibold mb-1">√Årea Total</div>
                <div className="text-2xl font-bold text-blue-700">{fazAt?.areaTotal || 0}<span className="text-sm">ha</span></div>
              </div>
              
              <div className="bg-green-50 border-2 border-green-200 rounded-lg p-4">
                <div className="text-xs text-green-600 font-semibold mb-1">√Årea √ötil</div>
                <div className="text-2xl font-bold text-green-700">{fazAt?.areaUtil || 0}<span className="text-sm">ha</span></div>
              </div>
              
              <div className="bg-purple-50 border-2 border-purple-200 rounded-lg p-4">
                <div className="text-xs text-purple-600 font-semibold mb-1">Animais</div>
                <div className="text-2xl font-bold text-purple-700">{totalAnimais}<span className="text-sm">cab</span></div>
              </div>
              
              <div className="bg-indigo-50 border-2 border-indigo-200 rounded-lg p-4">
                <div className="text-xs text-indigo-600 font-semibold mb-1">Total UA</div>
                <div className="text-2xl font-bold text-indigo-700">{totalUA}<span className="text-sm">ua</span></div>
              </div>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
              <div className="bg-white border-2 border-gray-200 rounded-lg p-4 text-center">
                <div className="text-sm text-gray-600 mb-1">Lota√ß√£o Global</div>
                <div className="text-3xl font-bold text-gray-800">{lotacaoGlobal}<span className="text-sm"> UA/ha</span></div>
              </div>
              <div className="bg-white border-2 border-gray-200 rounded-lg p-4 text-center">
                <div className="text-sm text-gray-600 mb-1">Piquetes Ocupados</div>
                <div className="text-3xl font-bold text-gray-800">{piqOcupados}/{piqTotal}</div>
              </div>
              <div className="bg-white border-2 border-gray-200 rounded-lg p-4 text-center">
                <div className="text-sm text-gray-600 mb-1">Ocupa√ß√£o</div>
                <div className="text-3xl font-bold text-gray-800">{percOcupacao}<span className="text-sm">%</span></div>
              </div>
            </div>
            
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div className="bg-white border-2 border-gray-200 rounded-lg p-4">
                <h3 className="text-lg font-bold mb-3 flex items-center gap-2">
                  üìç Piquetes
                </h3>
                <div className="space-y-2">
                  <div className="flex justify-between">
                    <span>Total:</span>
                    <span className="font-bold">{piqTotal}</span>
                  </div>
                  <div className="flex justify-between">
                    <span>Ocupados:</span>
                    <span className="font-bold text-green-600">{piqOcupados}</span>
                  </div>
                  <div className="flex justify-between">
                    <span>Vazios:</span>
                    <span className="font-bold text-blue-600">{piqVazios}</span>
                  </div>
                </div>
              </div>
              
              <div className="bg-white border-2 border-gray-200 rounded-lg p-4">
                <h3 className="text-lg font-bold mb-3 flex items-center gap-2">
                  üêÑ Lotes
                </h3>
                <div className="space-y-2">
                  <div className="flex justify-between">
                    <span>Total:</span>
                    <span className="font-bold">{lotF.length}</span>
                  </div>
                  <div className="flex justify-between">
                    <span>Alocados:</span>
                    <span className="font-bold text-green-600">{lotF.filter(l => l.status === 'alocado').length}</span>
                  </div>
                  <div className="flex justify-between">
                    <span>Livres:</span>
                    <span className="font-bold text-blue-600">{lotF.filter(l => l.status === 'livre').length}</span>
                  </div>
                </div>
              </div>
            </div>
            
            {modF.length > 0 && <div className="mt-6">
              <h3 className="text-lg font-bold mb-3">üì¶ M√≥dulos</h3>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                {modF.map((mod, idx) => {
                  const stats = getModuloStats(mod.id);
                  return <div key={mod.id} className="bg-white border-2 rounded-lg p-3" style={{ borderColor: getModuloCor(idx) }}>
                    <div className="flex justify-between items-center">
                      <span className="font-bold">{mod.nome}</span>
                      <span className="text-sm">√Årea: {stats.areaTotal}ha</span>
                    </div>
                    <div className="text-sm text-gray-600">Lota√ß√£o: {stats.lotacao} UA/ha</div>
                  </div>;
                })}
              </div>
            </div>}
            
          </div>
        </div> :

        ui.tab === 'mapa' ? <div className="bg-white rounded-lg shadow p-4">
          <div className="flex justify-between items-center mb-3">
            <h2 className="text-lg font-bold flex items-center gap-2">üó∫Ô∏è Mapa da Fazenda</h2>
            <div className="flex gap-2">
              <button onClick={irParaMapa} className="p-2 bg-gray-100 rounded hover:bg-gray-200" title="Reset zoom"><Maximize size={18} /></button>
              <button onClick={irParaGPS} className={`p-2 rounded ${gps.status === 'ativo' ? 'bg-green-100 hover:bg-green-200' : 'bg-gray-100'}`} title="Ir para GPS"><Navigation size={18} /></button>
              <button onClick={orientarNorte} className="p-2 bg-gray-100 rounded hover:bg-gray-200" title="Orientar Norte"><Compass size={18} /></button>
            </div>
          </div>
          
          {!data.mb || piqF.length === 0 ? (
            <div className="text-center py-20 text-gray-500">
              <Upload size={48} />
              <p className="mt-4">Importe um arquivo KML para visualizar o mapa</p>
            </div>
          ) : (
            <div 
              className="relative border-2 border-gray-200 rounded-lg overflow-hidden touch-none"
              style={{ height: '70vh' }}
              onTouchStart={handleTouchStart}
              onTouchMove={handleTouchMove}
              onTouchEnd={handleTouchEnd}
            >
              <svg 
                ref={svgRef}
                width="100%" 
                height="100%" 
                viewBox="0 0 1000 800"
                className="bg-green-50"
                style={{
                  transform: `translate(${ui.pn.x}px, ${ui.pn.y}px) scale(${ui.zm})`,
                  transformOrigin: 'center center'
                }}
              >
                {piqF.map((p, i) => {
                  if (!p.coordinates || p.coordinates.length === 0) return null;
                  const cor = p.loteAtualId ? '#10b981' : p.ehReserva ? '#e5e7eb' : '#fef3c7';
                  const stroke = p.loteAtualId ? '#047857' : p.ehReserva ? '#9ca3af' : '#f59e0b';
                  return (
                    <g key={p.id}>
                      <path
                        d={getPath(p.coordinates, data.mb, 1000, 800)}
                        fill={cor}
                        stroke={stroke}
                        strokeWidth={p.id === ui.sel?.id ? 3 : 1}
                        onClick={() => setUi({ ...ui, modal: 'piquete-info', sel: p })}
                        className="cursor-pointer"
                      />
                      {(() => {
                        const [lng, lat] = getCent(p.coordinates);
                        const [x, y] = projC(lng, lat, data.mb, 1000, 800);
                        return <text x={x} y={y} textAnchor="middle" className="text-xs fill-gray-700">{p.nome}</text>;
                      })()}
                    </g>
                  );
                })}
              </svg>
              
              <div className="absolute bottom-4 right-4 bg-white rounded-lg shadow p-2 space-y-2">
                <button onClick={() => setUi({ ...ui, zm: Math.min(5, ui.zm * 1.2) })} className="block p-2 bg-gray-100 rounded hover:bg-gray-200">
                  <ZoomIn size={20} />
                </button>
                <button onClick={() => setUi({ ...ui, zm: Math.max(0.3, ui.zm / 1.2) })} className="block p-2 bg-gray-100 rounded hover:bg-gray-200">
                  <ZoomOut size={20} />
                </button>
                <button onClick={() => setUi({ ...ui, pn: { x: 0, y: 0 }, zm: 1 })} className="block p-2 bg-gray-100 rounded hover:bg-gray-200">
                  <RotateCcw size={20} />
                </button>
              </div>
            </div>
          )}
        </div> :

        ui.tab === 'piquetes' ? <div className="bg-white rounded-lg shadow p-6">
          <div className="flex justify-between items-center mb-4">
            <h2 className="text-xl font-bold">Piquetes</h2>
            <button onClick={() => setUi({ ...ui, modal: 'piquete', fd: {} })} className="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 flex items-center gap-1">
              <Plus size={18} />Novo
            </button>
          </div>
          {piqF.filter(p => !p.ehReserva).length === 0 ? <div className="text-center py-8 text-gray-500">Nenhum piquete cadastrado</div> :
            piqF.filter(p => !p.ehReserva).map((p, idx) => {
              const modulo = modF.find(m => m.id === p.moduloId);
              return (
                <div key={p.id} className="border-2 rounded-lg p-4 mb-3 hover:border-green-500 transition">
                  <div className="flex justify-between items-start">
                    <div>
                      <h3 className="text-lg font-bold">{p.nome}</h3>
                      <p className="text-sm text-gray-600">{p.area} ha {modulo && `| ${modulo.nome}`}</p>
                      <p className="text-xs text-gray-500 mt-1">√öltima sa√≠da: {formatData(p.dataSaida) || 'N/A'} | Dias vazio: {calcDias(p.dataSaida || p.dataCriacao)}</p>
                    </div>
                    <div className="flex gap-2">
                      {p.loteAtualId && <span className="px-2 py-1 bg-green-100 text-green-800 text-xs rounded">Ocupado</span>}
                      {!p.loteAtualId && <span className="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded">Livre</span>}
                    </div>
                  </div>
                  <div className="flex gap-2 mt-3">
                    <button onClick={() => setUi({ ...ui, modal: 'piquete', sel: p, fd: { ...p } })} className="px-3 py-1 bg-gray-100 rounded hover:bg-gray-200 text-sm">Editar</button>
                    <button onClick={() => setUi({ ...ui, modal: 'piquete-info', sel: p })} className="px-3 py-1 bg-blue-100 rounded hover:bg-blue-200 text-sm">Detalhes</button>
                  </div>
                </div>
              );
            })}
        </div> :

        ui.tab === 'modulos' ? <div className="bg-white rounded-lg shadow p-6">
          <div className="flex justify-between items-center mb-4">
            <h2 className="text-xl font-bold">M√≥dulos</h2>
            <button onClick={() => setUi({ ...ui, modal: 'modulo', fd: {} })} className="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 flex items-center gap-1">
              <Plus size={18} />Novo
            </button>
          </div>
          {modF.length === 0 ? <div className="text-center py-8 text-gray-500">Nenhum m√≥dulo cadastrado</div> :
            modF.map((m, idx) => {
              const pqs = piqF.filter(p => p.moduloId === m.id);
              const areaTotal = pqs.reduce((s, p) => s + parseFloat(p.area || 0), 0).toFixed(2);
              const lotacao = getModuloStats(m.id).lotacao;
              return (
                <div key={m.id} className="border-2 rounded-lg p-4 mb-3" style={{ borderColor: getModuloCor(idx) }}>
                  <div className="flex justify-between items-start">
                    <div>
                      <h3 className="text-lg font-bold">{m.nome}</h3>
                      <p className="text-sm text-gray-600">√Årea: {areaTotal} ha | Lota√ß√£o: {lotacao} UA/ha</p>
                      <p className="text-xs text-gray-500 mt-1">Piquetes: {pqs.filter(p => !p.ehReserva).length}</p>
                    </div>
                    <div className="flex gap-2">
                      <span className="px-2 py-1 bg-purple-100 text-purple-800 text-xs rounded">{pqs.filter(p => p.loteAtualId).length} ocupados</span>
                    </div>
                  </div>
                  <div className="flex gap-2 mt-3">
                    <button onClick={() => setUi({ ...ui, modal: 'modulo', sel: m, fd: { ...m } })} className="px-3 py-1 bg-gray-100 rounded hover:bg-gray-200 text-sm">Editar</button>
                    <button onClick={() => {
                      if (confirm('Deletar este m√≥dulo?')) {
                        setData({
                          ...data,
                          mod: data.mod.filter(md => md.id !== m.id),
                          piq: data.piq.map(p => p.moduloId === m.id ? { ...p, moduloId: null } : p)
                        });
                        setUi({ ...ui, st: '‚úÖ M√≥dulo removido com sucesso.' });
                        setTimeout(() => setUi(u => ({ ...u, st: '' })), 3000);
                      }
                    }} className="px-3 py-1 bg-red-100 rounded hover:bg-red-200 text-sm">Excluir</button>
                  </div>
                </div>
              );
            })}
        </div> :

        ui.tab === 'lotes' ? <div className="bg-white rounded-lg shadow p-6">
          <div className="flex justify-between items-center mb-4">
            <h2 className="text-xl font-bold">Lotes</h2>
            <button onClick={() => setUi({ ...ui, modal: 'lote', fd: {} })} className="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 flex items-center gap-1">
              <Plus size={18} />Novo
            </button>
          </div>
          {lotF.length === 0 ? <div className="text-center py-8 text-gray-500">Nenhum lote cadastrado</div> :
            lotF.map((l, idx) => {
              const piqAtual = l.piqueteAtual ? piqF.find(p => p.id === l.piqueteAtual) : null;
              return (
                <div key={l.id} className="border-2 rounded-lg p-4 mb-3" style={{ borderColor: getLoteCor(idx) }}>
                  <div className="flex justify-between items-start">
                    <div>
                      <h3 className="text-lg font-bold">{l.nome}</h3>
                      <p className="text-sm text-gray-600">{l.quantidade} cabe√ßas | {l.pesoMedio}kg | {l.totalUA} UA</p>
                      {piqAtual && <p className="text-xs text-gray-500 mt-1">üìç {piqAtual.nome}</p>}
                    </div>
                    <div className="flex gap-2">
                      <span className={`px-2 py-1 text-xs rounded ${l.status === 'alocado' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}`}>
                        {l.status === 'alocado' ? 'Alocado' : 'Livre'}
                      </span>
                    </div>
                  </div>
                  <div className="flex gap-2 mt-3">
                    <button onClick={() => setUi({ ...ui, modal: 'lote', sel: l, fd: { ...l } })} className="px-3 py-1 bg-gray-100 rounded hover:bg-gray-200 text-sm">Editar</button>
                    <button onClick={() => setUi({ ...ui, modal: 'lote-info', sel: l })} className="px-3 py-1 bg-blue-100 rounded hover:bg-blue-200 text-sm">Detalhes</button>
                    {l.status === 'livre' && <button onClick={() => {
                      if (confirm('Deletar este lote?')) {
                        setData({ ...data, lot: data.lot.filter(lo => lo.id !== l.id) });
                        setUi({ ...ui, st: '‚úÖ Lote exclu√≠do com sucesso.' });
                        setTimeout(() => setUi(u => ({ ...u, st: '' })), 3000);
                      }
                    }} className="px-3 py-1 bg-red-100 rounded hover:bg-red-200 text-sm">Excluir</button>}
                  </div>
                </div>
              );
            })}
        </div> :

        ui.tab === 'historico' ? <div className="bg-white rounded-lg shadow p-6">
          <h2 className="text-xl font-bold mb-4">Hist√≥rico de Movimenta√ß√µes</h2>
          {data.his.filter(h => h.fazendaId === data.fa).length === 0 ? <div className="text-center py-8 text-gray-500">Nenhuma movimenta√ß√£o registrada</div> :
            <div className="space-y-3">
              {data.his.filter(h => h.fazendaId === data.fa).sort((a,b) => new Date(b.data) - new Date(a.data)).map(h => {
                const lote = data.lot.find(l => l.id === h.loteId);
                const piq = data.piq.find(p => p.id === h.piqueteId);
                return (
                  <div key={h.id} className="border rounded-lg p-3">
                    <div className="font-semibold">{h.descricao}</div>
                    <div className="text-xs text-gray-500">{formatData(h.data)}</div>
                    {lote && <div className="text-xs text-gray-600">üêÑ {lote.nome}</div>}
                    {piq && <div className="text-xs text-gray-600">üìç {piq.nome}</div>}
                  </div>
                );
              })}
            </div>
          }
        </div> :

        ui.tab === 'config' ? <div className="bg-white rounded-lg shadow p-6">
          <h2 className="text-xl font-bold mb-4">Configura√ß√µes</h2>
          <div className="space-y-4">
            <div className="border rounded-lg p-4">
              <h3 className="font-bold mb-2">üîÑ Backup</h3>
              <div className="flex gap-2">
                <button onClick={exp} className="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 flex items-center gap-2">
                  <Download size={18} /> Fazer Backup
                </button>
                <label className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 cursor-pointer flex items-center gap-2">
                  <Upload size={18} /> Importar
                  <input type="file" className="hidden" onChange={imp} accept=".json" />
                </label>
              </div>
            </div>
            
            <div className="border rounded-lg p-4">
              <h3 className="font-bold mb-2">üó∫Ô∏è Importar KML</h3>
              <label className="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700 cursor-pointer inline-flex items-center gap-2">
                <Upload size={18} /> Selecionar KML
                <input type="file" className="hidden" onChange={hKML} accept=".kml" />
              </label>
            </div>
            
            <div className="border rounded-lg p-4">
              <h3 className="font-bold mb-2">‚ö†Ô∏è Limpar Dados</h3>
              <p className="text-sm text-gray-600 mb-2">Esta a√ß√£o remove todos os dados da fazenda atual</p>
              <button onClick={() => {
                if (confirm('Tem certeza? Isso ir√° apagar todos os dados desta fazenda.')) {
                  setData({
                    ...data,
                    mod: data.mod.filter(m => m.fazendaId !== data.fa),
                    piq: data.piq.filter(p => p.fazendaId !== data.fa),
                    lot: data.lot.filter(l => l.fazendaId !== data.fa),
                    his: data.his.filter(h => h.fazendaId !== data.fa),
                    faz: data.faz.map(f => f.id === data.fa ? { ...f, areaTotal: 0, areaUtil: 0, areaPreservacao: 0 } : f)
                  });
                  setUi({ ...ui, st: '‚úÖ Itens apagados com sucesso.' });
                  setTimeout(() => setUi(u => ({ ...u, st: '' })), 3000);
                }
              }} className="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">Limpar Fazenda</button>
            </div>
          </div>
        </div> : null}
    </div>

    {ui.modal === 'fazenda' && <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-lg p-4 max-w-md w-full">
        <div className="flex justify-between items-center mb-3">
          <h2 className="text-lg font-bold">{ui.sel ? 'Editar Fazenda' : 'Nova Fazenda'}</h2>
          <button onClick={() => setUi({ ...ui, modal: null, sel: null })} className="text-gray-500 hover:text-gray-700">
            <X size={20} />
          </button>
        </div>
        <div className="space-y-3">
          <input type="text" placeholder="Nome da fazenda" value={ui.fd.nome || ''} onChange={e => setUi({ ...ui, fd: { ...ui.fd, nome: e.target.value } })} className="w-full border rounded px-3 py-2" />
          <input type="text" placeholder="Localiza√ß√£o" value={ui.fd.localizacao || ''} onChange={e => setUi({ ...ui, fd: { ...ui.fd, localizacao: e.target.value } })} className="w-full border rounded px-3 py-2" />
          <div className="flex gap-2">
            <input type="number" placeholder="√Årea Total (ha)" value={ui.fd.areaTotal || ''} onChange={e => setUi({ ...ui, fd: { ...ui.fd, areaTotal: e.target.value } })} className="w-full border rounded px-3 py-2" />
            <input type="number" placeholder="√Årea Preserva√ß√£o (ha)" value={ui.fd.areaPreservacao || ''} onChange={e => setUi({ ...ui, fd: { ...ui.fd, areaPreservacao: e.target.value } })} className="w-full border rounded px-3 py-2" />
          </div>
          <div className="flex gap-2">
            <button onClick={() => {
              if (!ui.fd.nome) {
                setUi({ ...ui, st: '‚ùå Preencha todos os campos obrigat√≥rios para continuar.' });
                setTimeout(() => setUi(u => ({ ...u, st: '' })), 3000);
                return;
              }
              if (ui.sel) {
                setData({ ...data, faz: data.faz.map(f => f.id === ui.sel.id ? { ...f, ...ui.fd, areaUtil: (parseFloat(ui.fd.areaTotal || 0) - parseFloat(ui.fd.areaPreservacao || 0)).toFixed(2) } : f) });
              } else {
                setData({ ...data, faz: [...data.faz, { ...ui.fd, id: gid(), areaUtil: (parseFloat(ui.fd.areaTotal || 0) - parseFloat(ui.fd.areaPreservacao || 0)).toFixed(2) }] });
              }
              setUi({ ...ui, modal: null, sel: null, st: ui.sel ? '‚úÖ Fazenda atualizada com sucesso.' : '‚úÖ Fazenda criada com sucesso.' });
              setTimeout(() => setUi(u => ({ ...u, st: '' })), 3000);
            }} className="flex-1 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">{ui.sel ? 'Atualizar' : 'Criar'}</button>
          </div>
        </div>
      </div>
    </div>}

    {ui.modal === 'trocar-fazenda' && <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-lg p-4 max-w-md w-full">
        <div className="flex justify-between items-center mb-3">
          <h2 className="text-lg font-bold">Selecionar Fazenda</h2>
          <button onClick={() => setUi({ ...ui, modal: null })} className="text-gray-500 hover:text-gray-700">
            <X size={20} />
          </button>
        </div>
        {data.faz.map(f => <button key={f.id} onClick={() => { setData({ ...data, fa: f.id }); setUi({ ...ui, modal: null, tab: 'dashboard' }); }} className="w-full text-left border rounded px-3 py-2 mb-2 hover:border-green-500">
          <div className="font-semibold">{f.nome}</div>
          <div className="text-xs text-gray-500">{f.localizacao || 'Sem localiza√ß√£o'}</div>
        </button>)}
      </div>
    </div>}

    {ui.modal === 'modulo' && <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-lg p-4 max-w-md w-full">
        <div className="flex justify-between items-center mb-3">
          <h2 className="text-lg font-bold">{ui.sel ? 'Editar M√≥dulo' : 'Novo M√≥dulo'}</h2>
          <button onClick={() => setUi({ ...ui, modal: null, sel: null })} className="text-gray-500 hover:text-gray-700">
            <X size={20} />
          </button>
        </div>
        <div className="space-y-3">
          <input type="text" placeholder="Nome do m√≥dulo" value={ui.fd.nome || ''} onChange={e => setUi({ ...ui, fd: { ...ui.fd, nome: e.target.value } })} className="w-full border rounded px-3 py-2" />
          <div className="flex gap-2">
            <button onClick={() => {
              if (!ui.fd.nome) {
                setUi({ ...ui, st: '‚ùå Preencha todos os campos obrigat√≥rios para continuar.' });
                setTimeout(() => setUi(u => ({ ...u, st: '' })), 3000);
                return;
              }
              if (ui.sel) {
                setData({ ...data, mod: data.mod.map(m => m.id === ui.sel.id ? { ...m, ...ui.fd } : m) });
                setUi({ ...ui, st: '‚úÖ M√≥dulo atualizado com sucesso.' });
              } else {
                setData({ ...data, mod: [...data.mod, { ...ui.fd, id: gid(), fazendaId: data.fa }] });
                setUi({ ...ui, st: '‚úÖ M√≥dulo criado com sucesso.' });
              }
              setTimeout(() => setUi(u => ({ ...u, st: '' })), 3000);
              setUi({ ...ui, modal: null, sel: null });
            }} className="flex-1 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">{ui.sel ? 'Atualizar' : 'Criar'}</button>
          </div>
        </div>
      </div>
    </div>}

    {ui.modal === 'piquete' && <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-lg p-4 max-w-md w-full">
        <div className="flex justify-between items-center mb-3">
          <h2 className="text-lg font-bold">{ui.sel ? 'Editar Piquete' : 'Novo Piquete'}</h2>
          <button onClick={() => setUi({ ...ui, modal: null, sel: null })} className="text-gray-500 hover:text-gray-700">
            <X size={20} />
          </button>
        </div>
        <div className="space-y-3">
          <input type="text" placeholder="Nome do piquete" value={ui.fd.nome || ''} onChange={e => setUi({ ...ui, fd: { ...ui.fd, nome: e.target.value } })} className="w-full border rounded px-3 py-2" />
          <input type="number" placeholder="√Årea (ha)" value={ui.fd.area || ''} onChange={e => setUi({ ...ui, fd: { ...ui.fd, area: e.target.value } })} className="w-full border rounded px-3 py-2" />
          <select value={ui.fd.moduloId || ''} onChange={e => setUi({ ...ui, fd: { ...ui.fd, moduloId: e.target.value || null } })} className="w-full border rounded px-3 py-2">
            <option value="">Sem m√≥dulo</option>
            {modF.map(m => <option key={m.id} value={m.id}>{m.nome}</option>)}
          </select>
          <div className="flex gap-2">
            <button onClick={() => {
              if (!ui.fd.nome || !ui.fd.area) {
                setUi({ ...ui, st: '‚ùå Preencha todos os campos obrigat√≥rios para continuar.' });
                setTimeout(() => setUi(u => ({ ...u, st: '' })), 3000);
                return;
              }
              if (ui.sel) {
                setData({ ...data, piq: data.piq.map(p => p.id === ui.sel.id ? { ...p, ...ui.fd } : p) });
                setUi({ ...ui, st: '‚úÖ Piquete atualizado com sucesso.' });
              } else {
                setData({ ...data, piq: [...data.piq, { ...ui.fd, id: gid(), fazendaId: data.fa, dataCriacao: new Date().toISOString(), loteAtualId: null, ehReserva: false }] });
                setUi({ ...ui, st: '‚úÖ Piquete criado com sucesso.' });
              }
              setTimeout(() => setUi(u => ({ ...u, st: '' })), 3000);
              setUi({ ...ui, modal: null, sel: null });
            }} className="flex-1 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">{ui.sel ? 'Atualizar' : 'Criar'}</button>
          </div>
        </div>
      </div>
    </div>}

    {ui.modal === 'lote' && <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-lg p-4 max-w-md w-full">
        <div className="flex justify-between items-center mb-3">
          <h2 className="text-lg font-bold">{ui.sel ? 'Editar Lote' : 'Novo Lote'}</h2>
          <button onClick={() => setUi({ ...ui, modal: null, sel: null })} className="text-gray-500 hover:text-gray-700">
            <X size={20} />
          </button>
        </div>
        <div className="space-y-3">
          <input type="text" placeholder="Nome do lote" value={ui.fd.nome || ''} onChange={e => setUi({ ...ui, fd: { ...ui.fd, nome: e.target.value } })} className="w-full border rounded px-3 py-2" />
          <input type="text" placeholder="Categoria" value={ui.fd.categoria || ''} onChange={e => setUi({ ...ui, fd: { ...ui.fd, categoria: e.target.value } })} className="w-full border rounded px-3 py-2" />
          <input type="number" placeholder="Quantidade" value={ui.fd.quantidade || ''} onChange={e => setUi({ ...ui, fd: { ...ui.fd, quantidade: e.target.value } })} className="w-full border rounded px-3 py-2" />
          <input type="number" placeholder="Peso m√©dio (kg)" value={ui.fd.pesoMedio || ''} onChange={e => setUi({ ...ui, fd: { ...ui.fd, pesoMedio: e.target.value } })} className="w-full border rounded px-3 py-2" />
          <div className="flex gap-2">
            <button onClick={() => {
              if (!ui.fd.nome || !ui.fd.categoria || !ui.fd.quantidade || !ui.fd.pesoMedio) {
                setUi({ ...ui, st: '‚ùå Preencha todos os campos obrigat√≥rios para continuar.' });
                setTimeout(() => setUi(u => ({ ...u, st: '' })), 3000);
                return;
              }
              const totalUA = calcUA(ui.fd.pesoMedio, ui.fd.quantidade);
              if (ui.sel) {
                setData({ ...data, lot: data.lot.map(l => l.id === ui.sel.id ? { ...l, ...ui.fd, totalUA } : l) });
                setUi({ ...ui, st: '‚úÖ Lote atualizado com sucesso.' });
              } else {
                setData({ ...data, lot: [...data.lot, { ...ui.fd, id: gid(), fazendaId: data.fa, status: 'livre', totalUA }] });
                setUi({ ...ui, st: '‚úÖ Lote criado com sucesso.' });
              }
              setTimeout(() => setUi(u => ({ ...u, st: '' })), 3000);
              setUi({ ...ui, modal: null, sel: null });
            }} className="flex-1 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">{ui.sel ? 'Atualizar' : 'Criar'}</button>
          </div>
        </div>
      </div>
    </div>}

    {ui.modal === 'piquete-info' && ui.sel && (() => {
      const lote = ui.sel.loteAtualId ? lotF.find(l => l.id === ui.sel.loteAtualId) : null;
      const modulo = ui.sel.moduloId ? modF.find(m => m.id === ui.sel.moduloId) : null;
      const outrosPiquetes = piqF.filter(p => p.id !== ui.sel.id && !p.ehReserva);
      
      return <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div className="bg-white rounded-lg p-4 max-w-md w-full max-h-[90vh] overflow-y-auto">
          <div className="flex justify-between items-center mb-3">
            <h2 className="text-lg font-bold">{ui.sel.nome}</h2>
            <button onClick={() => setUi({ ...ui, modal: null, sel: null, fd: {} })} className="text-gray-500 hover:text-gray-700">
              <X size={20} />
            </button>
          </div>
          <div className="space-y-2 mb-4">
            <div className="flex justify-between">
              <span className="text-gray-600">√Årea:</span>
              <span className="font-bold">{ui.sel.area} ha</span>
            </div>
            {modulo && <div className="flex justify-between">
              <span className="text-gray-600">M√≥dulo:</span>
              <span className="font-bold text-purple-600">{modulo.nome}</span>
            </div>}
            {lote && <>
              <div className="flex justify-between">
                <span className="text-gray-600">Lote:</span>
                <span className="font-bold text-green-600">{lote.nome}</span>
              </div>
              <div className="flex justify-between">
                <span className="text-gray-600">Animais:</span>
                <span className="font-bold">{lote.quantidade}</span>
              </div>
              <div className="flex justify-between">
                <span className="text-gray-600">Total UA:</span>
                <span className="font-bold">{lote.totalUA}</span>
              </div>
            </>}
            <div className="flex justify-between">
              <span className="text-gray-600">Status:</span>
              <span className={`font-bold ${lote ? 'text-green-600' : 'text-blue-600'}`}>
                {lote ? '‚úÖ Ocupado' : 'üîµ Livre'}
              </span>
            </div>
            {!lote && <div className="text-sm text-gray-500">Dias vazio: {calcDias(ui.sel.dataSaida || ui.sel.dataCriacao)}</div>}
          </div>

          {lote && <div className="mb-4">
            <button onClick={() => {
              const hist = {
                id: gid(),
                fazendaId: data.fa,
                tipo: 'saida',
                loteId: lote.id,
                piqueteId: ui.sel.id,
                data: new Date().toISOString(),
                descricao: `Lote ${lote.nome} removido de ${ui.sel.nome}`
              };
              setData({
                ...data,
                piq: data.piq.map(p => p.id === ui.sel.id ? { ...p, loteAtualId: null, dataSaida: new Date().toISOString() } : p),
                lot: data.lot.map(l => l.id === lote.id ? { ...l, status: 'livre', piqueteAtual: null } : l),
                his: [...data.his, hist]
              });
              setUi({ ...ui, modal: null, sel: null, st: '‚úÖ Lote removido do piquete com sucesso.' });
              setTimeout(() => setUi(u => ({ ...u, st: '' })), 3000);
            }} className="w-full bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600 font-semibold mb-2 flex items-center justify-center gap-2">
              <ArrowRightLeft size={18} />
              Retirar Lote
            </button>

            <p className="text-sm font-semibold text-gray-700 mb-2">üîÑ Trocar para outro piquete:</p>
            {outrosPiquetes.filter(p => !p.loteAtualId).map(p => {
              const pMod = p.moduloId ? modF.find(m => m.id === p.moduloId) : null;
              return <button key={p.id} onClick={() => {
                const hist = {
                  id: gid(),
                  fazendaId: data.fa,
                  tipo: 'troca',
                  loteId: lote.id,
                  piqueteId: p.id,
                  piqueteAnteriorId: ui.sel.id,
                  data: new Date().toISOString(),
                  descricao: `Lote ${lote.nome} movido de ${ui.sel.nome} para ${p.nome}${pMod ? ` (${pMod.nome})` : ''}`
                };
                setData({
                  ...data,
                  piq: data.piq.map(pq => 
                    pq.id === ui.sel.id ? { ...pq, loteAtualId: null, dataSaida: new Date().toISOString() } :
                    pq.id === p.id ? { ...pq, loteAtualId: lote.id, dataEntrada: new Date().toISOString() } : pq
                  ),
                  lot: data.lot.map(l => l.id === lote.id ? { ...l, piqueteAtual: p.id } : l),
                  his: [...data.his, hist]
                });
                setUi({ ...ui, modal: null, sel: null, st: '‚úÖ Gado movido com sucesso.' });
                setTimeout(() => setUi(u => ({ ...u, st: '' })), 3000);
              }} className="w-full bg-blue-600 text-white px-3 py-2 rounded hover:bg-blue-700 text-sm mb-2 flex items-center justify-between">
                <span>{p.nome} {pMod && `(${pMod.nome})`}</span>
                <span className="text-xs">{p.area}ha</span>
              </button>;
            })}
          </div>}

          {!lote && <div>
            <p className="text-sm font-semibold text-gray-700 mb-2">üêÑ Alocar lote:</p>
            {lotF.filter(l => l.status === 'livre').length === 0 ? <p className="text-sm text-gray-500 italic">Nenhum lote dispon√≠vel</p> :
              lotF.filter(l => l.status === 'livre').map(l => <button key={l.id} onClick={() => {
                const hist = {
                  id: gid(),
                  fazendaId: data.fa,
                  tipo: 'entrada',
                  loteId: l.id,
                  piqueteId: ui.sel.id,
                  data: new Date().toISOString(),
                  descricao: `Lote ${l.nome} alocado em ${ui.sel.nome}`
                };
                setData({
                  ...data,
                  piq: data.piq.map(p => p.id === ui.sel.id ? { ...p, loteAtualId: l.id, dataEntrada: new Date().toISOString() } : p),
                  lot: data.lot.map(lo => lo.id === l.id ? { ...lo, status: 'alocado', piqueteAtual: ui.sel.id } : lo),
                  his: [...data.his, hist]
                });
                setUi({ ...ui, modal: null, sel: null, st: '‚úÖ Lote alocado com sucesso.' });
                setTimeout(() => setUi(u => ({ ...u, st: '' })), 3000);
              }} className="w-full bg-green-600 text-white px-3 py-2 rounded hover:bg-green-700 text-sm mb-2 flex items-center justify-between">
                <span>üêÑ {l.nome}</span>
                <span className="text-xs">{l.quantidade} cab | {l.totalUA} UA</span>
              </button>)}
          </div>}
        </div>
      </div>;
    })()}

    {ui.modal === 'troca-lote' && ui.sel && (() => {
      const modulo = ui.sel.moduloId ? modF.find(m => m.id === ui.sel.moduloId) : null;
      const lotesMesmoMod = modulo ? lotF.filter(l => l.piqueteAtual && piqF.find(p => p.id === l.piqueteAtual && p.moduloId === modulo.id && p.id !== ui.sel.id)) : [];
      const lotesOutros = lotF.filter(l => l.piqueteAtual && (!modulo || piqF.find(p => p.id === l.piqueteAtual && p.moduloId !== modulo.id)));
      const lotesLivres = lotF.filter(l => l.status === 'livre');
      
      return <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div className="bg-white rounded-lg p-4 max-w-md w-full max-h-[90vh] overflow-y-auto">
          <div className="flex justify-between items-center mb-3">
            <h2 className="text-lg font-bold">{ui.sel.nome} ({ui.sel.area}ha)</h2>
            <button onClick={() => setUi({ ...ui, modal: null, sel: null, fd: {} })} className="text-gray-500 hover:text-gray-700">
              <X size={20} />
            </button>
          </div>

          {ui.sel.loteAtualId ? <>
            {(() => {
              const l = lotF.find(l => l.id === ui.sel.loteAtualId);
              if (!l) return null;
              return <div className="mb-4 p-3 bg-green-50 rounded">
                <div className="font-bold text-green-800">Lote Atual: {l.nome}</div>
                <div className="text-sm text-gray-600">{l.quantidade} cabe√ßas | {l.totalUA} UA</div>
              </div>;
            })()}

            <div className="mb-2">
              <p className="text-sm font-semibold text-gray-700 mb-2">üîÑ Trocar gado para outro piquete:</p>
              {modulo && <p className="text-xs text-gray-600 mb-2">Piquetes do {modulo.nome}:</p>}
              {modulo && lotesMesmoMod.length === 0 && <p className="text-sm text-gray-500 italic mb-2">Nenhum lote dispon√≠vel neste m√≥dulo</p>}
              {modulo && lotesMesmoMod.map(l => {
                const piqAtual = piqF.find(p => p.id === l.piqueteAtual);
                return <button key={l.id} onClick={() => {
                  const hist = {
                    id: gid(),
                    fazendaId: data.fa,
                    tipo: 'troca',
                    loteId: ui.sel.loteAtualId,
                    piqueteId: piqAtual.id,
                    piqueteAnteriorId: ui.sel.id,
                    data: new Date().toISOString(),
                    descricao: `Lote ${l.nome} movido de ${ui.sel.nome} para ${piqAtual.nome}`
                  };
                  setData({
                    ...data,
                    piq: data.piq.map(p => 
                      p.id === ui.sel.id ? { ...p, loteAtualId: null, dataSaida: new Date().toISOString() } :
                      p.id === piqAtual.id ? { ...p, loteAtualId: ui.sel.loteAtualId, dataEntrada: new Date().toISOString() } : p
                    ),
                    lot: data.lot.map(lo => lo.id === ui.sel.loteAtualId ? { ...lo, piqueteAtual: piqAtual.id } : lo),
                    his: [...data.his, hist]
                  });
                  setUi({ ...ui, modal: null, sel: null, st: '‚úÖ Gado movido com sucesso.' });
                  setTimeout(() => setUi(u => ({ ...u, st: '' })), 3000);
                }} className="w-full bg-blue-500 text-white px-3 py-2 rounded hover:bg-blue-600 text-sm mb-2 flex items-center justify-between">
                  <span>{piqAtual.nome}</span>
                  <span className="text-xs">{piqAtual.area}ha</span>
                </button>;
              })}
            </div>
          </> : <>
            <p className="text-sm font-semibold text-gray-700 mb-2">üêÑ Alocar gado aqui:</p>
            {modulo && lotesMesmoMod.length > 0 && <>
              <p className="text-xs text-gray-600 mb-2">Lotes do {modulo.nome}:</p>
              {lotesMesmoMod.map(l => {
                const piqAtual = piqF.find(p => p.id === l.piqueteAtual);
                return <button key={l.id} onClick={() => {
                  const hist = {
                    id: gid(),
                    fazendaId: data.fa,
                    tipo: 'troca',
                    loteId: l.id,
                    piqueteId: ui.sel.id,
                    piqueteAnteriorId: l.piqueteAtual,
                    data: new Date().toISOString(),
                    descricao: `Lote ${l.nome} movido de ${piqAtual?.nome} para ${ui.sel.nome}`
                  };
                  setData({
                    ...data,
                    piq: data.piq.map(p => 
                      p.id === l.piqueteAtual ? { ...p, loteAtualId: null, dataSaida: new Date().toISOString() } :
                      p.id === ui.sel.id ? { ...p, loteAtualId: l.id, dataEntrada: new Date().toISOString() } : p
                    ),
                    lot: data.lot.map(lo => lo.id === l.id ? { ...lo, piqueteAtual: ui.sel.id } : lo),
                    his: [...data.his, hist]
                  });
                  setUi({ ...ui, modal: null, sel: null, st: '‚úÖ Gado alocado com sucesso.' });
                  setTimeout(() => setUi(u => ({ ...u, st: '' })), 3000);
                }} className="w-full bg-green-600 text-white px-3 py-2 rounded hover:bg-green-700 text-sm mb-2 flex items-center justify-between">
                  <span>üêÑ {l.nome}</span>
                  <span className="text-xs">{l.quantidade} cab ‚Üí {piqAtual?.nome}</span>
                </button>;
              })}
            </>}
            
            {lotesLivres.length > 0 && <>
              <p className="text-xs text-gray-600 mb-2">Lotes livres:</p>
              {lotesLivres.map(l => <button key={l.id} onClick={() => {
                const hist = {
                  id: gid(),
                  fazendaId: data.fa,
                  tipo: 'entrada',
                  loteId: l.id,
                  piqueteId: ui.sel.id,
                  data: new Date().toISOString(),
                  descricao: `Lote ${l.nome} alocado em ${ui.sel.nome}`
                };
                setData({
                  ...data,
                  piq: data.piq.map(p => p.id === ui.sel.id ? { ...p, loteAtualId: l.id, dataEntrada: new Date().toISOString() } : p),
                  lot: data.lot.map(lo => lo.id === l.id ? { ...lo, status: 'alocado', piqueteAtual: ui.sel.id } : lo),
                  his: [...data.his, hist]
                });
                setUi({ ...ui, modal: null, sel: null, st: '‚úÖ Gado alocado com sucesso.' });
                setTimeout(() => setUi(u => ({ ...u, st: '' })), 3000);
              }} className="w-full bg-green-600 text-white px-3 py-2 rounded hover:bg-green-700 text-sm mb-2 flex items-center justify-between">
                <span>üêÑ {l.nome}</span>
                <span className="text-xs">{l.quantidade} cab | {l.totalUA} UA</span>
              </button>)}
            </>}
            
            {(lotesOutros.length > 0 || (modulo && lotesOutros.length > 0)) && <>
              <button onClick={() => setUi({ ...ui, fd: { ...ui.fd, showOthers: !ui.fd.showOthers } })} className="w-full bg-gray-200 text-gray-700 px-3 py-2 rounded hover:bg-gray-300 text-sm mb-2 flex items-center justify-center gap-2">
                {ui.fd.showOthers ? 'Ocultar outros m√≥dulos' : 'Trazer de outro m√≥dulo'}
                {ui.fd.showOthers ? <ChevronUp size={16} /> : <ChevronDown size={16} />}
              </button>
              {ui.fd.showOthers && lotesOutros.map(l => {
                const piqAtual = piqF.find(p => p.id === l.piqueteAtual);
                const pMod = piqAtual?.moduloId ? modF.find(m => m.id === piqAtual.moduloId) : null;
                return <button key={l.id} onClick={() => {
                  const hist = {
                    id: gid(),
                    fazendaId: data.fa,
                    tipo: 'troca',
                    loteId: l.id,
                    piqueteId: ui.sel.id,
                    piqueteAnteriorId: l.piqueteAtual,
                    data: new Date().toISOString(),
                    descricao: `Lote ${l.nome} movido de ${piqAtual?.nome}${pMod ? ` (${pMod.nome})` : ''} para ${ui.sel.nome}`
                  };
                  setData({
                    ...data,
                    piq: data.piq.map(p => 
                      p.id === l.piqueteAtual ? { ...p, loteAtualId: null, dataSaida: new Date().toISOString() } :
                      p.id === ui.sel.id ? { ...p, loteAtualId: l.id, dataEntrada: new Date().toISOString() } : p
                    ),
                    lot: data.lot.map(lo => lo.id === l.id ? { ...lo, piqueteAtual: ui.sel.id } : lo),
                    his: [...data.his, hist]
                  });
                  setUi({ ...ui, modal: null, sel: null, st: '‚úÖ Gado alocado com sucesso.' });
                  setTimeout(() => setUi(u => ({ ...u, st: '' })), 3000);
                }} className="w-full bg-green-500 text-white px-3 py-2 rounded hover:bg-green-600 text-sm mb-2 flex items-center justify-between">
                  <span>üêÑ {l.nome} {pMod && `(${pMod.nome})`}</span>
                  <span className="text-xs">{l.quantidade} cab ‚Üí {piqAtual?.nome}</span>
                </button>;
              })}
            </>}
            
            {lotesMesmoMod.length === 0 && lotesLivres.length === 0 && lotesOutros.length === 0 && <p className="text-sm text-gray-500 italic">Nenhum lote dispon√≠vel</p>}
          </>}

        </div>
      </div>;
    })()}



    {ui.modal === 'lote-info' && ui.sel && (() => {
      const piqAtual = ui.sel.piqueteAtual ? piqF.find(p => p.id === ui.sel.piqueteAtual) : null;
      const modulo = piqAtual?.moduloId ? modF.find(m => m.id === piqAtual.moduloId) : null;
      const piqsMesmoMod = modulo ? piqF.filter(p => p.moduloId === modulo.id && !p.loteAtualId && p.id !== ui.sel.piqueteAtual && !p.ehReserva) : [];
      const piqsOutros = piqF.filter(p => (!modulo || p.moduloId !== modulo.id) && !p.loteAtualId && p.id !== ui.sel.piqueteAtual && !p.ehReserva);
      
      return <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div className="bg-white rounded-lg p-4 max-w-md w-full max-h-[90vh] overflow-y-auto">
          <div className="flex justify-between items-center mb-3">
            <h2 className="text-lg font-bold">{ui.sel.nome}</h2>
            <button onClick={() => setUi({ ...ui, modal: null, sel: null, fd: {} })} className="text-gray-500 hover:text-gray-700">
              <X size={20} />
            </button>
          </div>
          <div className="space-y-2 mb-4">
            <div className="flex justify-between">
              <span className="text-gray-600">Categoria:</span>
              <span className="font-bold">{ui.sel.categoria}</span>
            </div>
            <div className="flex justify-between">
              <span className="text-gray-600">Quantidade:</span>
              <span className="font-bold">{ui.sel.quantidade} cabe√ßas</span>
            </div>
            <div className="flex justify-between">
              <span className="text-gray-600">Peso M√©dio:</span>
              <span className="font-bold">{ui.sel.pesoMedio}kg</span>
            </div>
            <div className="flex justify-between">
              <span className="text-gray-600">Total UA:</span>
              <span className="font-bold">{ui.sel.totalUA}</span>
            </div>
            {ui.sel.piqueteAtual && <>
              <div className="flex justify-between">
                <span className="text-gray-600">Piquete Atual:</span>
                <span className="font-bold text-green-600">{piqAtual?.nome}</span>
              </div>
              {modulo && <div className="flex justify-between">
                <span className="text-gray-600">M√≥dulo:</span>
                <span className="font-bold text-purple-600">{modulo.nome}</span>
              </div>}
            </>}
            <div className="flex justify-between">
              <span className="text-gray-600">Status:</span>
              <span className={`font-bold ${ui.sel.status === 'livre' ? 'text-yellow-600' : 'text-green-600'}`}>
                {ui.sel.status === 'livre' ? 'üü° Livre' : '‚úÖ Alocado'}
              </span>
            </div>
          </div>

          {ui.sel.status === 'alocado' && ui.sel.piqueteAtual && <>
            <button onClick={() => {
              const piq = piqF.find(p => p.id === ui.sel.piqueteAtual);
              const hist = {
                id: gid(),
                fazendaId: data.fa,
                tipo: 'saida',
                loteId: ui.sel.id,
                piqueteId: ui.sel.piqueteAtual,
                data: new Date().toISOString(),
                descricao: `Lote ${ui.sel.nome} removido de ${piq?.nome}`
              };
              setData({
                ...data,
                piq: data.piq.map(p => p.id === ui.sel.piqueteAtual ? { ...p, loteAtualId: null, dataSaida: new Date().toISOString() } : p),
                lot: data.lot.map(l => l.id === ui.sel.id ? { ...l, status: 'livre', piqueteAtual: null } : l),
                his: [...data.his, hist]
              });
              setUi({ ...ui, modal: null, sel: null, st: '‚úÖ Lote removido do piquete com sucesso.' });
              setTimeout(() => setUi(u => ({ ...u, st: '' })), 3000);
            }} className="w-full bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600 font-semibold mb-2 flex items-center justify-center gap-2">
              <ArrowRightLeft size={18} />
              Retirar do Piquete
            </button>

            <div className="mb-2">
              <p className="text-sm font-semibold text-gray-700 mb-2">üîÑ Trocar para outro piquete:</p>
              {modulo && <p className="text-xs text-gray-600 mb-2">üìç Piquetes do {modulo.nome}:</p>}
              {modulo && piqsMesmoMod.length === 0 && <p className="text-sm text-gray-500 italic mb-2">Nenhum piquete vazio neste m√≥dulo</p>}
              {modulo && piqsMesmoMod.map(p => <button key={p.id} onClick={() => {
                const piqAntigo = piqF.find(pq => pq.id === ui.sel.piqueteAtual);
                const hist = {
                  id: gid(),
                  fazendaId: data.fa,
                  tipo: 'troca',
                  loteId: ui.sel.id,
                  piqueteId: p.id,
                  piqueteAnteriorId: ui.sel.piqueteAtual,
                  data: new Date().toISOString(),
                  descricao: `Lote ${ui.sel.nome} movido de ${piqAntigo?.nome} para ${p.nome}`
                };
                setData({
                  ...data,
                  piq: data.piq.map(pq => 
                    pq.id === ui.sel.piqueteAtual ? { ...pq, loteAtualId: null, dataSaida: new Date().toISOString() } :
                    pq.id === p.id ? { ...pq, loteAtualId: ui.sel.id, dataEntrada: new Date().toISOString() } : pq
                  ),
                  lot: data.lot.map(l => l.id === ui.sel.id ? { ...l, piqueteAtual: p.id } : l),
                  his: [...data.his, hist]
                });
                setUi({ ...ui, modal: null, sel: null, st: '‚úÖ Gado movido com sucesso.' });
                setTimeout(() => setUi(u => ({ ...u, st: '' })), 3000);
              }} className="w-full bg-blue-600 text-white px-3 py-2 rounded hover:bg-blue-700 text-sm mb-2 flex items-center justify-between">
                <span>{p.nome}</span>
                <span className="text-xs">{p.area}ha ‚ö™ {calcDias(p.dataSaida || p.dataCriacao)}d</span>
              </button>)}
              
              {piqsOutros.length > 0 && <>
                <button onClick={() => setUi({ ...ui, fd: { ...ui.fd, showOthers: !ui.fd.showOthers } })} className="w-full bg-gray-200 text-gray-700 px-3 py-2 rounded hover:bg-gray-300 text-sm mb-2 flex items-center justify-center gap-2">
                  {ui.fd.showOthers ? 'Ocultar outros m√≥dulos' : 'Ver outros m√≥dulos'}
                  {ui.fd.showOthers ? <ChevronUp size={16} /> : <ChevronDown size={16} />}
                </button>
                {ui.fd.showOthers && piqsOutros.map(p => {
                  const pMod = p.moduloId ? modF.find(m => m.id === p.moduloId) : null;
                  return <button key={p.id} onClick={() => {
                    const piqAntigo = piqF.find(pq => pq.id === ui.sel.piqueteAtual);
                    const hist = {
                      id: gid(),
                      fazendaId: data.fa,
                      tipo: 'troca',
                      loteId: ui.sel.id,
                      piqueteId: p.id,
                      piqueteAnteriorId: ui.sel.piqueteAtual,
                      data: new Date().toISOString(),
                      descricao: `Lote ${ui.sel.nome} movido de ${piqAntigo?.nome} para ${p.nome}${pMod ? ` (${pMod.nome})` : ''}`
                    };
                    setData({
                      ...data,
                      piq: data.piq.map(pq => 
                        pq.id === ui.sel.piqueteAtual ? { ...pq, loteAtualId: null, dataSaida: new Date().toISOString() } :
                        pq.id === p.id ? { ...pq, loteAtualId: ui.sel.id, dataEntrada: new Date().toISOString() } : pq
                      ),
                      lot: data.lot.map(l => l.id === ui.sel.id ? { ...l, piqueteAtual: p.id } : l),
                      his: [...data.his, hist]
                    });
                    setUi({ ...ui, modal: null, sel: null, st: '‚úÖ Gado movido com sucesso.' });
                    setTimeout(() => setUi(u => ({ ...u, st: '' })), 3000);
                  }} className="w-full bg-blue-500 text-white px-3 py-2 rounded hover:bg-blue-600 text-sm mb-2 flex items-center justify-between">
                    <span>{p.nome} {pMod && `(${pMod.nome})`}</span>
                    <span className="text-xs">{p.area}ha</span>
                  </button>;
                })}
              </>}
            </div>
          </>}

          {ui.sel.status === 'livre' && <div className="mb-2">
            <p className="text-sm font-semibold text-gray-700 mb-2">üêÑ Alocar em piquete:</p>
            {piqF.filter(p => !p.ehReserva && !p.loteAtualId).length === 0 ? <p className="text-sm text-gray-500 italic">Nenhum piquete dispon√≠vel</p> :
              piqF.filter(p => !p.ehReserva && !p.loteAtualId).map(p => {
                const pMod = p.moduloId ? modF.find(m => m.id === p.moduloId) : null;
                return <button key={p.id} onClick={() => {
                  const hist = {
                    id: gid(),
                    fazendaId: data.fa,
                    tipo: 'entrada',
                    loteId: ui.sel.id,
                    piqueteId: p.id,
                    data: new Date().toISOString(),
                    descricao: `Lote ${ui.sel.nome} alocado em ${p.nome}${pMod ? ` (${pMod.nome})` : ''}`
                  };
                  setData({
                    ...data,
                    piq: data.piq.map(pq => pq.id === p.id ? { ...pq, loteAtualId: ui.sel.id, dataEntrada: new Date().toISOString() } : pq),
                    lot: data.lot.map(l => l.id === ui.sel.id ? { ...l, status: 'alocado', piqueteAtual: p.id } : l),
                    his: [...data.his, hist]
                  });
                  setUi({ ...ui, modal: null, sel: null, st: '‚úÖ Lote alocado com sucesso.' });
                  setTimeout(() => setUi(u => ({ ...u, st: '' })), 3000);
                }} className="w-full bg-green-600 text-white px-3 py-2 rounded hover:bg-green-700 text-sm mb-2 flex items-center justify-between">
                  <span>{p.nome} {pMod && `(${pMod.nome})`}</span>
                  <span className="text-xs">{p.area}ha</span>
                </button>;
              })}
          </div>}

          <button onClick={() => {
            const dataVenda = prompt('Data da venda (DD/MM/AAAA):');
            if (!dataVenda) return;
            if (ui.sel.status === 'alocado') {
              const piq = piqF.find(p => p.id === ui.sel.piqueteAtual);
              const hist = {
                id: gid(),
                fazendaId: data.fa,
                tipo: 'venda',
                loteId: ui.sel.id,
                piqueteId: ui.sel.piqueteAtual,
                data: new Date().toISOString(),
                descricao: `Lote ${ui.sel.nome} vendido (estava em ${piq?.nome}) - Data: ${dataVenda}`
              };
              setData({
                ...data,
                piq: data.piq.map(p => p.id === ui.sel.piqueteAtual ? { ...p, loteAtualId: null, dataSaida: new Date().toISOString() } : p),
                lot: data.lot.map(l => l.id === ui.sel.id ? { ...l, status: 'vendido', piqueteAtual: null, dataVenda } : l),
                his: [...data.his, hist]
              });
            } else {
              const hist = {
                id: gid(),
                fazendaId: data.fa,
                tipo: 'venda',
                loteId: ui.sel.id,
                data: new Date().toISOString(),
                descricao: `Lote ${ui.sel.nome} vendido - Data: ${dataVenda}`
              };
              setData({
                ...data,
                lot: data.lot.map(l => l.id === ui.sel.id ? { ...l, status: 'vendido', dataVenda } : l),
                his: [...data.his, hist]
              });
            }
            setUi({ ...ui, modal: null, sel: null, st: '‚úÖ Lote vendido com sucesso.' });
            setTimeout(() => setUi(u => ({ ...u, st: '' })), 3000);
          }} className="w-full bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 font-semibold mb-2 flex items-center justify-center gap-2">
            <DollarSign size={18} />
            Vender Lote
          </button>

          <button onClick={() => {
            if (ui.sel.status === 'alocado') {
              alert('Remova o lote do piquete antes de deletar');
              return;
            }
            if (confirm('Deletar este lote permanentemente?')) {
              setData({ ...data, lot: data.lot.filter(l => l.id !== ui.sel.id) });
              setUi({ ...ui, modal: null, sel: null, st: '‚úÖ Lote exclu√≠do com sucesso.' });
              setTimeout(() => setUi(u => ({ ...u, st: '' })), 3000);
            }
          }} className="w-full bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 font-semibold">
            Deletar Lote
          </button>
        </div>
      </div>;
    })()}

  </div>;
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
