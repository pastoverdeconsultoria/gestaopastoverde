<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,user-scalable=yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Manager Pro v2.9.0 - Gestão de Pastagem</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <style>
    /* evita “altura zero” em alguns cenários */
    html, body { height: 100%; }
  </style>
</head>
<body class="bg-slate-50">
  <div id="root"></div>

  <script>
  const { useEffect, useMemo, useRef, useState } = React;

  const fmt = n => (Number.isFinite(+n) ? (+n).toLocaleString('pt-BR', { maximumFractionDigits: 2 }) : "-");

  const uid = () => Math.random().toString(16).slice(2) + Date.now().toString(16);

  // ---- Geometria básica (sem libs) ----
  const polygonAreaMeters2 = (coordsLngLat) => {
    // coordsLngLat: [[lng,lat],...]
    if (!Array.isArray(coordsLngLat) || coordsLngLat.length < 3) return 0;

    // projeção equiretangular local (aprox) para área
    const R = 6378137;
    const lats = coordsLngLat.map(c => +c[1]).filter(Number.isFinite);
    const lat0 = (lats.reduce((a,b)=>a+b,0) / Math.max(1,lats.length)) * Math.PI/180;

    const pts = coordsLngLat.map(([lng,lat]) => {
      const x = (lng * Math.PI/180) * R * Math.cos(lat0);
      const y = (lat * Math.PI/180) * R;
      return [x,y];
    });

    let area = 0;
    for (let i=0; i<pts.length; i++){
      const [x1,y1] = pts[i];
      const [x2,y2] = pts[(i+1)%pts.length];
      area += (x1*y2 - x2*y1);
    }
    return Math.abs(area)/2;
  };

  const centroidLngLat = (coordsLngLat) => {
    // centróide simples (média) - suficiente para labels/seleção
    if (!Array.isArray(coordsLngLat) || !coordsLngLat.length) return [0,0];
    let sx=0, sy=0, c=0;
    for (const [lng,lat] of coordsLngLat){
      const L = +lng, A = +lat;
      if (!Number.isFinite(L) || !Number.isFinite(A)) continue;
      sx += L; sy += A; c++;
    }
    return c ? [sx/c, sy/c] : [0,0];
  };

  // ---- KML Parser (polígonos) ----
  // Retorna:
  //  piq = [{ id, name, coordinates: [ [ [lng,lat], ... ] ] }]
  //  bounds = {minLng,maxLng,minLat,maxLat,width,height}
  const parseKML = t => {
    const parser = new DOMParser();
    const xml = parser.parseFromString(t, "text/xml");

    const placemarks = Array.from(xml.getElementsByTagName("Placemark"));
    const piq = [];

    let minLng = Infinity, maxLng = -Infinity, minLat = Infinity, maxLat = -Infinity;

    for (const pm of placemarks){
      const nameNode = pm.getElementsByTagName("name")[0];
      const name = nameNode ? nameNode.textContent.trim() : "Sem nome";

      // Polygon -> coordinates
      const coordNodes = Array.from(pm.getElementsByTagName("coordinates"));
      if (!coordNodes.length) continue;

      // pega o primeiro conjunto de coordenadas do placemark
      const raw = coordNodes[0].textContent.trim();
      if (!raw) continue;

      // coord string: "lng,lat,alt lng,lat,alt ..."
      const ring = raw
        .split(/\s+/)
        .map(s => s.trim())
        .filter(Boolean)
        .map(s => s.split(","))
        .map(a => [parseFloat(a[0]), parseFloat(a[1])])
        .filter(([lng,lat]) => Number.isFinite(lng) && Number.isFinite(lat));

      if (ring.length < 3) continue;

      for (const [lng,lat] of ring){
        if (lng < minLng) minLng = lng;
        if (lng > maxLng) maxLng = lng;
        if (lat < minLat) minLat = lat;
        if (lat > maxLat) maxLat = lat;
      }

      piq.push({ id: uid(), name, coordinates: [ ring ] });
    }

    const width = (maxLng - minLng) || 1e-9;
    const height = (maxLat - minLat) || 1e-9;

    const bounds = (Number.isFinite(minLng) && Number.isFinite(maxLng) && Number.isFinite(minLat) && Number.isFinite(maxLat))
      ? { minLng, maxLng, minLat, maxLat, width, height }
      : null;

    return { piq, bounds };
  };

  const calcBoundsFromPiq = (piq) => {
    // Fallback se bounds sumirem (ex.: payload antigo no localStorage)
    let minLng = Infinity, maxLng = -Infinity, minLat = Infinity, maxLat = -Infinity;
    for (const p of (piq||[])) {
      for (const ring of (p.coordinates||[])) {
        for (const c of (ring||[])) {
          const lng = +c[0], lat = +c[1];
          if (!Number.isFinite(lng) || !Number.isFinite(lat)) continue;
          if (lng < minLng) minLng = lng;
          if (lng > maxLng) maxLng = lng;
          if (lat < minLat) minLat = lat;
          if (lat > maxLat) maxLat = lat;
        }
      }
    }
    if (!Number.isFinite(minLng) || !Number.isFinite(maxLng) || !Number.isFinite(minLat) || !Number.isFinite(maxLat)) return null;
    const width = (maxLng - minLng) || 1e-9;
    const height = (maxLat - minLat) || 1e-9;
    return { minLng, maxLng, minLat, maxLat, width, height };
  };

  const projC = (lng,lat,b) => {
    if (!b) return [0,0];
    const x = ((lng - b.minLng) / b.width) * 1000;
    const y = (1 - (lat - b.minLat) / b.height) * 800;
    return [x,y];
  };

  const getPath = (rings, b) => {
    if (!b || !Array.isArray(rings) || !rings.length) return "";
    const ring = rings[0];
    if (!ring || ring.length < 2) return "";
    let d = "";
    ring.forEach((c, i) => {
      const [x,y] = projC(c[0], c[1], b);
      d += (i===0 ? `M ${x} ${y}` : ` L ${x} ${y}`);
    });
    d += " Z";
    return d;
  };

  // ---- App ----
  function App(){
    const [data, setData] = useState(() => {
      try{
        const raw = localStorage.getItem('pastureSystem');
        if (raw) return JSON.parse(raw);
      }catch(e){}
      return {
        farm: "",
        city: "",
        piq: [],   // piquetes do KML
        mb: null,  // bounds do mapa
        lots: [],  // lotes
        notes: "", // anotações
      };
    });

    const [ui, setUI] = useState({
      tab: "mapa",
      selectedPiqId: null,
      selectedLotId: null,
      modal: null
    });

    // Persistência
    useEffect(() => {
      localStorage.setItem('pastureSystem', JSON.stringify(data));
    }, [data]);

    // Repara bounds ausente (ex.: dados antigos no localStorage)
    useEffect(() => {
      if (!data.mb && Array.isArray(data.piq) && data.piq.length) {
        const b = calcBoundsFromPiq(data.piq);
        if (b) setData(prev => ({ ...prev, mb: b }));
      }
    }, [data.mb, data.piq]);

    const svgRef = useRef(null);

    const piqF = useMemo(() => data.piq || [], [data.piq]);

    const selectedPiq = useMemo(
      () => piqF.find(p => p.id === ui.selectedPiqId) || null,
      [piqF, ui.selectedPiqId]
    );

    const lots = useMemo(() => data.lots || [], [data.lots]);
    const selectedLot = useMemo(
      () => lots.find(l => l.id === ui.selectedLotId) || null,
      [lots, ui.selectedLotId, data.lots]
    );

    const totalAreaHa = useMemo(() => {
      let sum = 0;
      for (const p of piqF){
        const ring = p.coordinates?.[0] || [];
        const m2 = polygonAreaMeters2(ring);
        sum += (m2 / 10000);
      }
      return sum;
    }, [piqF]);

    const hKML = e => {
      const file = e?.target?.files?.[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = ev => {
        try{
          const txt = String(ev.target.result || "");
          const { piq, bounds } = parseKML(txt);

          if (!piq.length) {
            alert("Nao consegui ler o KML (nenhum poligono encontrado). Confirme se o arquivo tem poligonos e coordenadas.");
            return;
          }

          setData(prev => ({
            ...prev,
            piq,
            mb: bounds || calcBoundsFromPiq(piq) || prev.mb,
          }));
        }catch(err){
          console.error(err);
          alert("Erro ao ler o KML. Se for KMZ, extraia para KML e tente novamente.");
        }
      };
      reader.readAsText(file);
    };

    const addLot = () => {
      const id = uid();
      setData(prev => ({
        ...prev,
        lots: [
          ...(prev.lots||[]),
          {
            id,
            name: `Lote ${((prev.lots||[]).length)+1}`,
            heads: "",
            entryDate: "",
            exitDate: "",
            gmd: "",
            notes: "",
            piquetes: [] // ids dos piquetes
          }
        ]
      }));
      setUI(prev => ({...prev, tab:"lotes", selectedLotId: id}));
    };

    const updLot = (id, patch) => {
      setData(prev => ({
        ...prev,
        lots: (prev.lots||[]).map(l => l.id===id ? ({...l, ...patch}) : l)
      }));
    };

    const delLot = (id) => {
      if (!confirm("Excluir este lote?")) return;
      setData(prev => ({...prev, lots: (prev.lots||[]).filter(l => l.id!==id)}));
      setUI(prev => ({...prev, selectedLotId: prev.selectedLotId===id ? null : prev.selectedLotId}));
    };

    const toggleLotPiq = (lotId, piqId) => {
      setData(prev => ({
        ...prev,
        lots: (prev.lots||[]).map(l => {
          if (l.id !== lotId) return l;
          const set = new Set(l.piquetes||[]);
          if (set.has(piqId)) set.delete(piqId); else set.add(piqId);
          return { ...l, piquetes: Array.from(set) };
        })
      }));
    };

    const lotAreaHa = (lot) => {
      const set = new Set(lot.piquetes||[]);
      let sum = 0;
      for (const p of piqF){
        if (!set.has(p.id)) continue;
        const ring = p.coordinates?.[0] || [];
        const m2 = polygonAreaMeters2(ring);
        sum += (m2 / 10000);
      }
      return sum;
    };

    const onPickPiq = (id) => {
      setUI(prev => ({...prev, selectedPiqId: id}));
    };

    return (
      React.createElement("div", {className:"min-h-screen"},
        React.createElement("header", {className:"sticky top-0 z-10 bg-white border-b border-slate-200"},
          React.createElement("div", {className:"max-w-6xl mx-auto px-4 py-3 flex flex-col gap-2"},
            React.createElement("div", {className:"flex items-center justify-between gap-3"},
              React.createElement("div", null,
                React.createElement("div", {className:"text-lg font-bold text-slate-900"}, "Manager Pro v2.9.0"),
                React.createElement("div", {className:"text-xs text-slate-500"}, "Gestao de Pastagem (offline)")
              ),
              React.createElement("div", {className:"flex items-center gap-2"},
                React.createElement("label", {className:"text-xs font-medium text-slate-700"},
                  "KML: ",
                  React.createElement("input", {type:"file", accept:".kml,application/vnd.google-earth.kml+xml", onChange:hKML, className:"text-xs"})
                )
              )
            ),

            React.createElement("div", {className:"grid grid-cols-1 md:grid-cols-3 gap-2"},
              React.createElement("input", {
                className:"w-full rounded-lg border border-slate-300 px-3 py-2 text-sm",
                placeholder:"Fazenda",
                value: data.farm || "",
                onChange: e => setData(prev => ({...prev, farm: e.target.value}))
              }),
              React.createElement("input", {
                className:"w-full rounded-lg border border-slate-300 px-3 py-2 text-sm",
                placeholder:"Cidade",
                value: data.city || "",
                onChange: e => setData(prev => ({...prev, city: e.target.value}))
              }),
              React.createElement("div", {className:"rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-sm flex items-center justify-between"},
                React.createElement("span", {className:"text-slate-600"}, "Area total (KML)"),
                React.createElement("span", {className:"font-semibold text-slate-900"}, fmt(totalAreaHa), " ha")
              )
            ),

            React.createElement("nav", {className:"flex gap-2"},
              ["mapa","piquetes","lotes","anotacoes"].map(t =>
                React.createElement("button", {
                  key:t,
                  onClick:()=>setUI(prev=>({...prev, tab:t})),
                  className:
                    "px-3 py-1.5 rounded-lg text-sm border " +
                    (ui.tab===t ? "bg-emerald-600 text-white border-emerald-600" : "bg-white text-slate-700 border-slate-300 hover:bg-slate-50")
                }, t.toUpperCase())
              )
            )
          )
        ),

        React.createElement("main", {className:"max-w-6xl mx-auto px-4 py-4"},
          ui.tab==="mapa" && React.createElement("div", {className:"grid grid-cols-1 lg:grid-cols-3 gap-4"},
            React.createElement("div", {className:"lg:col-span-2 rounded-2xl border border-slate-200 bg-white shadow-sm overflow-hidden"},
              React.createElement("div", {className:"px-4 py-3 border-b border-slate-200 flex items-center justify-between"},
                React.createElement("div", {className:"font-semibold text-slate-900"}, "Mapa (KML)"),
                React.createElement("div", {className:"text-xs text-slate-500"}, data.mb ? "OK" : "Sem bounds (vai recalcular)")
              ),

              React.createElement("div", {className:"p-2"},
                React.createElement("svg", {
                  ref: svgRef,
                  className:"w-full h-[70vh] bg-white rounded-xl border border-slate-100",
                  viewBox:"0 0 1000 800",
                },
                  piqF.map(p => {
                    const d = getPath(p.coordinates, data.mb);
                    const [clng, clat] = centroidLngLat(p.coordinates?.[0] || []);
                    const [cx, cy] = projC(clng, clat, data.mb);
                    const sel = ui.selectedPiqId === p.id;

                    return React.createElement(React.Fragment, {key:p.id},
                      React.createElement("path", {
                        d,
                        onClick:()=>onPickPiq(p.id),
                        className:"cursor-pointer",
                        fill: sel ? "rgba(16,185,129,.30)" : "rgba(16,185,129,.18)",
                        stroke: sel ? "rgba(5,150,105,1)" : "rgba(15,23,42,.25)",
                        strokeWidth: sel ? 2 : 1
                      }),
                      React.createElement("text", {
                        x: cx, y: cy,
                        textAnchor:"middle",
                        className:"select-none",
                        style:{ fontSize: 12, fill:"rgba(15,23,42,.75)" }
                      }, p.name)
                    );
                  })
                )
              )
            ),

            React.createElement("div", {className:"rounded-2xl border border-slate-200 bg-white shadow-sm"},
              React.createElement("div", {className:"px-4 py-3 border-b border-slate-200"},
                React.createElement("div", {className:"font-semibold text-slate-900"}, "Detalhes")
              ),

              React.createElement("div", {className:"p-4 space-y-3"},
                !selectedPiq && React.createElement("div", {className:"text-sm text-slate-600"},
                  "Clique em um piquete no mapa para ver detalhes."
                ),

                selectedPiq && (() => {
                  const ring = selectedPiq.coordinates?.[0] || [];
                  const areaHa = polygonAreaMeters2(ring)/10000;
                  return React.createElement("div", {className:"space-y-2"},
                    React.createElement("div", {className:"text-sm"},
                      React.createElement("div", {className:"font-semibold text-slate-900"}, selectedPiq.name),
                      React.createElement("div", {className:"text-slate-600"}, "Area: ", React.createElement("span",{className:"font-semibold text-slate-900"}, fmt(areaHa)), " ha")
                    ),
                    React.createElement("div", {className:"text-xs text-slate-500"},
                      "Dica: use a aba LOTES para vincular piquetes a lotes."
                    )
                  );
                })()
              )
            )
          ),

          ui.tab==="piquetes" && React.createElement("div", {className:"rounded-2xl border border-slate-200 bg-white shadow-sm"},
            React.createElement("div", {className:"px-4 py-3 border-b border-slate-200 flex items-center justify-between"},
              React.createElement("div", {className:"font-semibold text-slate-900"}, "Piquetes"),
              React.createElement("div", {className:"text-sm text-slate-600"}, "Total: ", piqF.length)
            ),
            React.createElement("div", {className:"p-4 overflow-auto"},
              React.createElement("table", {className:"w-full text-sm"},
                React.createElement("thead", {className:"text-xs text-slate-500"},
                  React.createElement("tr", null,
                    React.createElement("th", {className:"text-left py-2"}, "Piquete"),
                    React.createElement("th", {className:"text-right py-2"}, "Area (ha)")
                  )
                ),
                React.createElement("tbody", null,
                  piqF.map(p => {
                    const ring = p.coordinates?.[0] || [];
                    const areaHa = polygonAreaMeters2(ring)/10000;
                    return React.createElement("tr", {key:p.id, className:"border-t border-slate-100 hover:bg-slate-50"},
                      React.createElement("td", {
                        className:"py-2",
                        onClick:()=>setUI(prev=>({...prev, tab:"mapa", selectedPiqId:p.id})),
                        style:{cursor:"pointer"}
                      }, p.name),
                      React.createElement("td", {className:"py-2 text-right"}, fmt(areaHa))
                    );
                  })
                )
              )
            )
          ),

          ui.tab==="lotes" && React.createElement("div", {className:"grid grid-cols-1 lg:grid-cols-3 gap-4"},
            React.createElement("div", {className:"rounded-2xl border border-slate-200 bg-white shadow-sm"},
              React.createElement("div", {className:"px-4 py-3 border-b border-slate-200 flex items-center justify-between"},
                React.createElement("div", {className:"font-semibold text-slate-900"}, "Lotes"),
                React.createElement("button", {
                  onClick:addLot,
                  className:"px-3 py-1.5 rounded-lg text-sm bg-emerald-600 text-white hover:bg-emerald-700"
                }, "+ Novo")
              ),
              React.createElement("div", {className:"p-2"},
                lots.length===0 && React.createElement("div", {className:"p-3 text-sm text-slate-600"}, "Nenhum lote cadastrado."),
                lots.map(l => {
                  const sel = ui.selectedLotId === l.id;
                  const areaHa = lotAreaHa(l);
                  return React.createElement("button", {
                    key:l.id,
                    onClick:()=>setUI(prev=>({...prev, selectedLotId:l.id})),
                    className:
                      "w-full text-left p-3 rounded-xl border mb-2 " +
                      (sel ? "border-emerald-600 bg-emerald-50" : "border-slate-200 hover:bg-slate-50")
                  },
                    React.createElement("div", {className:"font-semibold text-slate-900"}, l.name),
                    React.createElement("div", {className:"text-xs text-slate-600 mt-1"},
                      "Cabecas: ", (l.heads||"-"), " | Area: ", fmt(areaHa), " ha | Piquetes: ", (l.piquetes||[]).length
                    )
                  );
                })
              )
            ),

            React.createElement("div", {className:"lg:col-span-2 rounded-2xl border border-slate-200 bg-white shadow-sm"},
              React.createElement("div", {className:"px-4 py-3 border-b border-slate-200 flex items-center justify-between"},
                React.createElement("div", {className:"font-semibold text-slate-900"}, "Detalhes do Lote"),
                selectedLot && React.createElement("div", {className:"flex gap-2"},
                  React.createElement("button", {
                    onClick:()=>delLot(selectedLot.id),
                    className:"px-3 py-1.5 rounded-lg text-sm bg-rose-600 text-white hover:bg-rose-700"
                  }, "Excluir")
                )
              ),

              !selectedLot && React.createElement("div", {className:"p-4 text-sm text-slate-600"},
                "Selecione um lote na lista ou crie um novo."
              ),

              selectedLot && React.createElement("div", {className:"p-4 space-y-4"},
                React.createElement("div", {className:"grid grid-cols-1 md:grid-cols-2 gap-3"},
                  React.createElement("div", null,
                    React.createElement("label", {className:"block text-xs text-slate-600 mb-1"}, "Nome"),
                    React.createElement("input", {
                      className:"w-full rounded-lg border border-slate-300 px-3 py-2 text-sm",
                      value: selectedLot.name || "",
                      onChange:e=>updLot(selectedLot.id, {name:e.target.value})
                    })
                  ),
                  React.createElement("div", null,
                    React.createElement("label", {className:"block text-xs text-slate-600 mb-1"}, "Cabecas"),
                    React.createElement("input", {
                      className:"w-full rounded-lg border border-slate-300 px-3 py-2 text-sm",
                      value: selectedLot.heads || "",
                      onChange:e=>updLot(selectedLot.id, {heads:e.target.value})
                    })
                  ),
                  React.createElement("div", null,
                    React.createElement("label", {className:"block text-xs text-slate-600 mb-1"}, "Entrada"),
                    React.createElement("input", {
                      type:"date",
                      className:"w-full rounded-lg border border-slate-300 px-3 py-2 text-sm",
                      value: selectedLot.entryDate || "",
                      onChange:e=>updLot(selectedLot.id, {entryDate:e.target.value})
                    })
                  ),
                  React.createElement("div", null,
                    React.createElement("label", {className:"block text-xs text-slate-600 mb-1"}, "Saida"),
                    React.createElement("input", {
                      type:"date",
                      className:"w-full rounded-lg border border-slate-300 px-3 py-2 text-sm",
                      value: selectedLot.exitDate || "",
                      onChange:e=>updLot(selectedLot.id, {exitDate:e.target.value})
                    })
                  ),
                  React.createElement("div", null,
                    React.createElement("label", {className:"block text-xs text-slate-600 mb-1"}, "GMD (kg/dia)"),
                    React.createElement("input", {
                      className:"w-full rounded-lg border border-slate-300 px-3 py-2 text-sm",
                      value: selectedLot.gmd || "",
                      onChange:e=>updLot(selectedLot.id, {gmd:e.target.value})
                    })
                  )
                ),

                React.createElement("div", null,
                  React.createElement("label", {className:"block text-xs text-slate-600 mb-1"}, "Observacoes"),
                  React.createElement("textarea", {
                    className:"w-full rounded-lg border border-slate-300 px-3 py-2 text-sm min-h-[90px]",
                    value: selectedLot.notes || "",
                    onChange:e=>updLot(selectedLot.id, {notes:e.target.value})
                  })
                ),

                React.createElement("div", {className:"rounded-xl border border-slate-200"},
                  React.createElement("div", {className:"px-3 py-2 border-b border-slate-200 flex items-center justify-between"},
                    React.createElement("div", {className:"font-semibold text-slate-900 text-sm"}, "Piquetes do lote"),
                    React.createElement("div", {className:"text-xs text-slate-600"},
                      "Area do lote: ",
                      React.createElement("span",{className:"font-semibold text-slate-900"}, fmt(lotAreaHa(selectedLot))),
                      " ha"
                    )
                  ),
                  React.createElement("div", {className:"p-3 grid grid-cols-1 md:grid-cols-2 gap-2"},
                    piqF.map(p => {
                      const checked = (selectedLot.piquetes||[]).includes(p.id);
                      return React.createElement("label", {key:p.id, className:"flex items-center gap-2 text-sm"},
                        React.createElement("input", {
                          type:"checkbox",
                          checked,
                          onChange:()=>toggleLotPiq(selectedLot.id, p.id)
                        }),
                        React.createElement("span", {className:"text-slate-800"}, p.name)
                      );
                    })
                  )
                )
              )
            )
          ),

          ui.tab==="anotacoes" && React.createElement("div", {className:"rounded-2xl border border-slate-200 bg-white shadow-sm"},
            React.createElement("div", {className:"px-4 py-3 border-b border-slate-200"},
              React.createElement("div", {className:"font-semibold text-slate-900"}, "Anotacoes gerais")
            ),
            React.createElement("div", {className:"p-4"},
              React.createElement("textarea", {
                className:"w-full rounded-xl border border-slate-300 px-3 py-3 text-sm min-h-[260px]",
                value: data.notes || "",
                onChange: e => setData(prev => ({...prev, notes: e.target.value}))
              })
            )
          )
        )
      )
    );
  }

  const root = ReactDOM.createRoot(document.getElementById('root'));
  root.render(React.createElement(App));
  </script>
</body>
</html>
