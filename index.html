<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,user-scalable=yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Pasto Verde Pro - Gestão Inteligente</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body { margin: 0; padding: 0; font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .glass-header { background: rgba(11, 66, 33, 0.95); backdrop-filter: blur(10px); }
        .card-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .active-tab { position: relative; color: #10b981 !important; }
        .active-tab::after { content: ''; position: absolute; bottom: 0; left: 25%; width: 50%; height: 3px; background: #10b981; border-radius: 2px; }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
const { useState, useEffect, useMemo, useRef } = React;

// --- ÍCONES ---
const I = ({ size = 20, children }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">{children}</svg>;
const Upload = p => <I {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12" /></I>;
const Plus = p => <I {...p}><line x1="12" y1="5" x2="12" y2="19" /><line x1="5" y1="12" x2="19" y2="12" /></I>;
const Trash2 = p => <I {...p}><polyline points="3 6 5 6 21 6" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" /></I>;
const MapPin = p => <I {...p}><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" /><circle cx="12" cy="10" r="3" /></I>;
const ZoomIn = p => <I {...p}><circle cx="11" cy="11" r="8" /><line x1="21" y1="21" x2="16.65" y2="16.65" /><line x1="11" y1="8" x2="11" y2="14" /><line x1="8" y1="11" x2="14" y2="11" /></I>;
const ZoomOut = p => <I {...p}><circle cx="11" cy="11" r="8" /><line x1="21" y1="21" x2="16.65" y2="16.65" /><line x1="8" y1="11" x2="14" y2="11" /></I>;
const Compass = p => <I {...p}><circle cx="12" cy="12" r="10" /><polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76" /></I>;
const BarChart = p => <I {...p}><line x1="12" y1="20" x2="12" y2="10" /><line x1="18" y1="20" x2="18" y2="4" /><line x1="6" y1="20" x2="6" y2="16" /></I>;

// --- UTILITÁRIOS ---
const gid = () => `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
const calcArea = c => {
    if (!c || c.length < 3) return 0;
    let a = 0;
    const n = c.length, lm = c.reduce((s, v) => s + v[1], 0) / n, fl = Math.cos(lm * Math.PI / 180);
    for (let i = 0; i < n; i++) {
        const j = (i + 1) % n, xi = c[i][0] * fl * 111320, yi = c[i][1] * 110540, xj = c[j][0] * fl * 111320, yj = c[j][1] * 110540;
        a += xi * yj - xj * yi;
    }
    return (Math.abs(a) / 2 / 10000).toFixed(2);
};
const calcUA = (p, q) => !p || !q ? 0 : ((p * q) / 450).toFixed(2);
const isReserva = n => {
    const s = n.toLowerCase();
    return s.includes('reserva') || s.includes('app') || s.includes('mata');
};
const pointInPolygon = (p, vs) => {
    let inside = false;
    for (let i = 0, j = vs.length - 1; i < vs.length; j = i++) {
        const xi = vs[i][0], yi = vs[i][1], xj = vs[j][0], yj = vs[j][1];
        if ((yi > p[1]) != (yj > p[1]) && (p[0] < (xj - xi) * (p[1] - yi) / (yj - yi) + xi)) inside = !inside;
    }
    return inside;
};

// --- APP ---
function App() {
    const [data, setData] = useState({ faz: [], fa: null, mod: [], piq: [], lot: [], his: [], mb: null });
    const [ui, setUi] = useState({ tab: 'dashboard', modal: null, sel: null, st: '', zm: 1, pn: { x: 0, y: 0 }, fd: {} });
    const [gps, setGps] = useState({ pos: null, status: 'buscando' });
    const [touch, setTouch] = useState({ active: false, start: null, last: null, dist: 0 });

    useEffect(() => {
        const s = localStorage.getItem('pastureSystemV3');
        if (s) try { setData(JSON.parse(s)); } catch (e) {}
    }, []);

    useEffect(() => {
        localStorage.setItem('pastureSystemV3', JSON.stringify(data));
    }, [data]);

    useEffect(() => {
        if (!navigator.geolocation) return;
        navigator.geolocation.watchPosition(
            p => setGps({ pos: { lat: p.coords.latitude, lng: p.coords.longitude }, status: 'ativo' }),
            () => setGps(g => ({ ...g, status: 'erro' })),
            { enableHighAccuracy: true }
        );
    }, []);

    // Lógica de KML e Projeção (mantida do anterior)
    const hKML = e => {
        const f = e.target.files[0];
        if (!f || !data.fa) return;
        const r = new FileReader();
        r.onload = ev => {
            const p = new DOMParser(), x = p.parseFromString(ev.target.result, 'text/xml');
            const pl = Array.from(x.getElementsByTagName('Placemark'));
            let minLat = 180, maxLat = -180, minLng = 180, maxLng = -180;
            const np = pl.map(pm => {
                const coStr = pm.getElementsByTagName('coordinates')[0]?.textContent.trim();
                if (!coStr) return null;
                const co = coStr.split(/\s+/).map(pr => {
                    const [lng, lat] = pr.split(',').map(parseFloat);
                    if(lng < minLng) minLng = lng; if(lng > maxLng) maxLng = lng;
                    if(lat < minLat) minLat = lat; if(lat > maxLat) maxLat = lat;
                    return [lng, lat];
                });
                const nome = pm.getElementsByTagName('name')[0]?.textContent || 'Área';
                return { id: gid(), fazendaId: data.fa, nome, area: calcArea(co), coordinates: co, ehReserva: isReserva(nome) };
            }).filter(p => p);
            const mb = { minLat, maxLat, minLng, maxLng, width: maxLng-minLng, height: maxLat-minLat };
            setData({ ...data, piq: np, mb });
            setUi({...ui, st: '✅ Mapa Importado!'});
        };
        r.readAsText(f);
    };

    const proj = (lng, lat) => {
        if (!data.mb) return [0, 0];
        return [((lng - data.mb.minLng) / data.mb.width) * 800 + 100, ((data.mb.maxLat - lat) / data.mb.height) * 600 + 100];
    };

    const fazAt = data.faz.find(f => f.id === data.fa);
    const piqF = data.piq.filter(p => p.fazendaId === data.fa);
    const areaTotal = piqF.reduce((s, p) => s + parseFloat(p.area), 0).toFixed(2);

    return (
        <div className="min-h-screen flex flex-col">
            {/* HEADER PREMIUM */}
            <header className="glass-header text-white px-6 py-4 flex justify-between items-center sticky top-0 z-50 shadow-xl">
                <div>
                    <h1 className="text-xl font-black tracking-tighter flex items-center gap-2">
                        <span className="bg-emerald-500 p-1 rounded-md text-white"><BarChart size={20}/></span>
                        PASTO VERDE PRO
                    </h1>
                    <p className="text-[10px] text-emerald-300 font-bold uppercase tracking-widest">{fazAt?.nome || 'Sistema de Gestão'}</p>
                </div>
                {gps.status === 'ativo' && <div className="flex items-center gap-2 bg-emerald-900/50 px-3 py-1.5 rounded-full border border-emerald-700/50">
                    <div className="w-2 h-2 bg-emerald-400 rounded-full animate-pulse"></div>
                    <span className="text-[10px] font-bold">GPS ATIVO</span>
                </div>}
            </header>

            {/* NAVEGAÇÃO */}
            {data.fa && (
                <nav className="bg-white border-b flex overflow-x-auto no-scrollbar px-2 sticky top-[68px] z-40">
                    {['dashboard', 'mapa', 'piquetes', 'lotes', 'config'].map(t => (
                        <button key={t} onClick={() => setUi({...ui, tab: t})} 
                            className={`px-6 py-4 text-[11px] font-black uppercase tracking-widest transition-all whitespace-nowrap ${ui.tab === t ? 'active-tab' : 'text-slate-400'}`}>
                            {t}
                        </button>
                    ))}
                </nav>
            )}

            <main className="flex-1 p-4 max-w-5xl mx-auto w-full">
                {!data.fa ? (
                    /* TELA INICIAL / CADASTRO */
                    <div className="py-12 flex flex-col items-center">
                        <div className="bg-white p-8 rounded-3xl card-shadow w-full max-w-sm border border-slate-100">
                            <h2 className="text-2xl font-black text-slate-800 mb-2 text-center">Bem-vindo!</h2>
                            <p className="text-slate-500 text-sm text-center mb-8">Comece cadastrando sua propriedade para gerenciar o pastejo.</p>
                            <input type="text" placeholder="Nome da Fazenda" value={ui.fd.nome || ''} 
                                onChange={e => setUi({...ui, fd: {nome: e.target.value}})} 
                                className="w-full p-4 bg-slate-50 border-2 border-slate-100 rounded-2xl mb-4 focus:border-emerald-500 outline-none font-bold transition-all" />
                            <button onClick={() => { if(ui.fd.nome) { const id=gid(); setData({...data, faz: [{id, nome: ui.fd.nome}], fa: id}); } }} 
                                className="w-full bg-emerald-600 hover:bg-emerald-700 text-white py-4 rounded-2xl font-black text-lg shadow-lg shadow-emerald-200 transition-all">
                                INICIAR GESTÃO
                            </button>
                        </div>
                    </div>
                ) : (
                    /* CONTEÚDO DAS ABAS */
                    <div className="animate-in fade-in duration-500">
                        {ui.tab === 'dashboard' && (
                            <div className="space-y-4">
                                <div className="grid grid-cols-2 gap-4">
                                    <div className="bg-white p-5 rounded-3xl border border-slate-100 card-shadow">
                                        <p className="text-[10px] font-black text-slate-400 uppercase mb-1">Área Mapeada</p>
                                        <p className="text-2xl font-black text-slate-800">{areaTotal} <span className="text-xs text-slate-400">ha</span></p>
                                    </div>
                                    <div className="bg-white p-5 rounded-3xl border border-slate-100 card-shadow">
                                        <p className="text-[10px] font-black text-slate-400 uppercase mb-1">Piquetes</p>
                                        <p className="text-2xl font-black text-slate-800">{piqF.length}</p>
                                    </div>
                                </div>
                                
                                <div className="bg-gradient-to-br from-emerald-600 to-emerald-800 p-6 rounded-[2rem] text-white shadow-xl shadow-emerald-100">
                                    <div className="flex justify-between items-start mb-6">
                                        <div>
                                            <p className="text-emerald-200 text-[10px] font-black uppercase tracking-widest">Lotação Média</p>
                                            <p className="text-4xl font-black">0.00 <span className="text-lg opacity-60">UA/ha</span></p>
                                        </div>
                                        <span className="bg-white/20 p-2 rounded-xl"><BarChart size={24}/></span>
                                    </div>
                                    <div className="h-1.5 w-full bg-white/10 rounded-full overflow-hidden">
                                        <div className="h-full bg-emerald-400 w-1/3"></div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {ui.tab === 'mapa' && (
                            <div className="space-y-4">
                                <div className="flex justify-between items-center">
                                    <label className="bg-slate-800 text-white px-4 py-2.5 rounded-xl font-black text-[10px] uppercase tracking-wider cursor-pointer flex items-center gap-2 hover:bg-slate-700 transition-all">
                                        <Upload size={14}/> Importar KML
                                        <input type="file" className="hidden" accept=".kml" onChange={hKML} />
                                    </label>
                                    <div className="flex gap-2">
                                        <button onClick={() => setUi({...ui, zm: ui.zm + 0.2})} className="bg-white w-10 h-10 flex items-center justify-center rounded-xl border border-slate-200 card-shadow font-bold text-slate-600">+</button>
                                        <button onClick={() => setUi({...ui, zm: Math.max(0.1, ui.zm - 0.2)})} className="bg-white w-10 h-10 flex items-center justify-center rounded-xl border border-slate-200 card-shadow font-bold text-slate-600">-</button>
                                    </div>
                                </div>
                                <div className="bg-slate-100 rounded-[2.5rem] border-4 border-white card-shadow relative overflow-hidden h-[60vh]">
                                    <svg viewBox="0 0 1000 800" className="w-full h-full touch-none">
                                        <g transform={`translate(${ui.pn.x}, ${ui.pn.y}) scale(${ui.zm})`}>
                                            {piqF.map(p => (
                                                <path key={p.id} 
                                                    d={p.coordinates.map((c, i) => `${i===0?'M':'L'} ${proj(c[0], c[1]).join(' ')}`).join(' ') + ' Z'} 
                                                    fill={p.ehReserva ? "#dcfce7" : "#fff"} 
                                                    stroke={p.ehReserva ? "#166534" : "#cbd5e1"} 
                                                    strokeWidth="1.5"
                                                    onClick={() => setUi({...ui, sel: p})}
                                                />
                                            ))}
                                        </g>
                                    </svg>
                                    {piqF.length === 0 && (
                                        <div className="absolute inset-0 flex flex-col items-center justify-center text-slate-400 p-8 text-center">
                                            <div className="mb-4 opacity-20"><MapPin size={64}/></div>
                                            <p className="text-sm font-bold uppercase tracking-widest">Nenhum mapa carregado</p>
                                            <p className="text-xs opacity-60 mt-1">Importe um arquivo KML para visualizar sua fazenda.</p>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {ui.tab === 'piquetes' && (
                            <div className="bg-white rounded-3xl card-shadow border border-slate-100 overflow-hidden">
                                <table className="w-full text-left">
                                    <thead>
                                        <tr className="bg-slate-50 border-b border-slate-100">
                                            <th className="p-5 text-[10px] font-black text-slate-400 uppercase tracking-widest">Piquete</th>
                                            <th className="p-5 text-[10px] font-black text-slate-400 uppercase tracking-widest text-right">Área (ha)</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-50">
                                        {piqF.map(p => (
                                            <tr key={p.id} className="hover:bg-slate-50 transition-colors">
                                                <td className="p-5">
                                                    <p className="font-bold text-slate-700 uppercase text-xs">{p.nome}</p>
                                                    {p.ehReserva && <span className="text-[9px] bg-green-100 text-green-700 px-2 py-0.5 rounded-full font-bold">RESERVA</span>}
                                                </td>
                                                <td className="p-5 text-right font-black text-slate-800 text-sm">{p.area}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}
                    </div>
                )}
            </main>

            {/* STATUS TOAST */}
            {ui.st && (
                <div className="fixed bottom-6 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-2xl shadow-2xl font-bold text-xs animate-bounce z-[100]">
                    {ui.st}
                </div>
            )}
        </div>
    );
}

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);
    </script>
</body>
</html>
