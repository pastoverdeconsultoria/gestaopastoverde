<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,user-scalable=yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Manager Pro v2.9 - Gest√£o de Pastagem</title>
  <title>Pasto Verde Pro v3.0 - Gest√£o de Pastagem</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <style>
    body { margin: 0; padding: 0; font-family: system-ui, -apple-system, sans-serif; }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
const { useState, useEffect, useMemo, useRef } = React;

const I = ({ size = 20, children }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">{children}</svg>;
const Upload = p => <I {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12" /></I>;
const Plus = p => <I {...p}><line x1="12" y1="5" x2="12" y2="19" /><line x1="5" y1="12" x2="19" y2="12" /></I>;
const Trash2 = p => <I {...p}><polyline points="3 6 5 6 21 6" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" /></I>;
const X = p => <I {...p}><line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" /></I>;
const MapPin = p => <I {...p}><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" /><circle cx="12" cy="10" r="3" /></I>;
const ZoomIn = p => <I {...p}><circle cx="11" cy="11" r="8" /><line x1="21" y1="21" x2="16.65" y2="16.65" /><line x1="11" y1="8" x2="11" y2="14" /><line x1="8" y1="11" x2="14" y2="11" /></I>;
const ZoomOut = p => <I {...p}><circle cx="11" cy="11" r="8" /><line x1="21" y1="21" x2="16.65" y2="16.65" /><line x1="8" y1="11" x2="14" y2="11" /></I>;
const RotateCcw = p => <I {...p}><polyline points="1 4 1 10 7 10" /><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10" /></I>;
@@ -85,51 +85,51 @@ const pointInPolygon = (p, vs) => {
    const xi = vs[i][0], yi = vs[i][1], xj = vs[j][0], yj = vs[j][1];
    if ((yi > p[1]) != (yj > p[1]) && (p[0] < (xj - xi) * (p[1] - yi) / (yj - yi) + xi)) inside = !inside;
  }
  return inside;
};

function App() {
  const [data, setData] = useState({ faz: [], fa: null, mod: [], piq: [], lot: [], his: [], mb: null });
  const [ui, setUi] = useState({ tab: 'mapa', modal: null, sel: null, st: '', zm: 1, pn: { x: 0, y: 0 }, fd: {}, exp: {} });
  const [gps, setGps] = useState({ pos: null, status: 'buscando' });
  const [touch, setTouch] = useState({ active: false, start: null, last: null, dist: 0 });
  const svgRef = useRef(null);

  useEffect(() => {
    const s = localStorage.getItem('pastureSystem');
    if (s) {
      try {
        const d = JSON.parse(s);
        setData({ faz: d.fazendas || [], fa: d.fazendaAtual || null, mod: d.modulos || [], piq: d.piquetes || [], lot: d.lotes || [], his: d.historico || [], mb: d.mapBounds || null });
      } catch (e) { }
    }
  }, []);

  useEffect(() => {
    localStorage.setItem('pastureSystem', JSON.stringify({
      version: '2.9.0',
      version: '3.0.0',
      fazendas: data.faz,
      fazendaAtual: data.fa,
      modulos: data.mod,
      piquetes: data.piq,
      lotes: data.lot,
      historico: data.his,
      mapBounds: data.mb
    }));
  }, [data]);

  useEffect(() => {
    if (!navigator.geolocation) {
      setGps({ pos: null, status: 'indisponivel' });
      return;
    }
    const id = navigator.geolocation.watchPosition(
      p => setGps({ pos: { lat: p.coords.latitude, lng: p.coords.longitude, acc: p.coords.accuracy }, status: 'ativo' }),
      e => setGps(g => ({ ...g, status: 'erro' })),
      { enableHighAccuracy: true, timeout: 30000, maximumAge: 0 }
    );
    return () => navigator.geolocation.clearWatch(id);
  }, []);

  const getTouchDist = (t1, t2) => Math.hypot(t2.clientX - t1.clientX, t2.clientY - t1.clientY);

@@ -149,75 +149,75 @@ function App() {
    
    if (e.touches.length === 1 && touch.start) {
      const t = e.touches[0];
      const dx = t.clientX - touch.start.x;
      const dy = t.clientY - touch.start.y;
      setUi(u => ({ ...u, pn: { x: touch.last.x + dx, y: touch.last.y + dy } }));
    } else if (e.touches.length === 2 && touch.dist > 0) {
      const newDist = getTouchDist(e.touches[0], e.touches[1]);
      const scale = newDist / touch.dist;
      const newZoom = Math.max(0.3, Math.min(5, ui.zm * scale));
      setUi(u => ({ ...u, zm: newZoom }));
      setTouch(t => ({ ...t, dist: newDist }));
    }
  };

  const handleTouchEnd = () => {
    setTouch({ active: false, start: null, last: null, dist: 0 });
  };

  const getPiqGPS = useMemo(() => {
    if (!gps.pos) return null;
    return data.piq.find(x => x.fazendaId === data.fa && x.coordinates && x.coordinates.length > 0 && pointInPolygon([gps.pos.lng, gps.pos.lat], x.coordinates)) || null;
  }, [gps.pos, data.piq, data.fa]);

  const exp = () => {
    const d = { fazendas: data.faz, modulos: data.mod, piquetes: data.piq, lotes: data.lot, historico: data.his, version: '2.8.0' };
    const d = { fazendas: data.faz, modulos: data.mod, piquetes: data.piq, lotes: data.lot, historico: data.his, version: '3.0.0' };
    const b = new Blob([JSON.stringify(d, null, 2)], { type: 'application/json' });
    const u = URL.createObjectURL(b);
    const a = document.createElement('a');
    a.href = u;
    a.download = `backup-${Date.now()}.json`;
    a.click();
    URL.revokeObjectURL(u);
    setUi({ ...ui, st: '‚úÖ Backup criado!' });
    setUi({ ...ui, st: '‚úÖ Backup criado com sucesso.' });
    setTimeout(() => setUi(ui => ({ ...ui, st: '' })), 3000);
  };

  const imp = e => {
    const f = e.target.files[0];
    if (!f) return;
    const r = new FileReader();
    r.onload = ev => {
      try {
        const d = JSON.parse(ev.target.result);
        if (confirm('Importar backup? Substitui todos os dados.')) {
          setData({ faz: d.fazendas || [], fa: null, mod: d.modulos || [], piq: d.piquetes || [], lot: d.lotes || [], his: d.historico || [], mb: null });
          setUi({ ...ui, st: '‚úÖ Importado!' });
          setUi({ ...ui, st: '‚úÖ Backup importado com sucesso.' });
        }
      } catch (er) {
        setUi({ ...ui, st: '‚ùå Erro ao importar' });
        setUi({ ...ui, st: '‚ùå N√£o foi poss√≠vel importar o backup.' });
      }
    };
    r.readAsText(f);
    e.target.value = '';
  };

  const parseKML = t => {
    const p = new DOMParser(), x = p.parseFromString(t, 'text/xml');
    if (x.querySelector('parsererror')) throw new Error('KML inv√°lido');
    const pl = x.getElementsByTagName('Placemark');
    if (pl.length === 0) throw new Error('Sem √°reas no KML');
    const np = [];
    let minLat = Infinity, maxLat = -Infinity, minLng = Infinity, maxLng = -Infinity, aT = 0, aR = 0;
    for (let i = 0; i < pl.length; i++) {
      const pm = pl[i], ne = pm.getElementsByTagName('name')[0], nm = ne ? ne.textContent.trim() : `√Årea ${i + 1}`;
      const ce = pm.getElementsByTagName('coordinates')[0];
      let co = [], ar = 0;
      const reserva = isReserva(nm);
      if (ce) {
        const ct = ce.textContent.trim(), cp = ct.split(/\s+/);
        co = cp.map(pr => {
          const [lng, lat] = pr.split(',').map(parseFloat);
          if (!isNaN(lng) && !isNaN(lat)) {
            minLng = Math.min(minLng, lng);
            maxLng = Math.max(maxLng, lng);
@@ -329,53 +329,54 @@ function App() {
  const modF = data.mod.filter(m => m.fazendaId === data.fa);
  const lotF = data.lot.filter(l => l.fazendaId === data.fa && l.status !== 'vendido');

  const totalAnimais = lotF.reduce((s, l) => s + (l.quantidade || 0), 0);
  const totalUA = lotF.reduce((s, l) => s + parseFloat(l.totalUA || 0), 0).toFixed(2);
  const areaUtil = parseFloat(fazAt?.areaUtil || 0);
  const lotacaoGlobal = areaUtil > 0 ? (totalUA / areaUtil).toFixed(2) : '0.00';

  const piqOcupados = piqF.filter(p => p.loteAtualId).length;
  const piqVazios = piqF.filter(p => !p.loteAtualId && !p.ehReserva).length;
  const piqTotal = piqF.filter(p => !p.ehReserva).length;
  const percOcupacao = piqTotal > 0 ? ((piqOcupados / piqTotal) * 100).toFixed(0) : 0;

  const dataHoje = new Date().toLocaleDateString('pt-BR');

  const getModuloStats = (modId) => {
    const pqs = piqF.filter(p => p.moduloId === modId && !p.ehReserva);
    const areaTotal = pqs.reduce((s, p) => s + parseFloat(p.area || 0), 0);
    const lotesDoModulo = lotF.filter(l => l.piqueteAtual && pqs.find(p => p.id === l.piqueteAtual));
    const uaTotal = lotesDoModulo.reduce((s, l) => s + parseFloat(l.totalUA || 0), 0);
    const lotacao = areaTotal > 0 ? (uaTotal / areaTotal).toFixed(2) : '0.00';
    return { areaTotal: areaTotal.toFixed(2), lotacao };
  };

  return <div className="min-h-screen bg-gray-50">
    <div className="bg-gradient-to-r from-green-600 to-blue-600 text-white p-4 shadow-lg">
    <div className="bg-gradient-to-r from-emerald-600 to-teal-600 text-white p-4 shadow-lg">
      <div className="max-w-7xl mx-auto">
        <h1 className="text-2xl font-bold mb-2">üìä Manager Pro v3.0</h1>
        <h1 className="text-2xl font-bold mb-1">üìä Pasto Verde Pro v3.0</h1>
        <p className="text-sm opacity-90">Gest√£o de pastagem simples e pr√°tica para o dia a dia.</p>
        {fazAt && <div className="text-sm flex items-center gap-2 flex-wrap">
          <button onClick={() => setUi({ ...ui, modal: 'trocar-fazenda' })} className="bg-white/20 hover:bg-white/30 px-2 py-1 rounded flex items-center gap-1 font-semibold">
            üìç {fazAt.nome} ‚ñº
          </button>
          <span className="text-xs opacity-80">üìÖ {dataHoje}</span>
          {gps.status === 'ativo' && getPiqGPS && <span className="bg-green-100 text-green-800 px-2 py-1 rounded text-xs font-semibold">‚úÖ GPS | üìç {getPiqGPS.nome}</span>}
          {gps.status === 'ativo' && !getPiqGPS && <span className="bg-green-100 text-green-800 px-2 py-1 rounded text-xs">‚úÖ GPS Ativo</span>}
        </div>}
      </div>
    </div>

    {ui.st && <div className="max-w-7xl mx-auto px-4 pt-2">
      <div className={`p-2 rounded text-sm ${ui.st.includes('‚úÖ') ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>{ui.st}</div>
    </div>}

    {data.fa && <div className="bg-white border-b sticky top-0 z-10">
      <div className="max-w-7xl mx-auto flex gap-1 overflow-x-auto">
        {['dashboard', 'mapa', 'piquetes', 'modulos', 'lotes', 'historico', 'config'].map(t => <button key={t} onClick={() => setUi({ ...ui, tab: t })} className={`px-4 py-2 font-semibold capitalize whitespace-nowrap ${ui.tab === t ? 'border-b-2 border-green-600 text-green-600' : 'text-gray-600'}`}>
          {t === 'config' ? '‚öôÔ∏è' : t}
        </button>)}
      </div>
    </div>}

    <div className="max-w-7xl mx-auto p-4">
      {!data.fa ? <div className="bg-white rounded-lg shadow p-6">
@@ -562,51 +563,51 @@ function App() {
                      />
                      <text x={cx} y={cy - 20} textAnchor="middle" fill="#1e293b" fontSize="20" fontWeight="bold" className="pointer-events-none">{p.ehReserva ? 'üå≥ ' : ''}{p.nome}</text>
                      <text x={cx} y={cy} textAnchor="middle" fill="#64748b" fontSize="16" className="pointer-events-none">{p.area}ha</text>
                      {p.ehReserva && <text x={cx} y={cy + 20} textAnchor="middle" fill="#166534" fontSize="14" fontWeight="600" className="pointer-events-none">RESERVA</text>}
                      {lote && <text x={cx} y={cy + 20} textAnchor="middle" fill="#16a34a" fontSize="14" fontWeight="600" className="pointer-events-none">üêÑ {lote.nome}</text>}
                    </g>;
                  })}
                  {gps.pos && data.mb && <circle cx={projC(gps.pos.lng, gps.pos.lat, data.mb, 1000, 800)[0]} cy={projC(gps.pos.lng, gps.pos.lat, data.mb, 1000, 800)[1]} r="8" fill="#3b82f6" />}
                </g>
              </svg>
            </div>
          </div>}
        </div> :

          ui.tab === 'piquetes' ? <div className="bg-white rounded-lg shadow p-4">
            <div className="flex justify-between items-center mb-3">
              <h2 className="text-xl font-bold">Piquetes</h2>
              <button onClick={() => setUi({ ...ui, modoSelecao: !ui.modoSelecao, selecionados: [] })} className={`px-3 py-2 rounded text-sm font-semibold ${ui.modoSelecao ? 'bg-red-500 text-white hover:bg-red-600' : 'bg-gray-200 hover:bg-gray-300'}`}>
                {ui.modoSelecao ? 'Cancelar' : 'Selecionar'}
              </button>
            </div>
            
            {ui.modoSelecao && ui.selecionados && ui.selecionados.length > 0 && <button onClick={() => {
              if (confirm(`Apagar ${ui.selecionados.length} piquete(s)?`)) {
                setData({ ...data, piq: data.piq.filter(p => !ui.selecionados.includes(p.id)) });
                setUi({ ...ui, selecionados: [], modoSelecao: false, st: '‚úÖ Apagados!' });
                setUi({ ...ui, selecionados: [], modoSelecao: false, st: '‚úÖ Itens apagados com sucesso.' });
                setTimeout(() => setUi(u => ({ ...u, st: '' })), 3000);
              }
            }} className="w-full bg-red-600 text-white px-4 py-3 rounded hover:bg-red-700 font-semibold mb-3 flex items-center justify-center gap-2">
              <Trash2 size={18} />Apagar ({ui.selecionados.length})
            </button>}
            
            {piqF.length === 0 ? <div className="text-center py-8 text-gray-500">Nenhum piquete cadastrado</div> :
              <div className="space-y-2">
                <div className="text-sm text-gray-600 mb-3">{piqF.length} piquete(s) | {piqF.reduce((s, p) => s + parseFloat(p.area || 0), 0).toFixed(2)}ha</div>
                {piqF.map(p => {
                  const lote = p.loteAtualId ? lotF.find(l => l.id === p.loteAtualId) : null;
                  const dias = p.loteAtualId ? calcDias(p.dataEntrada) : (p.dataSaida ? calcDias(p.dataSaida) : calcDias(p.dataCriacao));
                  const statusDias = p.loteAtualId ? `üü¢ ${dias}d` : `‚ö™ ${dias}d`;
                  const sel = ui.selecionados && ui.selecionados.includes(p.id);
                  return <div key={p.id} className={`border-2 rounded-lg p-3 transition ${p.ehReserva ? 'bg-green-50 border-green-300' : sel ? 'border-red-500 bg-red-50' : 'border-gray-200'} ${ui.modoSelecao ? '' : 'cursor-pointer hover:border-green-500'}`} onClick={() => {
                    if (ui.modoSelecao && !p.ehReserva) {
                      const s = ui.selecionados || [];
                      setUi({ ...ui, selecionados: s.includes(p.id) ? s.filter(id => id !== p.id) : [...s, p.id] });
                    } else if (!ui.modoSelecao) {
                      setUi({ ...ui, sel: p, modal: 'piquete-info' });
                    }
                  }}>
                    <div className="flex justify-between items-start">
                      <div className="flex items-center gap-2 flex-1">
                        {ui.modoSelecao && !p.ehReserva && <input type="checkbox" checked={sel} onChange={() => {}} className="w-5 h-5" />}
@@ -721,51 +722,51 @@ function App() {
                    data.his.filter(h => h.fazendaId === data.fa).sort((a, b) => new Date(b.data) - new Date(a.data)).map(h => <div key={h.id} className="border-2 rounded-lg p-3 mb-2">
                      <div className="text-sm text-gray-600">{formatData(h.data)}</div>
                      <div className="font-semibold">{h.descricao}</div>
                    </div>)}
                </div> :

                ui.tab === 'config' ? <div className="bg-white rounded-lg shadow p-4">
                  <h2 className="text-xl font-bold mb-4">‚öôÔ∏è Configura√ß√µes</h2>
                  <div className="space-y-3">
                    <div className="border-2 rounded-lg p-4">
                      <h3 className="font-bold mb-2">üíæ Backup e Restaura√ß√£o</h3>
                      <p className="text-sm text-gray-600 mb-3">Salve seus dados ou restaure de um backup</p>
                      <div className="flex gap-2 flex-wrap">
                        <button onClick={exp} className="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 flex items-center gap-2">
                          <Download size={18} />Fazer Backup
                        </button>
                        <label className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 cursor-pointer flex items-center gap-2">
                          <Upload size={18} />Restaurar
                          <input type="file" accept=".json" onChange={imp} className="hidden" />
                        </label>
                      </div>
                    </div>
                    <div className="border-2 rounded-lg p-4">
                      <h3 className="font-bold mb-2">‚ÑπÔ∏è Informa√ß√µes</h3>
                      <div className="text-sm text-gray-600 space-y-1">
                        <p><b>Vers√£o:</b> 2.9.0</p>
                        <p><b>Vers√£o:</b> 3.0.0</p>
                        {fazAt && <p><b>Fazenda:</b> {fazAt.nome}</p>}
                        <p><b>Piquetes:</b> {piqF.length}</p>
                        <p><b>Lotes:</b> {lotF.length}</p>
                        <p><b>M√≥dulos:</b> {modF.length}</p>
                      </div>
                    </div>
                    <div className="border-2 border-red-200 rounded-lg p-4 bg-red-50">
                      <h3 className="font-bold mb-2 text-red-700">üóëÔ∏è Resetar Sistema</h3>
                      <p className="text-sm text-gray-600 mb-3">Apaga todos os dados permanentemente</p>
                      <button onClick={() => {
                        if (confirm('‚ö†Ô∏è APAGAR TUDO?\n\nIsso vai resetar:\n‚Ä¢ Todas fazendas\n‚Ä¢ Todos piquetes\n‚Ä¢ Todos lotes\n‚Ä¢ Todo hist√≥rico\n\nN√ÉO TEM VOLTA!')) {
                          localStorage.clear();
                          location.reload();
                        }
                      }} className="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 font-semibold">
                        Resetar Tudo
                      </button>
                    </div>
                  </div>
                </div> : null}
    </div>

    {ui.modal === 'trocar-fazenda' && <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-lg p-4 max-w-md w-full">
        <div className="flex justify-between items-center mb-3">
@@ -800,190 +801,190 @@ function App() {
          <button onClick={() => {
            if (!ui.fd.nome) return;
            const nv = { id: gid(), nome: ui.fd.nome, areaTotal: 0, areaPreservacao: 0, areaUtil: 0, dataCriacao: new Date().toISOString() };
            setData({ ...data, faz: [...data.faz, nv], fa: nv.id });
            setUi({ ...ui, modal: null, fd: {}, tab: 'dashboard' });
          }} className="flex-1 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 font-semibold">Criar</button>
          <button onClick={() => setUi({ ...ui, modal: null, fd: {} })} className="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">Cancelar</button>
        </div>
      </div>
    </div>}

    {ui.modal === 'modulo' && <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-lg p-4 max-w-md w-full">
        <div className="flex justify-between items-center mb-3">
          <h2 className="text-lg font-bold">Novo M√≥dulo</h2>
          <button onClick={() => setUi({ ...ui, modal: null, fd: {} })} className="text-gray-500 hover:text-gray-700">
            <X size={20} />
          </button>
        </div>
        <input type="text" placeholder="Nome do m√≥dulo *" value={ui.fd.nome || ''} onChange={e => setUi({ ...ui, fd: { ...ui.fd, nome: e.target.value } })} className="w-full px-3 py-2 border rounded mb-3" />
        <div className="flex gap-2">
          <button onClick={() => {
            if (!ui.fd.nome) return;
            const nv = { id: gid(), fazendaId: data.fa, nome: ui.fd.nome, piquetes: [], dataCriacao: new Date().toISOString() };
            setData({ ...data, mod: [...data.mod, nv] });
            setUi({ ...ui, modal: null, fd: {}, st: '‚úÖ M√≥dulo criado!' });
            setUi({ ...ui, modal: null, fd: {}, st: '‚úÖ M√≥dulo criado com sucesso.' });
            setTimeout(() => setUi(u => ({ ...u, st: '' })), 3000);
          }} className="flex-1 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 font-semibold">Criar</button>
          <button onClick={() => setUi({ ...ui, modal: null, fd: {} })} className="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">Cancelar</button>
        </div>
      </div>
    </div>}

    {ui.modal === 'editar-modulo' && ui.sel && <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-lg p-4 max-w-md w-full max-h-[90vh] overflow-y-auto">
        <div className="flex justify-between items-center mb-3">
          <h2 className="text-lg font-bold">Editar M√≥dulo</h2>
          <button onClick={() => setUi({ ...ui, modal: null, sel: null, fd: {} })} className="text-gray-500 hover:text-gray-700">
            <X size={20} />
          </button>
        </div>
        <input type="text" placeholder="Nome do m√≥dulo *" value={ui.fd.nome || ''} onChange={e => setUi({ ...ui, fd: { ...ui.fd, nome: e.target.value } })} className="w-full px-3 py-2 border rounded mb-3" />
        <p className="text-sm font-semibold mb-2">Piquetes do m√≥dulo:</p>
        <div className="space-y-2 mb-3 max-h-60 overflow-y-auto">
          {piqF.filter(p => !p.ehReserva).map(p => <label key={p.id} className="flex items-center gap-2 p-2 border rounded hover:bg-gray-50 cursor-pointer">
            <input type="checkbox" checked={(ui.fd.piquetes || []).includes(p.id)} onChange={e => {
              const pqs = ui.fd.piquetes || [];
              setUi({ ...ui, fd: { ...ui.fd, piquetes: e.target.checked ? [...pqs, p.id] : pqs.filter(x => x !== p.id) } });
            }} />
            <span className="text-sm">{p.nome} ({p.area}ha)</span>
          </label>)}
        </div>
        <div className="flex gap-2">
          <button onClick={() => {
            if (!ui.fd.nome) return;
            const piqsAntigas = ui.sel.piquetes || [];
            const piqsNovas = ui.fd.piquetes || [];
            setData({
              ...data,
              mod: data.mod.map(m => m.id === ui.sel.id ? { ...m, nome: ui.fd.nome, piquetes: piqsNovas } : m),
              piq: data.piq.map(p => {
                if (piqsNovas.includes(p.id)) return { ...p, moduloId: ui.sel.id };
                if (piqsAntigas.includes(p.id) && !piqsNovas.includes(p.id)) return { ...p, moduloId: null };
                return p;
              })
            });
            setUi({ ...ui, modal: null, sel: null, fd: {}, st: '‚úÖ M√≥dulo atualizado!' });
            setUi({ ...ui, modal: null, sel: null, fd: {}, st: '‚úÖ M√≥dulo atualizado com sucesso.' });
            setTimeout(() => setUi(u => ({ ...u, st: '' })), 3000);
          }} className="flex-1 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 font-semibold">Salvar</button>
          <button onClick={() => setUi({ ...ui, modal: null, sel: null, fd: {} })} className="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">Cancelar</button>
        </div>
      </div>
    </div>}

    {ui.modal === 'editar-piquete' && ui.sel && <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-lg p-4 max-w-md w-full">
        <div className="flex justify-between items-center mb-3">
          <h2 className="text-lg font-bold">Editar Piquete</h2>
          <button onClick={() => setUi({ ...ui, modal: null, sel: null, fd: {} })} className="text-gray-500 hover:text-gray-700">
            <X size={20} />
          </button>
        </div>
        <input type="text" placeholder="Nome do piquete *" value={ui.fd.nome || ''} onChange={e => setUi({ ...ui, fd: { ...ui.fd, nome: e.target.value } })} className="w-full px-3 py-2 border rounded mb-3" />
        <label className="flex items-center gap-2 mb-3">
          <input type="checkbox" checked={ui.fd.ehReserva || false} onChange={e => setUi({ ...ui, fd: { ...ui.fd, ehReserva: e.target.checked } })} />
          <span className="text-sm">Marcar como √°rea de reserva</span>
        </label>
        <div className="flex gap-2">
          <button onClick={() => {
            if (!ui.fd.nome) return;
            setData({
              ...data,
              piq: data.piq.map(p => p.id === ui.sel.id ? { ...p, nome: ui.fd.nome, ehReserva: ui.fd.ehReserva } : p)
            });
            setUi({ ...ui, modal: null, sel: null, fd: {}, st: '‚úÖ Piquete atualizado!' });
            setUi({ ...ui, modal: null, sel: null, fd: {}, st: '‚úÖ Piquete atualizado com sucesso.' });
            setTimeout(() => setUi(u => ({ ...u, st: '' })), 3000);
          }} className="flex-1 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 font-semibold">Salvar</button>
          <button onClick={() => setUi({ ...ui, modal: null, sel: null, fd: {} })} className="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">Cancelar</button>
        </div>
      </div>
    </div>}

    {ui.modal === 'lote' && <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-lg p-4 max-w-md w-full max-h-[90vh] overflow-y-auto">
        <div className="flex justify-between items-center mb-3">
          <h2 className="text-lg font-bold">Novo Lote</h2>
          <button onClick={() => setUi({ ...ui, modal: null, fd: {} })} className="text-gray-500 hover:text-gray-700">
            <X size={20} />
          </button>
        </div>
        <input type="text" placeholder="Nome do lote *" value={ui.fd.nome || ''} onChange={e => setUi({ ...ui, fd: { ...ui.fd, nome: e.target.value } })} className="w-full px-3 py-2 border rounded mb-2" />
        <select value={ui.fd.categoria || ''} onChange={e => setUi({ ...ui, fd: { ...ui.fd, categoria: e.target.value } })} className="w-full px-3 py-2 border rounded mb-2">
          <option value="">Selecione a categoria...</option>
          {['Bezerro', 'Bezerra', 'Garrotes', 'Novilhas', 'Bois', 'Vacas'].map(c => <option key={c} value={c}>{c}</option>)}
        </select>
        <input type="number" step="0.01" placeholder="Peso m√©dio (kg) *" value={ui.fd.peso || ''} onChange={e => setUi({ ...ui, fd: { ...ui.fd, peso: e.target.value } })} className="w-full px-3 py-2 border rounded mb-2" />
        <input type="number" placeholder="Quantidade de animais *" value={ui.fd.qtd || ''} onChange={e => setUi({ ...ui, fd: { ...ui.fd, qtd: e.target.value } })} className="w-full px-3 py-2 border rounded mb-2" />
        
        <select value={ui.fd.piquete || ''} onChange={e => setUi({ ...ui, fd: { ...ui.fd, piquete: e.target.value } })} className="w-full px-3 py-2 border rounded mb-3">
          <option value="">Alocar em piquete (opcional)</option>
          {piqF.filter(p => !p.ehReserva && !p.loteAtualId).map(p => <option key={p.id} value={p.id}>{p.nome} ({p.area}ha)</option>)}
        </select>

        {ui.fd.peso && ui.fd.qtd && <div className="bg-blue-50 border border-blue-200 rounded p-2 mb-3 text-sm">
          <b>Total UA:</b> {calcUA(parseFloat(ui.fd.peso), parseInt(ui.fd.qtd))}
        </div>}
        <div className="flex gap-2">
          <button onClick={() => {
            if (!ui.fd.nome || !ui.fd.categoria || !ui.fd.peso || !ui.fd.qtd) {
              setUi({ ...ui, st: '‚ùå Preencha todos os campos obrigat√≥rios!' });
              setUi({ ...ui, st: '‚ùå Preencha todos os campos obrigat√≥rios para continuar.' });
              setTimeout(() => setUi(u => ({ ...u, st: '' })), 3000);
              return;
            }
            const tu = calcUA(parseFloat(ui.fd.peso), parseInt(ui.fd.qtd));
            const nv = {
              id: gid(),
              fazendaId: data.fa,
              nome: ui.fd.nome,
              categoria: ui.fd.categoria,
              pesoMedio: parseFloat(ui.fd.peso),
              quantidade: parseInt(ui.fd.qtd),
              totalUA: parseFloat(tu),
              status: ui.fd.piquete ? 'alocado' : 'livre',
              piqueteAtual: ui.fd.piquete || null,
              dataCriacao: new Date().toISOString()
            };
            
            let novoPiq = data.piq;
            if (ui.fd.piquete) {
              novoPiq = data.piq.map(p => p.id === ui.fd.piquete ? { ...p, loteAtualId: nv.id, dataEntrada: new Date().toISOString() } : p);
              const hist = {
                id: gid(),
                fazendaId: data.fa,
                tipo: 'entrada',
                loteId: nv.id,
                piqueteId: ui.fd.piquete,
                data: new Date().toISOString(),
                descricao: `Lote ${nv.nome} alocado em ${piqF.find(p => p.id === ui.fd.piquete)?.nome}`
              };
              setData({ ...data, lot: [...data.lot, nv], piq: novoPiq, his: [...data.his, hist] });
            } else {
              setData({ ...data, lot: [...data.lot, nv] });
            }
            
            setUi({ ...ui, modal: null, fd: {}, st: '‚úÖ Lote criado!' });
            setUi({ ...ui, modal: null, fd: {}, st: '‚úÖ Lote criado com sucesso.' });
            setTimeout(() => setUi(u => ({ ...u, st: '' })), 3000);
          }} className="flex-1 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 font-semibold">Criar Lote</button>
          <button onClick={() => setUi({ ...ui, modal: null, fd: {} })} className="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">Cancelar</button>
        </div>
      </div>
    </div>}

    {ui.modal === 'piquete-info' && ui.sel && (() => {
      const modulo = ui.sel.moduloId ? modF.find(m => m.id === ui.sel.moduloId) : null;
      const piqsMesmoMod = modulo ? piqF.filter(p => p.moduloId === modulo.id && !p.loteAtualId && p.id !== ui.sel.id && !p.ehReserva) : [];
      const piqsOutros = piqF.filter(p => (!modulo || p.moduloId !== modulo.id) && !p.loteAtualId && p.id !== ui.sel.id && !p.ehReserva);
      const lotesMesmoMod = modulo ? lotF.filter(l => l.piqueteAtual && piqF.find(p => p.id === l.piqueteAtual && p.moduloId === modulo.id)) : [];
      const lotesOutros = modulo ? lotF.filter(l => l.piqueteAtual && piqF.find(p => p.id === l.piqueteAtual && p.moduloId !== modulo.id)) : lotF.filter(l => l.piqueteAtual);
      const lotesLivres = lotF.filter(l => l.status === 'livre');
      
      return <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div className="bg-white rounded-lg p-4 max-w-md w-full max-h-[90vh] overflow-y-auto">
          <div className="flex justify-between items-center mb-3">
            <h2 className="text-lg font-bold">{ui.sel.nome}</h2>
            <button onClick={() => setUi({ ...ui, modal: null, sel: null, fd: {} })} className="text-gray-500 hover:text-gray-700">
              <X size={20} />
            </button>
          </div>
          <div className="space-y-2 mb-4">
            <div className="flex justify-between">
@@ -1011,216 +1012,216 @@ function App() {
            <div className="flex justify-between">
              <span className="text-gray-600">Status:</span>
              <span className="font-bold">{ui.sel.loteAtualId ? 'üü¢ Ocupado' : '‚ö™ Vazio'}</span>
            </div>
          </div>
          
          {ui.sel.loteAtualId ? <>
            <button onClick={() => {
              if (confirm('Remover lote deste piquete?')) {
                const lote = lotF.find(l => l.id === ui.sel.loteAtualId);
                const hist = {
                  id: gid(),
                  fazendaId: data.fa,
                  tipo: 'saida',
                  loteId: ui.sel.loteAtualId,
                  piqueteId: ui.sel.id,
                  data: new Date().toISOString(),
                  descricao: `Lote ${lote?.nome} removido de ${ui.sel.nome}`
                };
                setData({
                  ...data,
                  piq: data.piq.map(p => p.id === ui.sel.id ? { ...p, loteAtualId: null, dataSaida: new Date().toISOString() } : p),
                  lot: data.lot.map(l => l.id === ui.sel.loteAtualId ? { ...l, status: 'livre', piqueteAtual: null } : l),
                  his: [...data.his, hist]
                });
                setUi({ ...ui, modal: null, sel: null, st: '‚úÖ Lote removido!' });
                setUi({ ...ui, modal: null, sel: null, st: '‚úÖ Lote removido com sucesso.' });
                setTimeout(() => setUi(u => ({ ...u, st: '' })), 3000);
              }
            }} className="w-full bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 font-semibold mb-2">
              Remover Lote
            </button>
            
            <div className="mb-2">
              <p className="text-sm font-semibold text-gray-700 mb-2">üîÑ Trocar gado:</p>
              {modulo && <p className="text-xs text-gray-600 mb-2">üìç Piquetes do {modulo.nome}:</p>}
              {modulo && piqsMesmoMod.length === 0 && <p className="text-sm text-gray-500 italic mb-2">Nenhum piquete vazio neste m√≥dulo</p>}
              {modulo && piqsMesmoMod.map(p => <button key={p.id} onClick={() => {
                const lote = lotF.find(l => l.id === ui.sel.loteAtualId);
                const hist = {
                  id: gid(),
                  fazendaId: data.fa,
                  tipo: 'troca',
                  loteId: ui.sel.loteAtualId,
                  piqueteId: p.id,
                  piqueteAnteriorId: ui.sel.id,
                  data: new Date().toISOString(),
                  descricao: `Lote ${lote?.nome} movido de ${ui.sel.nome} para ${p.nome}`
                };
                setData({
                  ...data,
                  piq: data.piq.map(pq => 
                    pq.id === ui.sel.id ? { ...pq, loteAtualId: null, dataSaida: new Date().toISOString() } :
                    pq.id === p.id ? { ...pq, loteAtualId: ui.sel.loteAtualId, dataEntrada: new Date().toISOString() } : pq
                  ),
                  lot: data.lot.map(l => l.id === ui.sel.loteAtualId ? { ...l, piqueteAtual: p.id } : l),
                  his: [...data.his, hist]
                });
                setUi({ ...ui, modal: null, sel: null, st: '‚úÖ Gado trocado!' });
                setUi({ ...ui, modal: null, sel: null, st: '‚úÖ Gado movido com sucesso.' });
                setTimeout(() => setUi(u => ({ ...u, st: '' })), 3000);
              }} className="w-full bg-blue-600 text-white px-3 py-2 rounded hover:bg-blue-700 text-sm mb-2 flex items-center justify-between">
                <span>{p.nome}</span>
                <span className="text-xs">{p.area}ha ‚ö™ {calcDias(p.dataSaida || p.dataCriacao)}d</span>
              </button>)}
              
              {piqsOutros.length > 0 && <>
                <button onClick={() => setUi({ ...ui, fd: { ...ui.fd, showOthers: !ui.fd.showOthers } })} className="w-full bg-gray-200 text-gray-700 px-3 py-2 rounded hover:bg-gray-300 text-sm mb-2 flex items-center justify-center gap-2">
                  {ui.fd.showOthers ? 'Ocultar outros m√≥dulos' : 'Ver outros m√≥dulos'}
                  {ui.fd.showOthers ? <ChevronUp size={16} /> : <ChevronDown size={16} />}
                </button>
                {ui.fd.showOthers && piqsOutros.map(p => {
                  const pMod = p.moduloId ? modF.find(m => m.id === p.moduloId) : null;
                  return <button key={p.id} onClick={() => {
                    const lote = lotF.find(l => l.id === ui.sel.loteAtualId);
                    const hist = {
                      id: gid(),
                      fazendaId: data.fa,
                      tipo: 'troca',
                      loteId: ui.sel.loteAtualId,
                      piqueteId: p.id,
                      piqueteAnteriorId: ui.sel.id,
                      data: new Date().toISOString(),
                      descricao: `Lote ${lote?.nome} movido de ${ui.sel.nome} para ${p.nome}${pMod ? ` (${pMod.nome})` : ''}`
                    };
                    setData({
                      ...data,
                      piq: data.piq.map(pq => 
                        pq.id === ui.sel.id ? { ...pq, loteAtualId: null, dataSaida: new Date().toISOString() } :
                        pq.id === p.id ? { ...pq, loteAtualId: ui.sel.loteAtualId, dataEntrada: new Date().toISOString() } : pq
                      ),
                      lot: data.lot.map(l => l.id === ui.sel.loteAtualId ? { ...l, piqueteAtual: p.id } : l),
                      his: [...data.his, hist]
                    });
                    setUi({ ...ui, modal: null, sel: null, st: '‚úÖ Gado trocado!' });
                    setUi({ ...ui, modal: null, sel: null, st: '‚úÖ Gado movido com sucesso.' });
                    setTimeout(() => setUi(u => ({ ...u, st: '' })), 3000);
                  }} className="w-full bg-blue-500 text-white px-3 py-2 rounded hover:bg-blue-600 text-sm mb-2 flex items-center justify-between">
                    <span>{p.nome} {pMod && `(${pMod.nome})`}</span>
                    <span className="text-xs">{p.area}ha</span>
                  </button>;
                })}
              </>}
            </div>
          </> : <>
            <p className="text-sm font-semibold text-gray-700 mb-2">üêÑ Alocar gado aqui:</p>
            {modulo && lotesMesmoMod.length > 0 && <>
              <p className="text-xs text-gray-600 mb-2">Lotes do {modulo.nome}:</p>
              {lotesMesmoMod.map(l => {
                const piqAtual = piqF.find(p => p.id === l.piqueteAtual);
                return <button key={l.id} onClick={() => {
                  const hist = {
                    id: gid(),
                    fazendaId: data.fa,
                    tipo: 'troca',
                    loteId: l.id,
                    piqueteId: ui.sel.id,
                    piqueteAnteriorId: l.piqueteAtual,
                    data: new Date().toISOString(),
                    descricao: `Lote ${l.nome} movido de ${piqAtual?.nome} para ${ui.sel.nome}`
                  };
                  setData({
                    ...data,
                    piq: data.piq.map(p => 
                      p.id === l.piqueteAtual ? { ...p, loteAtualId: null, dataSaida: new Date().toISOString() } :
                      p.id === ui.sel.id ? { ...p, loteAtualId: l.id, dataEntrada: new Date().toISOString() } : p
                    ),
                    lot: data.lot.map(lo => lo.id === l.id ? { ...lo, piqueteAtual: ui.sel.id } : lo),
                    his: [...data.his, hist]
                  });
                  setUi({ ...ui, modal: null, sel: null, st: '‚úÖ Gado alocado!' });
                  setUi({ ...ui, modal: null, sel: null, st: '‚úÖ Gado alocado com sucesso.' });
                  setTimeout(() => setUi(u => ({ ...u, st: '' })), 3000);
                }} className="w-full bg-green-600 text-white px-3 py-2 rounded hover:bg-green-700 text-sm mb-2 flex items-center justify-between">
                  <span>üêÑ {l.nome}</span>
                  <span className="text-xs">{l.quantidade} cab ‚Üí {piqAtual?.nome}</span>
                </button>;
              })}
            </>}
            
            {lotesLivres.length > 0 && <>
              <p className="text-xs text-gray-600 mb-2">Lotes livres:</p>
              {lotesLivres.map(l => <button key={l.id} onClick={() => {
                const hist = {
                  id: gid(),
                  fazendaId: data.fa,
                  tipo: 'entrada',
                  loteId: l.id,
                  piqueteId: ui.sel.id,
                  data: new Date().toISOString(),
                  descricao: `Lote ${l.nome} alocado em ${ui.sel.nome}`
                };
                setData({
                  ...data,
                  piq: data.piq.map(p => p.id === ui.sel.id ? { ...p, loteAtualId: l.id, dataEntrada: new Date().toISOString() } : p),
                  lot: data.lot.map(lo => lo.id === l.id ? { ...lo, status: 'alocado', piqueteAtual: ui.sel.id } : lo),
                  his: [...data.his, hist]
                });
                setUi({ ...ui, modal: null, sel: null, st: '‚úÖ Gado alocado!' });
                setUi({ ...ui, modal: null, sel: null, st: '‚úÖ Gado alocado com sucesso.' });
                setTimeout(() => setUi(u => ({ ...u, st: '' })), 3000);
              }} className="w-full bg-green-600 text-white px-3 py-2 rounded hover:bg-green-700 text-sm mb-2 flex items-center justify-between">
                <span>üêÑ {l.nome}</span>
                <span className="text-xs">{l.quantidade} cab | {l.totalUA} UA</span>
              </button>)}
            </>}
            
            {(lotesOutros.length > 0 || (modulo && lotesOutros.length > 0)) && <>
              <button onClick={() => setUi({ ...ui, fd: { ...ui.fd, showOthers: !ui.fd.showOthers } })} className="w-full bg-gray-200 text-gray-700 px-3 py-2 rounded hover:bg-gray-300 text-sm mb-2 flex items-center justify-center gap-2">
                {ui.fd.showOthers ? 'Ocultar outros m√≥dulos' : 'Trazer de outro m√≥dulo'}
                {ui.fd.showOthers ? <ChevronUp size={16} /> : <ChevronDown size={16} />}
              </button>
              {ui.fd.showOthers && lotesOutros.map(l => {
                const piqAtual = piqF.find(p => p.id === l.piqueteAtual);
                const pMod = piqAtual?.moduloId ? modF.find(m => m.id === piqAtual.moduloId) : null;
                return <button key={l.id} onClick={() => {
                  const hist = {
                    id: gid(),
                    fazendaId: data.fa,
                    tipo: 'troca',
                    loteId: l.id,
                    piqueteId: ui.sel.id,
                    piqueteAnteriorId: l.piqueteAtual,
                    data: new Date().toISOString(),
                    descricao: `Lote ${l.nome} movido de ${piqAtual?.nome}${pMod ? ` (${pMod.nome})` : ''} para ${ui.sel.nome}`
                  };
                  setData({
                    ...data,
                    piq: data.piq.map(p => 
                      p.id === l.piqueteAtual ? { ...p, loteAtualId: null, dataSaida: new Date().toISOString() } :
                      p.id === ui.sel.id ? { ...p, loteAtualId: l.id, dataEntrada: new Date().toISOString() } : p
                    ),
                    lot: data.lot.map(lo => lo.id === l.id ? { ...lo, piqueteAtual: ui.sel.id } : lo),
                    his: [...data.his, hist]
                  });
                  setUi({ ...ui, modal: null, sel: null, st: '‚úÖ Gado alocado!' });
                  setUi({ ...ui, modal: null, sel: null, st: '‚úÖ Gado alocado com sucesso.' });
                  setTimeout(() => setUi(u => ({ ...u, st: '' })), 3000);
                }} className="w-full bg-green-500 text-white px-3 py-2 rounded hover:bg-green-600 text-sm mb-2 flex items-center justify-between">
                  <span>üêÑ {l.nome} {pMod && `(${pMod.nome})`}</span>
                  <span className="text-xs">{l.quantidade} cab ‚Üí {piqAtual?.nome}</span>
                </button>;
              })}
            </>}
            
            {lotesMesmoMod.length === 0 && lotesLivres.length === 0 && lotesOutros.length === 0 && <p className="text-sm text-gray-500 italic">Nenhum lote dispon√≠vel</p>}
          </>}

        </div>
      </div>;
    })()}



    {ui.modal === 'lote-info' && ui.sel && (() => {
      const piqAtual = ui.sel.piqueteAtual ? piqF.find(p => p.id === ui.sel.piqueteAtual) : null;
      const modulo = piqAtual?.moduloId ? modF.find(m => m.id === piqAtual.moduloId) : null;
      const piqsMesmoMod = modulo ? piqF.filter(p => p.moduloId === modulo.id && !p.loteAtualId && p.id !== ui.sel.piqueteAtual && !p.ehReserva) : [];
      const piqsOutros = piqF.filter(p => (!modulo || p.moduloId !== modulo.id) && !p.loteAtualId && p.id !== ui.sel.piqueteAtual && !p.ehReserva);
      
      return <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div className="bg-white rounded-lg p-4 max-w-md w-full max-h-[90vh] overflow-y-auto">
@@ -1261,199 +1262,199 @@ function App() {
              <span className="text-gray-600">Status:</span>
              <span className={`font-bold ${ui.sel.status === 'livre' ? 'text-yellow-600' : 'text-green-600'}`}>
                {ui.sel.status === 'livre' ? 'üü° Livre' : '‚úÖ Alocado'}
              </span>
            </div>
          </div>

          {ui.sel.status === 'alocado' && ui.sel.piqueteAtual && <>
            <button onClick={() => {
              const piq = piqF.find(p => p.id === ui.sel.piqueteAtual);
              const hist = {
                id: gid(),
                fazendaId: data.fa,
                tipo: 'saida',
                loteId: ui.sel.id,
                piqueteId: ui.sel.piqueteAtual,
                data: new Date().toISOString(),
                descricao: `Lote ${ui.sel.nome} removido de ${piq?.nome}`
              };
              setData({
                ...data,
                piq: data.piq.map(p => p.id === ui.sel.piqueteAtual ? { ...p, loteAtualId: null, dataSaida: new Date().toISOString() } : p),
                lot: data.lot.map(l => l.id === ui.sel.id ? { ...l, status: 'livre', piqueteAtual: null } : l),
                his: [...data.his, hist]
              });
              setUi({ ...ui, modal: null, sel: null, st: '‚úÖ Lote removido do piquete!' });
              setUi({ ...ui, modal: null, sel: null, st: '‚úÖ Lote removido do piquete com sucesso.' });
              setTimeout(() => setUi(u => ({ ...u, st: '' })), 3000);
            }} className="w-full bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600 font-semibold mb-2 flex items-center justify-center gap-2">
              <ArrowRightLeft size={18} />
              Retirar do Piquete
            </button>

            <div className="mb-2">
              <p className="text-sm font-semibold text-gray-700 mb-2">üîÑ Trocar para outro piquete:</p>
              {modulo && <p className="text-xs text-gray-600 mb-2">üìç Piquetes do {modulo.nome}:</p>}
              {modulo && piqsMesmoMod.length === 0 && <p className="text-sm text-gray-500 italic mb-2">Nenhum piquete vazio neste m√≥dulo</p>}
              {modulo && piqsMesmoMod.map(p => <button key={p.id} onClick={() => {
                const piqAntigo = piqF.find(pq => pq.id === ui.sel.piqueteAtual);
                const hist = {
                  id: gid(),
                  fazendaId: data.fa,
                  tipo: 'troca',
                  loteId: ui.sel.id,
                  piqueteId: p.id,
                  piqueteAnteriorId: ui.sel.piqueteAtual,
                  data: new Date().toISOString(),
                  descricao: `Lote ${ui.sel.nome} movido de ${piqAntigo?.nome} para ${p.nome}`
                };
                setData({
                  ...data,
                  piq: data.piq.map(pq => 
                    pq.id === ui.sel.piqueteAtual ? { ...pq, loteAtualId: null, dataSaida: new Date().toISOString() } :
                    pq.id === p.id ? { ...pq, loteAtualId: ui.sel.id, dataEntrada: new Date().toISOString() } : pq
                  ),
                  lot: data.lot.map(l => l.id === ui.sel.id ? { ...l, piqueteAtual: p.id } : l),
                  his: [...data.his, hist]
                });
                setUi({ ...ui, modal: null, sel: null, st: '‚úÖ Gado trocado!' });
                setUi({ ...ui, modal: null, sel: null, st: '‚úÖ Gado movido com sucesso.' });
                setTimeout(() => setUi(u => ({ ...u, st: '' })), 3000);
              }} className="w-full bg-blue-600 text-white px-3 py-2 rounded hover:bg-blue-700 text-sm mb-2 flex items-center justify-between">
                <span>{p.nome}</span>
                <span className="text-xs">{p.area}ha ‚ö™ {calcDias(p.dataSaida || p.dataCriacao)}d</span>
              </button>)}
              
              {piqsOutros.length > 0 && <>
                <button onClick={() => setUi({ ...ui, fd: { ...ui.fd, showOthers: !ui.fd.showOthers } })} className="w-full bg-gray-200 text-gray-700 px-3 py-2 rounded hover:bg-gray-300 text-sm mb-2 flex items-center justify-center gap-2">
                  {ui.fd.showOthers ? 'Ocultar outros m√≥dulos' : 'Ver outros m√≥dulos'}
                  {ui.fd.showOthers ? <ChevronUp size={16} /> : <ChevronDown size={16} />}
                </button>
                {ui.fd.showOthers && piqsOutros.map(p => {
                  const pMod = p.moduloId ? modF.find(m => m.id === p.moduloId) : null;
                  return <button key={p.id} onClick={() => {
                    const piqAntigo = piqF.find(pq => pq.id === ui.sel.piqueteAtual);
                    const hist = {
                      id: gid(),
                      fazendaId: data.fa,
                      tipo: 'troca',
                      loteId: ui.sel.id,
                      piqueteId: p.id,
                      piqueteAnteriorId: ui.sel.piqueteAtual,
                      data: new Date().toISOString(),
                      descricao: `Lote ${ui.sel.nome} movido de ${piqAntigo?.nome} para ${p.nome}${pMod ? ` (${pMod.nome})` : ''}`
                    };
                    setData({
                      ...data,
                      piq: data.piq.map(pq => 
                        pq.id === ui.sel.piqueteAtual ? { ...pq, loteAtualId: null, dataSaida: new Date().toISOString() } :
                        pq.id === p.id ? { ...pq, loteAtualId: ui.sel.id, dataEntrada: new Date().toISOString() } : pq
                      ),
                      lot: data.lot.map(l => l.id === ui.sel.id ? { ...l, piqueteAtual: p.id } : l),
                      his: [...data.his, hist]
                    });
                    setUi({ ...ui, modal: null, sel: null, st: '‚úÖ Gado trocado!' });
                    setUi({ ...ui, modal: null, sel: null, st: '‚úÖ Gado movido com sucesso.' });
                    setTimeout(() => setUi(u => ({ ...u, st: '' })), 3000);
                  }} className="w-full bg-blue-500 text-white px-3 py-2 rounded hover:bg-blue-600 text-sm mb-2 flex items-center justify-between">
                    <span>{p.nome} {pMod && `(${pMod.nome})`}</span>
                    <span className="text-xs">{p.area}ha</span>
                  </button>;
                })}
              </>}
            </div>
          </>}

          {ui.sel.status === 'livre' && <div className="mb-2">
            <p className="text-sm font-semibold text-gray-700 mb-2">üêÑ Alocar em piquete:</p>
            {piqF.filter(p => !p.ehReserva && !p.loteAtualId).length === 0 ? <p className="text-sm text-gray-500 italic">Nenhum piquete dispon√≠vel</p> :
              piqF.filter(p => !p.ehReserva && !p.loteAtualId).map(p => {
                const pMod = p.moduloId ? modF.find(m => m.id === p.moduloId) : null;
                return <button key={p.id} onClick={() => {
                  const hist = {
                    id: gid(),
                    fazendaId: data.fa,
                    tipo: 'entrada',
                    loteId: ui.sel.id,
                    piqueteId: p.id,
                    data: new Date().toISOString(),
                    descricao: `Lote ${ui.sel.nome} alocado em ${p.nome}${pMod ? ` (${pMod.nome})` : ''}`
                  };
                  setData({
                    ...data,
                    piq: data.piq.map(pq => pq.id === p.id ? { ...pq, loteAtualId: ui.sel.id, dataEntrada: new Date().toISOString() } : pq),
                    lot: data.lot.map(l => l.id === ui.sel.id ? { ...l, status: 'alocado', piqueteAtual: p.id } : l),
                    his: [...data.his, hist]
                  });
                  setUi({ ...ui, modal: null, sel: null, st: '‚úÖ Lote alocado!' });
                  setUi({ ...ui, modal: null, sel: null, st: '‚úÖ Lote alocado com sucesso.' });
                  setTimeout(() => setUi(u => ({ ...u, st: '' })), 3000);
                }} className="w-full bg-green-600 text-white px-3 py-2 rounded hover:bg-green-700 text-sm mb-2 flex items-center justify-between">
                  <span>{p.nome} {pMod && `(${pMod.nome})`}</span>
                  <span className="text-xs">{p.area}ha</span>
                </button>;
              })}
          </div>}

          <button onClick={() => {
            const dataVenda = prompt('Data da venda (DD/MM/AAAA):');
            if (!dataVenda) return;
            if (ui.sel.status === 'alocado') {
              const piq = piqF.find(p => p.id === ui.sel.piqueteAtual);
              const hist = {
                id: gid(),
                fazendaId: data.fa,
                tipo: 'venda',
                loteId: ui.sel.id,
                piqueteId: ui.sel.piqueteAtual,
                data: new Date().toISOString(),
                descricao: `Lote ${ui.sel.nome} vendido (estava em ${piq?.nome}) - Data: ${dataVenda}`
              };
              setData({
                ...data,
                piq: data.piq.map(p => p.id === ui.sel.piqueteAtual ? { ...p, loteAtualId: null, dataSaida: new Date().toISOString() } : p),
                lot: data.lot.map(l => l.id === ui.sel.id ? { ...l, status: 'vendido', piqueteAtual: null, dataVenda } : l),
                his: [...data.his, hist]
              });
            } else {
              const hist = {
                id: gid(),
                fazendaId: data.fa,
                tipo: 'venda',
                loteId: ui.sel.id,
                data: new Date().toISOString(),
                descricao: `Lote ${ui.sel.nome} vendido - Data: ${dataVenda}`
              };
              setData({
                ...data,
                lot: data.lot.map(l => l.id === ui.sel.id ? { ...l, status: 'vendido', dataVenda } : l),
                his: [...data.his, hist]
              });
            }
            setUi({ ...ui, modal: null, sel: null, st: '‚úÖ Lote vendido!' });
            setUi({ ...ui, modal: null, sel: null, st: '‚úÖ Lote vendido com sucesso.' });
            setTimeout(() => setUi(u => ({ ...u, st: '' })), 3000);
          }} className="w-full bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 font-semibold mb-2 flex items-center justify-center gap-2">
            <DollarSign size={18} />
            Vender Lote
          </button>

          <button onClick={() => {
            if (ui.sel.status === 'alocado') {
              alert('Remova o lote do piquete antes de deletar');
              return;
            }
            if (confirm('Deletar este lote permanentemente?')) {
              setData({ ...data, lot: data.lot.filter(l => l.id !== ui.sel.id) });
              setUi({ ...ui, modal: null, sel: null, st: '‚úÖ Lote deletado!' });
              setUi({ ...ui, modal: null, sel: null, st: '‚úÖ Lote exclu√≠do com sucesso.' });
              setTimeout(() => setUi(u => ({ ...u, st: '' })), 3000);
            }
          }} className="w-full bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 font-semibold">
            Deletar Lote
          </button>
        </div>
      </div>;
    })()}

  </div>;
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
