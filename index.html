<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,user-scalable=yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Pasto Verde Pro</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <style>
    body { margin: 0; padding: 0; font-family: system-ui, -apple-system, sans-serif; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
const { useState, useEffect, useMemo, useRef } = React;

// --- √çCONES ---
const I = ({ size = 20, children }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">{children}</svg>;
const Upload = p => <I {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12" /></I>;
const Plus = p => <I {...p}><line x1="12" y1="5" x2="12" y2="19" /><line x1="5" y1="12" x2="19" y2="12" /></I>;
const Trash2 = p => <I {...p}><polyline points="3 6 5 6 21 6" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" /></I>;
const X = p => <I {...p}><line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" /></I>;
const MapPin = p => <I {...p}><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" /><circle cx="12" cy="10" r="3" /></I>;
const ZoomIn = p => <I {...p}><circle cx="11" cy="11" r="8" /><line x1="21" y1="21" x2="16.65" y2="16.65" /><line x1="11" y1="8" x2="11" y2="14" /><line x1="8" y1="11" x2="14" y2="11" /></I>;
const ZoomOut = p => <I {...p}><circle cx="11" cy="11" r="8" /><line x1="21" y1="21" x2="16.65" y2="16.65" /><line x1="8" y1="11" x2="14" y2="11" /></I>;
const Download = p => <I {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3" /></I>;
const Edit2 = p => <I {...p}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z" /></I>;
const Navigation = p => <I {...p}><polygon points="3 11 22 2 13 21 11 13 3 11" /></I>;
const Settings = p => <I {...p}><circle cx="12" cy="12" r="3" /><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" /></I>;

// --- UTILIT√ÅRIOS ---
const gid = () => `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
const calcArea = c => {
  if (!c || c.length < 3) return 0;
  let a = 0;
  const n = c.length, lm = c.reduce((s, v) => s + v[1], 0) / n, fl = Math.cos(lm * Math.PI / 180);
  for (let i = 0; i < n; i++) {
    const j = (i + 1) % n, xi = c[i][0] * fl * 111320, yi = c[i][1] * 110540, xj = c[j][0] * fl * 111320, yj = c[j][1] * 110540;
    a += xi * yj - xj * yi;
  }
  return (Math.abs(a) / 2 / 10000).toFixed(2);
};
const isReserva = nome => {
  const n = nome.toLowerCase();
  return n.includes('reserva') || n.includes('preserva') || n.includes('app') || n.includes('rl ') || n.includes('mata') || n.includes('floresta');
};

function App() {
  const [data, setData] = useState({ faz: [], fa: null, mod: [], piq: [], lot: [], his: [], mb: null });
  const [ui, setUi] = useState({ tab: 'dashboard', modal: null, sel: null, st: '', zm: 1, pn: { x: 0, y: 0 } });
  const [gps, setGps] = useState({ pos: null, status: 'buscando' });

  useEffect(() => {
    const s = localStorage.getItem('pastureSystem');
    if (s) { try { setData(JSON.parse(s)); } catch (e) { } }
  }, []);

  useEffect(() => {
    localStorage.setItem('pastureSystem', JSON.stringify(data));
  }, [data]);

  useEffect(() => {
    if (!navigator.geolocation) return;
    const id = navigator.geolocation.watchPosition(
      p => setGps({ pos: { lat: p.coords.latitude, lng: p.coords.longitude }, status: 'ativo' }),
      e => setGps(g => ({ ...g, status: 'erro' })),
      { enableHighAccuracy: true }
    );
    return () => navigator.geolocation.clearWatch(id);
  }, []);

  const handleKML = e => {
    const f = e.target.files[0];
    if (!f || !data.fa) return alert("Selecione uma fazenda primeiro.");
    const r = new FileReader();
    r.onload = ev => {
      try {
        const p = new DOMParser(), x = p.parseFromString(ev.target.result, 'text/xml');
        const pl = Array.from(x.getElementsByTagName('Placemark'));
        let minLat = 180, maxLat = -180, minLng = 180, maxLng = -180;
        const np = pl.map(pm => {
          const coStr = pm.getElementsByTagName('coordinates')[0]?.textContent.trim();
          if (!coStr) return null;
          const co = coStr.split(/\s+/).map(pr => {
            const [lng, lat] = pr.split(',').map(parseFloat);
            minLng = Math.min(minLng, lng); maxLng = Math.max(maxLng, lng);
            minLat = Math.min(minLat, lat); maxLat = Math.max(maxLat, lat);
            return [lng, lat];
          });
          const nm = pm.getElementsByTagName('name')[0]?.textContent || '√Årea';
          return { id: gid(), fazendaId: data.fa, nome: nm, area: calcArea(co), coordinates: co, ehReserva: isReserva(nm) };
        }).filter(p => p);
        setData({ ...data, piq: [...data.piq, ...np], mb: { minLat, maxLat, minLng, maxLng, width: maxLng-minLng, height: maxLat-minLat } });
        setUi({ ...ui, st: '‚úÖ KML Importado!' });
      } catch (err) { alert("Erro ao ler KML"); }
    };
    r.readAsText(f);
  };

  const proj = (lng, lat) => {
    if (!data.mb) return [0, 0];
    return [((lng - data.mb.minLng) / data.mb.width) * 900 + 50, ((data.mb.maxLat - lat) / data.mb.height) * 700 + 50];
  };

  const fazAt = data.faz.find(f => f.id === data.fa);
  const piqF = data.piq.filter(p => p.fazendaId === data.fa);

  return (
    <div className="min-h-screen bg-gray-50 flex flex-col">
      <header className="bg-green-700 text-white p-4 shadow-lg flex justify-between items-center">
        <h1 className="text-xl font-bold">Pasto Verde Pro</h1>
        {fazAt && <div className="text-sm bg-green-800 px-3 py-1 rounded">üìç {fazAt.nome}</div>}
      </header>

      <nav className="bg-white border-b flex overflow-x-auto no-scrollbar">
        {['dashboard', 'mapa', 'piquetes', 'modulos', 'lotes', 'historico', 'config'].map(t => (
          <button key={t} onClick={() => setTab(t)} onClick={() => setUi({...ui, tab: t})} className={`px-6 py-4 text-xs font-bold uppercase tracking-widest whitespace-nowrap ${ui.tab === t ? 'border-b-4 border-green-600 text-green-700' : 'text-gray-400'}`}>
            {t}
          </button>
        ))}
      </nav>

      <main className="flex-1 p-4 max-w-7xl mx-auto w-full">
        {!data.fa && ui.tab !== 'config' ? (
          <div className="bg-white p-8 rounded-xl shadow text-center">
            <h2 className="text-lg font-bold">Bem-vindo</h2>
            <p className="text-gray-500 mb-4">Selecione ou crie uma fazenda nas Configura√ß√µes.</p>
          </div>
        ) : (
          <>
            {ui.tab === 'dashboard' && (
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 text-center">
                <div className="bg-white p-6 rounded-xl shadow border-l-4 border-green-500">
                  <h3 className="text-gray-400 text-[10px] font-bold uppercase">√Årea Total</h3>
                  <p className="text-2xl font-black">{piqF.reduce((s,p)=>s+parseFloat(p.area),0).toFixed(2)} ha</p>
                </div>
                <div className="bg-white p-6 rounded-xl shadow border-l-4 border-blue-500">
                  <h3 className="text-gray-400 text-[10px] font-bold uppercase">Piquetes</h3>
                  <p className="text-2xl font-black">{piqF.length}</p>
                </div>
              </div>
            )}

            {ui.tab === 'mapa' && (
              <div className="space-y-4">
                <div className="flex gap-2">
                  <label className="bg-green-600 text-white px-4 py-2 rounded text-xs font-bold cursor-pointer">
                    IMPORTAR KML <input type="file" onChange={handleKML} className="hidden" />
                  </label>
                  <button onClick={() => setUi({...ui, zm: ui.zm + 0.2})} className="bg-white border p-2 rounded shadow-sm"><ZoomIn size={16}/></button>
                  <button onClick={() => setUi({...ui, zm: Math.max(0.2, ui.zm - 0.2)})} className="bg-white border p-2 rounded shadow-sm"><ZoomOut size={16}/></button>
                </div>
                <div className="bg-white rounded-xl shadow-inner border h-[500px] overflow-hidden relative">
                  <svg viewBox="0 0 1000 800" className="w-full h-full bg-slate-50">
                    <g transform={`translate(${ui.pn.x},${ui.pn.y}) scale(${ui.zm})`}>
                      {piqF.map(p => (
                        <path key={p.id} d={p.coordinates.map((c, i) => `${i===0?'M':'L'} ${proj(c[0], c[1]).join(' ')}`).join(' ') + ' Z'} 
                              fill={p.ehReserva ? '#dcfce7' : '#f1f5f9'} stroke="#475569" strokeWidth="1" />
                      ))}
                      {gps.pos && <circle cx={proj(gps.pos.lng, gps.pos.lat)[0]} cy={proj(gps.pos.lng, gps.pos.lat)[1]} r="10" fill="#3b82f6" stroke="white" strokeWidth="2" />}
                    </g>
                  </svg>
                </div>
              </div>
            )}

            {ui.tab === 'piquetes' && (
              <div className="bg-white rounded-xl shadow overflow-hidden">
                <table className="w-full text-left text-sm">
                  <thead className="bg-gray-50 font-bold border-b">
                    <tr><th className="p-4">Nome</th><th className="p-4">√Årea</th><th className="p-4">Tipo</th></tr>
                  </thead>
                  <tbody className="divide-y">
                    {piqF.map(p => (
                      <tr key={p.id}><td className="p-4 font-bold">{p.nome}</td><td className="p-4">{p.area} ha</td><td className="p-4 text-xs uppercase">{p.ehReserva ? 'Reserva' : 'Pasto'}</td></tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )}

            {ui.tab === 'modulos' && (
              <div className="bg-white p-6 rounded-xl shadow">
                <h3 className="font-bold mb-4 uppercase text-sm">M√≥dulos de Manejo</h3>
                <p className="text-gray-400 text-sm italic tracking-wide">Nenhum m√≥dulo cadastrado.</p>
              </div>
            )}

            {ui.tab === 'lotes' && (
              <div className="bg-white p-6 rounded-xl shadow">
                <h3 className="font-bold mb-4 uppercase text-sm">Lotes de Animais</h3>
                <p className="text-gray-400 text-sm italic tracking-wide">Nenhum lote ativo nesta fazenda.</p>
              </div>
            )}

            {ui.tab === 'historico' && (
              <div className="bg-white p-6 rounded-xl shadow">
                <h3 className="font-bold mb-4 uppercase text-sm tracking-widest">Hist√≥rico</h3>
                <p className="text-gray-400 text-sm italic">Nenhuma movimenta√ß√£o registrada.</p>
              </div>
            )}

            {ui.tab === 'config' && (
              <div className="grid gap-6">
                <div className="bg-white p-6 rounded-xl shadow border">
                  <h3 className="font-bold mb-4 uppercase text-xs">Gest√£o de Fazendas</h3>
                  <button onClick={() => {
                    const n = prompt("Nome da Fazenda:");
                    if(n) { const id = gid(); setData({...data, faz:[...data.faz, {id, nome:n}], fa:id}); }
                  }} className="bg-green-600 text-white px-4 py-2 rounded text-sm font-bold shadow-sm">+ ADICIONAR FAZENDA</button>
                  <div className="mt-4 space-y-2">
                    {data.faz.map(f => (
                      <div key={f.id} onClick={() => setData({...data, fa:f.id})} className={`p-4 border rounded-lg cursor-pointer transition-all ${data.fa === f.id ? 'border-green-600 bg-green-50 ring-1 ring-green-600' : 'hover:bg-gray-50'}`}>
                        <span className="font-bold text-sm">{f.nome}</span>
                      </div>
                    ))}
                  </div>
                </div>
                <div className="bg-red-50 p-6 rounded-xl border border-red-200">
                  <h3 className="text-red-800 font-bold mb-2 uppercase text-[10px]">Zona de Perigo</h3>
                  <button onClick={() => { if(confirm("Apagar todos os dados permanentemente?")) { localStorage.clear(); location.reload(); }}} 
                          className="bg-red-600 text-white px-4 py-2 rounded text-xs font-bold uppercase shadow-sm">Resetar Todo o Sistema</button>
                </div>
              </div>
            )}
          </>
        )}
      </main>
    </div>
  );
}

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);
  </script>
</body>
</html>
