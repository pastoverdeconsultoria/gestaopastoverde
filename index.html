<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>Pasto Verde Pro</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    body { background-color: #f8fafc; font-family: sans-serif; }
    .nav-blur { backdrop-filter: blur(10px); background: rgba(255,255,255,0.9); }
    .map-container { height: 60vh; position: relative; overflow: hidden; background: #e2e8f0; border-radius: 2rem; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;

    // √çcones
    const Layout = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 21V9"/></svg>;
    const MapIcon = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"/><path d="M8 2v16M16 6v16"/></svg>;
    const ListIcon = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>;

    // Fun√ß√µes Geogr√°ficas Reais (Sua l√≥gica v2.9)
    const gid = () => Math.random().toString(36).substr(2, 9);
    
    const calcArea = (c) => {
      if (!c || c.length < 3) return 0;
      let a = 0;
      const n = c.length, lm = c.reduce((s, v) => s + v[1], 0) / n, fl = Math.cos(lm * Math.PI / 180);
      for (let i = 0; i < n; i++) {
        const j = (i + 1) % n;
        const xi = c[i][0] * fl * 111320, yi = c[i][1] * 110540;
        const xj = c[j][0] * fl * 111320, yj = c[j][1] * 110540;
        a += xi * yj - xj * yi;
      }
      return (Math.abs(a) / 2 / 10000).toFixed(2);
    };

    const pointInPolygon = (p, vs) => {
      let inside = false;
      for (let i = 0, j = vs.length - 1; i < vs.length; j = i++) {
        const xi = vs[i][0], yi = vs[i][1], xj = vs[j][0], yj = vs[j][1];
        if ((yi > p[1]) !== (yj > p[1]) && (p[0] < (xj - xi) * (p[1] - yi) / (yj - yi) + xi)) inside = !inside;
      }
      return inside;
    };

    function App() {
      const [data, setData] = useState({ faz: [], fa: null, piq: [], mb: null });
      const [tab, setTab] = useState('mapa');
      const [gps, setGps] = useState(null);
      const [view, setView] = useState({ zoom: 1, x: 0, y: 0 });

      useEffect(() => {
        const s = localStorage.getItem('pverde_pro');
        if (s) setData(JSON.parse(s));
      }, []);

      useEffect(() => {
        localStorage.setItem('pverde_pro', JSON.stringify(data));
      }, [data]);

      useEffect(() => {
        const id = navigator.geolocation.watchPosition(
          p => setGps({ lat: p.coords.latitude, lng: p.coords.longitude }),
          null, { enableHighAccuracy: true }
        );
        return () => navigator.geolocation.clearWatch(id);
      }, []);

      // Identificar piquete atual pelo GPS
      const piqOcupadoPeloUsuario = useMemo(() => {
        if (!gps || !data.piq.length) return null;
        return data.piq.find(p => pointInPolygon([gps.lng, gps.lat], p.coords));
      }, [gps, data.piq]);

      const handleKML = (e) => {
        const file = e.target.files[0];
        if (!file || !data.fa) return alert("Crie ou selecione uma fazenda.");
        const reader = new FileReader();
        reader.onload = (ev) => {
          const parser = new DOMParser();
          const kml = parser.parseFromString(ev.target.result, "text/xml");
          const placemarks = Array.from(kml.getElementsByTagName("Placemark"));
          
          let minLat = 180, maxLat = -180, minLng = 180, maxLng = -180;
          const newPiq = placemarks.map(pm => {
            const name = pm.getElementsByTagName("name")[0]?.textContent || "√Årea";
            const coStr = pm.getElementsByTagName("coordinates")[0]?.textContent.trim();
            if (!coStr) return null;
            const coords = coStr.split(/\s+/).map(c => {
              const [lng, lat] = c.split(',').map(parseFloat);
              minLng = Math.min(minLng, lng); maxLng = Math.max(maxLng, lng);
              minLat = Math.min(minLat, lat); maxLat = Math.max(maxLat, lat);
              return [lng, lat];
            });
            return { id: gid(), nome: name, area: calcArea(coords), coords };
          }).filter(p => p);

          setData({ ...data, piq: newPiq, mb: { minLat, maxLat, minLng, maxLng, width: maxLng - minLng, height: maxLat - minLat } });
        };
        reader.readAsText(file);
      };

      const proj = (lng, lat) => {
        if (!data.mb) return [0, 0];
        const padding = 50;
        const x = ((lng - data.mb.minLng) / data.mb.width) * (800 - padding * 2) + padding;
        const y = ((data.mb.maxLat - lat) / data.mb.height) * (600 - padding * 2) + padding;
        return [x, y];
      };

      const fazAt = data.faz.find(f => f.id === data.fa);

      return (
        <div className="flex flex-col h-screen overflow-hidden">
          {/* Header */}
          <header className="bg-white px-6 py-4 flex justify-between items-center border-b">
            <div>
              <h1 className="text-green-800 font-black text-lg">PASTO VERDE PRO</h1>
              {piqOcupadoPeloUsuario && (
                <p className="text-blue-600 text-[10px] font-bold animate-pulse">üìç VOC√ä EST√Å EM: {piqOcupadoPeloUsuario.nome.toUpperCase()}</p>
              )}
            </div>
            {!data.fa ? (
              <button onClick={() => {
                const n = prompt("Nome da Fazenda:");
                if(n) { const id = gid(); setData({...data, faz:[{id, nome:n}], fa:id}); }
              }} className="bg-green-600 text-white text-xs font-bold px-4 py-2 rounded-full">+ NOVA</button>
            ) : <span className="text-gray-400 text-xs font-bold">{fazAt?.nome}</span>}
          </header>

          <main className="flex-1 overflow-y-auto p-4 pb-24">
            {tab === 'mapa' && (
              <div className="space-y-4">
                <div className="flex justify-between items-center">
                  <label className="text-xs font-bold text-green-700 bg-green-50 px-3 py-2 rounded-lg cursor-pointer">
                    üìÅ IMPORTAR KML
                    <input type="file" onChange={handleKML} className="hidden" />
                  </label>
                  <div className="flex gap-2">
                    <button onClick={() => setView(v => ({...v, zoom: v.zoom + 0.2}))} className="bg-white shadow w-8 h-8 rounded-full font-bold">+</button>
                    <button onClick={() => setView(v => ({...v, zoom: Math.max(0.5, v.zoom - 0.2)}))} className="bg-white shadow w-8 h-8 rounded-full font-bold">-</button>
                  </div>
                </div>

                <div className="map-container border shadow-inner">
                  <svg viewBox="0 0 800 600" className="w-full h-full">
                    <g transform={`scale(${view.zoom}) translate(${view.x}, ${view.y})`}>
                      {data.piq.map(p => (
                        <path key={p.id} 
                          d={p.coords.map((c, i) => `${i===0?'M':'L'} ${proj(c[0], c[1]).join(' ')}`).join(' ') + ' Z'}
                          fill={piqOcupadoPeloUsuario?.id === p.id ? "#dbeafe" : "#f1f5f9"}
                          stroke={piqOcupadoPeloUsuario?.id === p.id ? "#3b82f6" : "#22c55e"}
                          strokeWidth={piqOcupadoPeloUsuario?.id === p.id ? "3" : "1"}
                        />
                      ))}
                      {gps && <circle cx={proj(gps.lng, gps.lat)[0]} cy={proj(gps.lng, gps.lat)[1]} r="8" fill="#3b82f6" stroke="white" strokeWidth="3" />}
                    </g>
                  </svg>
                </div>
              </div>
            )}

            {tab === 'areas' && (
              <div className="space-y-2">
                {data.piq.map(p => (
                  <div key={p.id} className={`p-4 rounded-2xl border flex justify-between items-center ${piqOcupadoPeloUsuario?.id === p.id ? 'bg-blue-50 border-blue-200' : 'bg-white'}`}>
                    <div>
                      <p className="font-bold text-gray-800">{p.nome}</p>
                      <p className="text-xs text-gray-400">{p.area} ha</p>
                    </div>
                    {piqOcupadoPeloUsuario?.id === p.id && <span className="bg-blue-600 text-white text-[8px] px-2 py-1 rounded-full font-black">VOC√ä EST√Å AQUI</span>}
                  </div>
                ))}
              </div>
            )}
          </main>

          <nav className="fixed bottom-0 left-0 right-0 bg-white border-t flex justify-around py-4 shadow-lg nav-blur">
            <button onClick={() => setTab('mapa')} className={`flex flex-col items-center ${tab === 'mapa' ? 'text-green-600' : 'text-gray-400'}`}>
              <MapIcon /> <span className="text-[10px] font-bold mt-1">MAPA</span>
            </button>
            <button onClick={() => setTab('areas')} className={`flex flex-col items-center ${tab === 'areas' ? 'text-green-600' : 'text-gray-400'}`}>
              <ListIcon /> <span className="text-[10px] font-bold mt-1">LISTA</span>
            </button>
          </nav>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
