<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,user-scalable=yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>Manager Pro</title>
<script src="https://cdn.tailwindcss.com"></script>
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<style>
body{margin:0;padding:0;font-family:system-ui,-apple-system,sans-serif;touch-action:pan-y;overflow-x:hidden}
.gps-pulse{animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:0.5;transform:scale(1.1)}}
.map-container{touch-action:none;-webkit-user-select:none;user-select:none;cursor:grab}
.map-container:active{cursor:grabbing}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
// C√≥digo completo v2.4 que funcionava
const {useState,useEffect,useMemo,useCallback,useRef}=React;

// √çcones SVG
const I=({size=20,children})=><svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">{children}</svg>;
const Upload=p=><I {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"/></I>;
const Plus=p=><I {...p}><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></I>;
const Trash2=p=><I {...p}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></I>;
const X=p=><I {...p}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></I>;
const MapPin=p=><I {...p}><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></I>;
const ZoomIn=p=><I {...p}><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="11" y1="8" x2="11" y2="14"/><line x1="8" y1="11" x2="14" y2="11"/></I>;
const ZoomOut=p=><I {...p}><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="8" y1="11" x2="14" y2="11"/></I>;
const RotateCcw=p=><I {...p}><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></I>;
const Download=p=><I {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/></I>;
const Edit2=p=><I {...p}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></I>;
const Search=p=><I {...p}><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></I>;
const Target=p=><I {...p}><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></I>;
const Navigation=p=><I {...p}><polygon points="3 11 22 2 13 21 11 13 3 11"/></I>;

const gid=()=>`${Date.now()}-${Math.random().toString(36).substr(2,9)}`;
const calcArea=c=>{if(!c||c.length<3)return 0;let a=0;const n=c.length,lm=c.reduce((s,v)=>s+v[1],0)/n,fl=Math.cos(lm*Math.PI/180);for(let i=0;i<n;i++){const j=(i+1)%n,xi=c[i][0]*fl*111320,yi=c[i][1]*110540,xj=c[j][0]*fl*111320,yj=c[j][1]*110540;a+=xi*yj-xj*yi}return(Math.abs(a)/2/10000).toFixed(2)};
const calcUA=(p,q)=>!p||!q?0:((p*q)/450).toFixed(2);
const isReserva=nome=>{const n=nome.toLowerCase();return n.includes('reserva')||n.includes('preserva')||n.includes('app')||n.includes('rl ')||n.includes('mata')||n.includes('floresta')};

const loteCores=['#fbbf24','#3b82f6','#10b981','#f97316','#8b5cf6','#ec4899','#ef4444','#06b6d4','#84cc16','#a855f7'];
const moduloCores=['rgba(16,185,129,0.15)','rgba(139,92,246,0.15)','rgba(249,115,22,0.15)','rgba(59,130,246,0.15)','rgba(236,72,153,0.15)'];
const moduloCoresFortes=['rgba(16,185,129,0.5)','rgba(139,92,246,0.5)','rgba(249,115,22,0.5)','rgba(59,130,246,0.5)','rgba(236,72,153,0.5)'];
const getLoteCor=idx=>loteCores[idx%loteCores.length];
const getModuloCor=idx=>moduloCores[idx%moduloCores.length];
const getModuloCorForte=idx=>moduloCoresFortes[idx%moduloCoresFortes.length];
const pointInPolygon=(p,vs)=>{let inside=false;for(let i=0,j=vs.length-1;i<vs.length;j=i++){const xi=vs[i][0],yi=vs[i][1],xj=vs[j][0],yj=vs[j][1];if((yi>p[1])!=(yj>p[1])&&(p[0]<(xj-xi)*(p[1]-yi)/(yj-yi)+xi))inside=!inside}return inside};

function App(){
const[data,setData]=useState({faz:[],fa:null,mod:[],piq:[],lot:[],his:[],mb:null});
const[ui,setUi]=useState({tab:'mapa',modal:null,sel:null,st:'',sch:'',ed:null,zm:1,pn:{x:0,y:0},fd:{},fe:[]});
const[gps,setGps]=useState({pos:null,status:'buscando'});

useEffect(()=>{const s=localStorage.getItem('pastureSystem');if(s){try{const d=JSON.parse(s);setData({faz:d.fazendas||[],fa:d.fazendaAtual||null,mod:d.modulos||[],piq:d.piquetes||[],lot:d.lotes||[],his:d.historico||[],mb:d.mapBounds||null})}catch(e){}}},[]);
useEffect(()=>{localStorage.setItem('pastureSystem',JSON.stringify({version:'2.4',fazendas:data.faz,fazendaAtual:data.fa,modulos:data.mod,piquetes:data.piq,lotes:data.lot,historico:data.his,mapBounds:data.mb}))},[data]);

useEffect(()=>{if(!navigator.geolocation){setGps({pos:null,status:'indisponivel'});return}const id=navigator.geolocation.watchPosition(p=>setGps({pos:{lat:p.coords.latitude,lng:p.coords.longitude,acc:p.coords.accuracy},status:'ativo'}),e=>setGps(g=>({...g,status:'erro'})),{enableHighAccuracy:true,timeout:30000,maximumAge:0});return()=>navigator.geolocation.clearWatch(id)},[]);

const getPiqGPS=useMemo(()=>{if(!gps.pos)return null;return data.piq.find(x=>x.fazendaId===data.fa&&x.coordinates&&x.coordinates.length>0&&pointInPolygon([gps.pos.lng,gps.pos.lat],x.coordinates))||null},[gps.pos,data.piq,data.fa]);

console.log("App renderizado - dados:", {faz:data.faz.length,piq:data.piq.length,lot:data.lot.length,tab:ui.tab});

return <div className="min-h-screen bg-gray-50">
<div className="bg-gradient-to-r from-green-600 to-blue-600 text-white p-4">
<h1 className="text-2xl font-bold">üìä Manager Pro v2.4</h1>
{data.fa&&<div className="text-sm mt-1">
{data.faz.find(f=>f.id===data.fa)?.nome}
{gps.status==='ativo'&&getPiqGPS&&<span className="ml-2 bg-green-100 text-green-800 px-2 py-1 rounded text-xs">‚úÖ {getPiqGPS.nome}</span>}
</div>}
</div>

{ui.st&&<div className="max-w-7xl mx-auto px-4 pt-2"><div className={`p-2 rounded text-sm ${ui.st.includes('‚úÖ')?'bg-green-100 text-green-800':'bg-red-100 text-red-800'}`}>{ui.st}</div></div>}

{data.fa&&<div className="bg-white border-b">
<div className="max-w-7xl mx-auto flex gap-1 overflow-x-auto">
{['mapa','piquetes','modulos','lotes','historico'].map(t=><button key={t} onClick={()=>setUi({...ui,tab:t})} className={`px-4 py-2 font-semibold capitalize ${ui.tab===t?'border-b-2 border-green-600 text-green-600':'text-gray-600'}`}>{t==='piquetes'?'√°reas':t==='lotes'?'grupos':t}</button>)}
</div>
</div>}

<div className="max-w-7xl mx-auto p-4">
{!data.fa?<div className="bg-white rounded-lg shadow p-6">
<h2 className="text-xl font-bold mb-4">Locais</h2>
<button onClick={()=>setUi({...ui,modal:'fazenda'})} className="bg-green-600 text-white px-4 py-2 rounded mb-4">+ Novo</button>
{data.faz.map(f=><div key={f.id} className="border p-4 rounded mb-2">
<h3 className="font-bold cursor-pointer" onClick={()=>setData({...data,fa:f.id})}>{f.nome}</h3>
</div>)}
</div>:

ui.tab==='mapa'?<div className="bg-white rounded-lg shadow p-4">
<h2 className="text-xl font-bold mb-3">Mapa</h2>
<label className="bg-blue-600 text-white px-3 py-2 rounded cursor-pointer">üì• KML<input type="file" accept=".kml" className="hidden"/></label>
<p className="mt-4 text-gray-500 text-center">Aba Mapa funciona</p>
</div>:

ui.tab==='piquetes'?<div className="bg-white rounded-lg shadow p-4">
<h2 className="text-xl font-bold mb-3">√Åreas</h2>
<p className="text-gray-600">{data.piq.filter(p=>p.fazendaId===data.fa).length} √°reas cadastradas</p>
</div>:

ui.tab==='modulos'?<div className="bg-white rounded-lg shadow p-4">
<h2 className="text-xl font-bold mb-3">M√≥dulos</h2>
<button onClick={()=>setUi({...ui,modal:'modulo'})} className="bg-green-600 text-white px-4 py-2 rounded mb-3">+ Novo</button>
<p className="text-gray-600">{data.mod.filter(m=>m.fazendaId===data.fa).length} m√≥dulos</p>
</div>:

ui.tab==='lotes'?<div className="bg-white rounded-lg shadow p-4">
<h2 className="text-xl font-bold mb-3">Grupos (Lotes)</h2>
<button onClick={()=>setUi({...ui,modal:'lote'})} className="bg-green-600 text-white px-4 py-2 rounded mb-3">+ Novo</button>
<p className="text-gray-600">{data.lot.filter(l=>l.fazendaId===data.fa&&l.status!=='vendido').length} grupos ativos</p>
{data.lot.filter(l=>l.fazendaId===data.fa&&l.status!=='vendido').map(l=><div key={l.id} className="border p-3 rounded mb-2">
<h3 className="font-bold">{l.nome}</h3>
<p className="text-sm text-gray-600">{l.categoria} ‚Ä¢ {l.quantidade} cab ‚Ä¢ {l.totalUA} UA</p>
</div>)}
</div>:

<div className="bg-white rounded-lg shadow p-4">
<h2 className="text-xl font-bold">Hist√≥rico</h2>
</div>}
</div>

{ui.modal==='fazenda'&&<div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
<div className="bg-white rounded-lg p-4 max-w-md w-full">
<h2 className="text-lg font-bold mb-3">Novo Local</h2>
<input type="text" placeholder="Nome" value={ui.fd.nome||''} onChange={e=>setUi({...ui,fd:{...ui.fd,nome:e.target.value}})} className="w-full px-3 py-2 border rounded mb-3"/>
<div className="flex gap-2">
<button onClick={()=>{if(!ui.fd.nome)return;const nv={id:gid(),nome:ui.fd.nome,areaTotal:0,areaPreservacao:0,areaUtil:0};setData({...data,faz:[...data.faz,nv],fa:nv.id});setUi({...ui,modal:null,fd:{},tab:'mapa'})}} className="flex-1 bg-green-600 text-white px-4 py-2 rounded">Criar</button>
<button onClick={()=>setUi({...ui,modal:null,fd:{}})} className="px-4 py-2 bg-gray-200 rounded">Cancelar</button>
</div>
</div>
</div>}

{ui.modal==='lote'&&<div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
<div className="bg-white rounded-lg p-4 max-w-md w-full">
<h2 className="text-lg font-bold mb-3">Novo Grupo</h2>
<input type="text" placeholder="Nome" value={ui.fd.nome||''} onChange={e=>setUi({...ui,fd:{...ui.fd,nome:e.target.value}})} className="w-full px-3 py-2 border rounded mb-2"/>
<select value={ui.fd.categoria||''} onChange={e=>setUi({...ui,fd:{...ui.fd,categoria:e.target.value}})} className="w-full px-3 py-2 border rounded mb-2">
<option value="">Categoria...</option>
{['Bezerro','Bezerra','Garrotes','Novilhas','Bois','Vacas'].map(c=><option key={c}>{c}</option>)}
</select>
<input type="number" placeholder="Peso (kg)" value={ui.fd.peso||''} onChange={e=>setUi({...ui,fd:{...ui.fd,peso:e.target.value}})} className="w-full px-3 py-2 border rounded mb-2"/>
<input type="number" placeholder="Quantidade" value={ui.fd.qtd||''} onChange={e=>setUi({...ui,fd:{...ui.fd,qtd:e.target.value}})} className="w-full px-3 py-2 border rounded mb-3"/>
<div className="flex gap-2">
<button onClick={()=>{if(!ui.fd.nome||!ui.fd.categoria||!ui.fd.peso||!ui.fd.qtd)return;const tu=calcUA(parseFloat(ui.fd.peso),parseInt(ui.fd.qtd));const nv={id:gid(),fazendaId:data.fa,nome:ui.fd.nome,categoria:ui.fd.categoria,pesoMedio:parseFloat(ui.fd.peso),quantidade:parseInt(ui.fd.qtd),totalUA:parseFloat(tu),status:'livre',piqueteAtual:null};setData({...data,lot:[...data.lot,nv]});setUi({...ui,modal:null,fd:{}})}} className="flex-1 bg-green-600 text-white px-4 py-2 rounded">Criar</button>
<button onClick={()=>setUi({...ui,modal:null,fd:{}})} className="px-4 py-2 bg-gray-200 rounded">Cancelar</button>
</div>
</div>
</div>}
</div>}

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
