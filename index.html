<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,user-scalable=yes">
  <title>Pasto Verde Pro</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <style>
    body { margin: 0; padding: 0; font-family: system-ui, -apple-system, sans-serif; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
const { useState, useEffect, useMemo, useRef } = React;

// --- √çCONES (Sua v2.9) ---
const I = ({ size = 20, children }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">{children}</svg>;
const Upload = p => <I {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12" /></I>;
const Plus = p => <I {...p}><line x1="12" y1="5" x2="12" y2="19" /><line x1="5" y1="12" x2="19" y2="12" /></I>;
const MapPin = p => <I {...p}><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" /><circle cx="12" cy="10" r="3" /></I>;
const ZoomIn = p => <I {...p}><circle cx="11" cy="11" r="8" /><line x1="21" y1="21" x2="16.65" y2="16.65" /><line x1="11" y1="8" x2="11" y2="14" /><line x1="8" y1="11" x2="14" y2="11" /></I>;
const ZoomOut = p => <I {...p}><circle cx="11" cy="11" r="8" /><line x1="21" y1="21" x2="16.65" y2="16.65" /><line x1="8" y1="11" x2="14" y2="11" /></I>;

// --- L√ìGICA DE C√ÅLCULO ORIGINAL ---
const gid = () => `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
const calcArea = c => {
  if (!c || c.length < 3) return 0;
  let a = 0;
  const n = c.length, lm = c.reduce((s, v) => s + v[1], 0) / n, fl = Math.cos(lm * Math.PI / 180);
  for (let i = 0; i < n; i++) {
    const j = (i + 1) % n, xi = c[i][0] * fl * 111320, yi = c[i][1] * 110540, xj = c[j][0] * fl * 111320, yj = c[j][1] * 110540;
    a += xi * yj - xj * yi;
  }
  return (Math.abs(a) / 2 / 10000).toFixed(2);
};

function App() {
  const [data, setData] = useState({ faz: [], fa: null, mod: [], piq: [], lot: [], mb: null });
  const [ui, setUi] = useState({ tab: 'mapa', zm: 1, pn: { x: 0, y: 0 } });
  const [gps, setGps] = useState({ pos: null });

  useEffect(() => {
    const s = localStorage.getItem('pastureSystem');
    if (s) try { setData(JSON.parse(s)); } catch (e) {}
  }, []);

  useEffect(() => {
    localStorage.setItem('pastureSystem', JSON.stringify(data));
  }, [data]);

  useEffect(() => {
    const id = navigator.geolocation.watchPosition(
      p => setGps({ pos: { lat: p.coords.latitude, lng: p.coords.longitude } }),
      null, { enableHighAccuracy: true }
    );
    return () => navigator.geolocation.clearWatch(id);
  }, []);

  const handleKML = e => {
    const f = e.target.files[0];
    if (!f || !data.fa) return alert('Crie uma fazenda primeiro.');
    const r = new FileReader();
    r.onload = ev => {
      const p = new DOMParser(), x = p.parseFromString(ev.target.result, 'text/xml');
      const pl = Array.from(x.getElementsByTagName('Placemark'));
      let minLat = 180, maxLat = -180, minLng = 180, maxLng = -180;
      const np = pl.map(pm => {
        const coStr = pm.getElementsByTagName('coordinates')[0]?.textContent.trim();
        if (!coStr) return null;
        const co = coStr.split(/\s+/).map(pr => {
          const [lng, lat] = pr.split(',').map(parseFloat);
          minLng = Math.min(minLng, lng); maxLng = Math.max(maxLng, lng);
          minLat = Math.min(minLat, lat); maxLat = Math.max(maxLat, lat);
          return [lng, lat];
        });
        return { id: gid(), fazendaId: data.fa, nome: pm.getElementsByTagName('name')[0]?.textContent || '√Årea', area: calcArea(co), coordinates: co };
      }).filter(p => p);
      setData({ ...data, piq: [...data.piq, ...np], mb: { minLat, maxLat, minLng, maxLng, width: maxLng-minLng, height: maxLat-minLat } });
    };
    r.readAsText(f);
  };

  const proj = (lng, lat) => {
    if (!data.mb) return [0, 0];
    return [((lng - data.mb.minLng) / data.mb.width) * 900 + 50, ((data.mb.maxLat - lat) / data.mb.height) * 700 + 50];
  };

  const fazAt = data.faz.find(f => f.id === data.fa);

  return (
    <div className="min-h-screen bg-gray-100 text-gray-900">
      {/* HEADER ORIGINAL */}
      <div className="bg-green-700 text-white p-4 shadow-md">
        <div className="max-w-7xl mx-auto flex justify-between items-center">
          <h1 className="text-xl font-bold">PASTO VERDE PRO</h1>
          {fazAt && <span className="bg-green-800 px-3 py-1 rounded text-sm">{fazAt.nome}</span>}
        </div>
      </div>

      {!data.fa ? (
        <div className="p-10 text-center">
          <button onClick={() => {
            const n = prompt("Nome da Fazenda:");
            if(n) { const id = gid(); setData({...data, faz:[{id, nome:n}], fa:id}); }
          }} className="bg-green-600 text-white px-6 py-3 rounded-lg font-bold">Adicionar Fazenda</button>
        </div>
      ) : (
        <>
          <div className="bg-white border-b flex overflow-x-auto no-scrollbar">
            {['dashboard', 'mapa', 'piquetes', 'lotes'].map(t => (
              <button key={t} onClick={() => setUi({...ui, tab: t})} className={`px-6 py-3 font-bold uppercase text-xs tracking-widest ${ui.tab === t ? 'border-b-4 border-green-600 text-green-700' : 'text-gray-400'}`}>
                {t}
              </button>
            ))}
          </div>

          <div className="p-4">
            {ui.tab === 'mapa' && (
              <div className="space-y-4">
                <div className="flex gap-2">
                  <label className="bg-white border px-4 py-2 rounded shadow-sm text-sm cursor-pointer">
                    üìÅ Importar KML
                    <input type="file" onChange={handleKML} className="hidden" />
                  </label>
                </div>
                <div className="bg-white rounded-lg shadow-inner border overflow-hidden relative">
                  <svg viewBox="0 0 1000 800" className="w-full h-[500px]">
                    <g transform={`translate(${ui.pn.x},${ui.pn.y}) scale(${ui.ui?.zm || 1})`}>
                      {data.piq.map(p => (
                        <path key={p.id} d={p.coordinates.map((c, i) => `${i===0?'M':'L'} ${proj(c[0], c[1]).join(' ')}`).join(' ') + ' Z'} fill="#dcfce7" stroke="#166534" strokeWidth="1" />
                      ))}
                      {gps.pos && <circle cx={proj(gps.pos.lng, gps.pos.lat)[0]} cy={proj(gps.pos.lng, gps.pos.lat)[1]} r="8" fill="#3b82f6" stroke="white" strokeWidth="2" />}
                    </g>
                  </svg>
                </div>
              </div>
            )}
            
            {ui.tab === 'piquetes' && (
              <div className="grid gap-2">
                {data.piq.map(p => (
                  <div key={p.id} className="bg-white p-4 rounded shadow-sm flex justify-between">
                    <span className="font-bold">{p.nome}</span>
                    <span className="text-gray-500">{p.area} ha</span>
                  </div>
                ))}
              </div>
            )}
          </div>
        </>
      )}
    </div>
  );
}

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);
  </script>
</body>
</html>
